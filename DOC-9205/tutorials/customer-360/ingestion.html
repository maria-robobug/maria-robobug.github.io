<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Customer 360 Data Ingestion | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/DOC-9205/tutorials/customer-360/ingestion.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="tutorials">
<meta name="dcterms.identifier" content="master">
<meta name="page-url" content="/tutorials/customer-360/ingestion.html">
<meta name="generator" content="Antora 3.0.0-alpha.5">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/DOC-9205/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/DOC-9205/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../index.html">
                      Tutorials
                      <span class="arrow">
                        <i class="fas fa-arrow-right"></i>
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a href="https://cloud.couchbase.com/sign-up" class="free-trial-link" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  <i class="fas fa-cloud"></i>
                  Free Trial
                </a>
                <a class="btn btn-primary try-btn"  onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
<div class="components">
  <div class="components_group-title">
    <a href="../index.html">Tutorials</a>
  </div>
  <ul class="components_list">
    <li class="components_list-items">
      <div class="component_list-version">
        <span class="component_list_title">Tutorials</span>
      </div>
      <div class="version_items hide" data-version="master">
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Get Started with Couchbase Cloud Self-Service Trials</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbc-self-service-trials/index.html">Overview</a>
  </span>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <a class="menu_title menu_link" href="../cbc-self-service-trials/getting-started.html">Get Started with Your Trial Cluster</a>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbc-azure-cloud/azure-cloud-connection-prerequisites.html">Azure Cloud Connection Prerequisites</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbc-self-service-trials/using-sdks-with-couchbase-cloud.html">Using SDKs with Couchbase Cloud</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbc-self-service-trials/analytics-bi-with-couchbase-cloud.html">Analytics and BI with Couchbase Cloud</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../cbc-self-service-trials/eventing-with-couchbase-cloud.html">Eventing with Couchbase Cloud</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#cloud::index.adoc">Go to Couchbase Cloud Documentation</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Get Started with Couchbase Community Edition</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/index.html">Overview</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/install-manage/tutorial_en.html">Install and Manage</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/import-data/tutorial_en.html">Import existing data</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/query-search/tutorial_en.html">Queries and Search</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/setup-cluster/tutorial_en.html">Set up a cluster</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/dev-nodejs/tutorial_en.html">Development with Node.js</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/dev-java/tutorial_en.html">Development with Java</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../getting-started-ce/mobile-android/tutorial_en.html">Couchbase Mobile on Android</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Couchbase Server</span>
  </span>
<ul class="menu_row">
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Session Storage</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../session-storage/install.html">Configure Couchbase Cluster</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../session-storage/aspnet.html">ASP.NET Core</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../session-storage/java.html">Java</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../session-storage/udf.html">UDF</a>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="1">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">User Profile Storage</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../profile-store/install.html">Configure Couchbase Cluster</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../profile-store/java.html">Java</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../profile-store/dotnet.html">.Net</a>
  </span>
</li>
<li class="menu_list" data-depth="2">
  <span class="menu_line">
    <a class="menu_title menu_link" href="../profile-store/building-indexes.html">Indexing</a>
  </span>
</li>
</ul>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Couchbase Mobile</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">Travel Sample
Unresolved include directive in modules/ROOT/nav.adoc - include::mobile-travel-sample:partial$nav.adoc[]</span>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#standalone@userprofile-couchbase-mobile:userprofile:userprofile_basic.adoc">Getting Started on iOS</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#standalone@userprofile-couchbase-mobile:userprofile:xamarin/userprofile_basic.adoc">Getting Started on Xamarin</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#standalone@userprofile-couchbase-mobile:userprofile:android/userprofile_basic.adoc">Getting Started on Android</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <a class="menu_title menu_link" href="#tutorials:swift-playground:overview.adoc">Xcode Playground</a>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">Recycler Views with Live Queries
Unresolved include directive in modules/ROOT/nav.adoc - include::university-lister:partial$nav.adoc[]</span>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">Build a Cordova Plugin
Unresolved include directive in modules/ROOT/nav.adoc - include::hotel-lister:partial$nav.adoc[]</span>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">Build a React Native Module
Unresolved include directive in modules/ROOT/nav.adoc - include::hotel-finder:partial$nav.adoc[]</span>
  </span>
</li>
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">OpenID Connect Tutorial
Unresolved include directive in modules/ROOT/nav.adoc - include::openid-connect-implicit-flow:partial$nav.adoc[]</span>
  </span>
</li>
</ul>
</li>
<li class="menu_list is-parent closed" data-depth="0">
  <span class="menu_line">
    <span class="in-toggle"></span>
    <span class="menu_title menu_text">Build Your Own</span>
  </span>
<ul class="menu_row">
<li class="menu_list" data-depth="1">
  <span class="menu_line">
    <span class="menu_title menu_text">Tutorial Template
Unresolved include directive in modules/ROOT/nav.adoc - include::tutorial-template:partial$nav.adoc[]</span>
  </span>
</li>
</ul>
</li>
</ul>
      </div>
    </li>
  </ul>
</div>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/tutorials-contrib//modules/customer-360/pages/ingestion.adoc" title="Edit Page" target="_blank" rel="noopener">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../index.html">Tutorials</a></li>
<li class="crumb"><a href="ingestion.html">Customer 360 Data Ingestion</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Customer 360 Data Ingestion</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial contains 7 main sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#customer-360-introduction">Customer 360 Introduction</a>: What does it mean? What is the use case?</p>
</li>
<li>
<p><a href="#data-ingestion-overview">Data Ingestion Overview</a>: How and why are we ingesting data?</p>
</li>
<li>
<p><a href="#data-ingestion-example-with-kafka">Data Ingestion example with Kafka</a>: Using Kafka and Kafka Connect to setup a real-time data pipeline</p>
</li>
<li>
<p><a href="#data-ingestion-example-with-csv">Data Ingestion example with CSV</a>: Creating a (nightly) job to import data from a CSV file</p>
</li>
<li>
<p><a href="#data-ingestion-with-http-rest-api-polling">Data Ingestion with HTTP REST API polling</a>: Planning to use CURL/HTTP to ingest data</p>
</li>
<li>
<p><a href="#data-integration-with-couchbase-eventing-functions">Data Integration with Couchbase Eventing Functions</a>: putting all the pieces together</p>
</li>
<li>
<p><a href="#summary">Summary</a> and next steps: Once you have the data ingested, where do you go from there?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Prerequisities</strong>: this is a tutorial about a data ingestion architecture. It is not necessarily a step-by-step guide on creating everything from start to finish. There are so many variables to take into account, that it would be impossible to cover all of them. But, generally speaking, the prerequisites are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An enterprise with multiple data-backed systems.</p>
</li>
<li>
<p>Some way for data to be copied/piped/streamed from those systems (this tutorial covers Kafka, CSV, and HTTP, but there are a myriad of other ways to move data around).</p>
</li>
<li>
<p>A Couchbase Server cluster with (at least) one node that has the <a href="https://docs.couchbase.com/server/current/eventing/eventing-overview.html">Eventing service</a> enabled.</p>
</li>
<li>
<p>Optional: Docker. If you plan on building an entire "toy" environment and following this tutorial exactly, Docker will help you. However, Docker is not necessary to the most crucial parts of this tutorial.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="customer-360-introduction"><a class="anchor" href="#customer-360-introduction"></a>Customer 360 Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of a <a href="https://www.couchbase.com/solutions/customer-360">Customer 360 system</a> is to deliver a single, consistent view of all your data in one platform within an enterprise where that data is split up between many different systems. This tutorial will be focusing mainly on getting a complete view of a customer/person.</p>
</div>
<div class="sect2">
<h3 id="retail-as-an-example"><a class="anchor" href="#retail-as-an-example"></a>Retail as an example</h3>
<div class="paragraph">
<p>Let&#8217;s assume our enterprise is a retail organization. Within this organization, there can be many separate components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Home Delivery - a system dedicated to received delivery orders from a customer and making sure they get delivered to their homes.</p>
</li>
<li>
<p>Loyalty Program - a system dedicated to tracking and rewarding your most loyal customers with incentives.</p>
</li>
<li>
<p>Online Store - a system which allows the users to place orders from their browser/phone/etc. A customer cam pick them up, have them shipped, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many more systems, especially as your retail organization grows. Perhaps another system is acquired via acquisition, another is created by a successful hackathon project, and perhaps there are even 3rd party systems that are business critical. Some of these systems <strong>may</strong> even communicate with each other.</p>
</div>
</div>
<div class="sect2">
<h3 id="what-do-the-parts-have-in-common"><a class="anchor" href="#what-do-the-parts-have-in-common"></a>What do the parts have in common?</h3>
<div class="paragraph">
<p>But what these systems all have in common is that they are separated in some way, and typically have their own data store.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/00201-enterprise.png" alt="Diagram of the enterprise in current state"></span></p>
</div>
<div class="paragraph">
<p>In this example, the home delivery system is backed by a MySQL database, the loyalty system is backed by Postgres, and we&#8217;re not even sure what the online store is backed by.</p>
</div>
<div class="paragraph">
<p>What we do know is that an individual may interact with any of these systems. That is, a person might only use the home delivery system, they might only use the online store, or they might use 2 or 3 them.</p>
</div>
<div class="paragraph">
<p>From the person&#8217;s external point of view, they are all part of the same business. From an internal technology point of view, they are all separate parts. BUT, to best serve a customer and/or gather insights about our customers on the whole, we&#8217;d have to piece together data from these 3+ systems.</p>
</div>
<div class="paragraph">
<p>This is where Customer 360 comes in. We&#8217;ll build a system to get as many pieces of the whole customer as we can, and put them together into one system.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-ingestion-overview"><a class="anchor" href="#data-ingestion-overview"></a>Data Ingestion Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first step with data ingestion is to answer the question: "how can we get the data?" The answer to this question is going to vary wildly. But for purposes of this tutorial, let&#8217;s assume that we&#8217;ve researched each system and discovered the most optimal method currently available:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/00202-getting-data.png" alt="Getting data out"></span></p>
</div>
<div class="paragraph">
<p>In this diagram, we&#8217;ve made the following determinations about the most optimal way to get data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Home Delivery</strong>: We&#8217;re in luck! The Home Delivery team has agreed to (or already has) connected their MySQL database as a "source" to Kafka via Kafka Connect. We can setup Couchbase as a Kafka "sink" and start ingesting data in real time.</p>
</li>
<li>
<p><strong>Loyalty System</strong>: The situation is less ideal here, but the Loyalty System team has agreed to (or previously has) created a nightly job that exports all of their customer data to a CSV file. This means that the loyalty data could be as old as 24 hours, but it&#8217;s a start!</p>
</li>
<li>
<p><strong>Online Store</strong>: Making things more tricky, the only way to access data externally in this system is via a REST API. We can ask for a data about one customer at a time. So instead of data coming to our Customer 360 system, our Custoemr 360 system has to poll for the data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many other ways that data can flow or be accessed, but this tutorial is going to focus on these three. <em>In an ideal world, we could use a single method (like Kafka) to move data from all systems through the enterprise, but few enterprises exist in such a world.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-ingestion-example-with-kafka"><a class="anchor" href="#data-ingestion-example-with-kafka"></a>Data Ingestion example with Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Home Delivery team is using a MySQL database. We want to get customer data from that system into a Couchbase "staging" bucket. A simple view of this architecture will look like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/00203-kafka-mysql.png" alt="MySQL to Couchbase Kafka data pipeline"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s break down each of these parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MySQL</strong>. This is a popular relational database. In the Home Delivery system, there may be many <em>tables</em> containing data. Our Customer 360 system is only interested (for now) in the data that&#8217;s in a <em>customer</em> table. The Home Delivery system will make updates and inserts to this table on a regular basis as part of day-to-day business.</p>
</li>
<li>
<p><strong>Kafka</strong>. <a href="http://kafka.apache.org/">Kafka</a> is a streaming platform. It&#8217;s similar to a queue: <em>sources</em> put messages into a topic, and <em>sinks</em> read the messages from those topics. Kafka has a distributed architecture, meaning that it can be scaled up as necessary.</p>
</li>
<li>
<p><strong>Kafka Connect</strong>. <a href="https://docs.confluent.io/current/connect/index.html">Kafka Connect</a> is a framework for connecting <em>data sources</em> and <em>data sinks</em> to Kafka. There are many Kafka Connect plugins available, including <a href="https://debezium.io/">Debezium for MySQL</a> and a <a href="https://docs.couchbase.com/kafka-connector/current/quickstart.html">Couchbase Kafka Connector</a>.</p>
</li>
<li>
<p><strong>Couchbase</strong>. This is the data platform that will hold all the Customer 360 data. To start with, we&#8217;ll just put data into a <em>bucket</em> called <em>staging</em>. Later, we&#8217;ll integrate this data into a <em>customer360</em> bucket. Couchbase, like Kafka, has a distributed architecture, which provides excellent scaling capabilities.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For this tutorial, I used some basic Docker commands to get all the pieces working. In your enterprise, you may or may not be using some combinatino of containers, VMs, Kubernetes, bare metal, cloud services, etc. This tutorial will not go into all those details.</p>
</div>
<div class="paragraph">
<p>In your organization, you may already have Kafka running. If so, skip to <a href="#mysql-to-kafka-connect">MySQL to Kafka Connect</a>. If you already have MySQL and Kafka Connect talking, you can skip to <a href="#kafka-connect-to-couchbase">Kafka Connect to Couchbase</a>.</p>
</div>
<div class="sect2">
<h3 id="installing-couchbase"><a class="anchor" href="#installing-couchbase"></a>Installing Couchbase</h3>
<div class="paragraph">
<p>There are multiple ways to install Couchbase. I&#8217;m using basic Docker commands in this tutorial to keep it simple. However, for a more robust deployment, you may want to take a look at the <a href="https://docs.couchbase.com/operator/current/overview.html">Couchbase Kubernetes Autonomous Operator</a>.</p>
</div>
<div class="paragraph">
<p>I executed the following Docker command to start Couchbase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker run -d --name db -m 4gb -p 8091-8096:8091-8096 -p 9140:9140 -p 11210:11210 --link kafka:kafka couchbase:enterprise-6.0.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once it was installed, I went through the <a href="https://docs.couchbase.com/server/current/manage/manage-nodes/create-cluster.html">normal setup process</a> (make sure that Eventing is selected) and created a bucket called <em>staging</em>. You will also need two other buckets later, so you may as well create them now: <em>customer360</em> and <em>customer360_metadata</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka"><a class="anchor" href="#kafka"></a>Kafka</h3>
<div class="paragraph">
<p>For this tutorial, I relied heavily on Kafka and Debezium documentation. Debezium has published a <a href="https://debezium.io/docs/tutorial/">quick start tutorial</a> on setting up Kafka and Kafka connect (including Zookeeper). It&#8217;s a great tutorial, and since I&#8217;ll be using Debezium&#8217;s MySQL connector anyway, it&#8217;s a great place to start.</p>
</div>
<div class="paragraph">
<p>To get started with Kafka, I ran Docker images like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker run -it --rm --name zookeeper -p 2181:2181 -p 2888:2888 -p 3888:3888 debezium/zookeeper:0.9

docker run -it --rm --name kafka -p 9092:9092 --link zookeeper:zookeeper debezium/kafka:0.9</code></pre>
</div>
</div>
<div class="paragraph">
<p>Zookeeper is required for Kafka, so I executed that first. After that started, I ran the Kafka image. In your enterprise, I&#8217;m assuming that a MySQL database already exists, but if you want to create one just to follow along with this tutorial, you can use a Debezium provided MySQL database that already contains sample data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker run -it --rm --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=debezium -e MYSQL_USER=mysqluser -e MYSQL_PASSWORD=mysqlpw debezium/example-mysql:0.9</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, you have Kafka (+Zookeeper) and MySQL running.</p>
</div>
</div>
<div class="sect2">
<h3 id="mysql-to-kafka-connect"><a class="anchor" href="#mysql-to-kafka-connect"></a>MySQL to Kafka Connect</h3>
<div class="paragraph">
<p>For this tutorial, we&#8217;ll be relying on the <a href="https://debezium.io/docs/connectors/mysql/">Debezium MySQL connector</a>. There are other options for using MySQL with Kafka Connect. I have chosen Debezium because of how easy it was for me to get started with it, but depending on your situation, you may want to <a href="https://www.confluent.io/hub/">check out other connectors</a>.</p>
</div>
<div class="paragraph">
<p>Getting started with the Debezium MySQL connector is as easy as running another Docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker run -it --rm --name connect -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses --link zookeeper:zookeeper --link kafka:kafka --link mysql:mysql debezium/connect:0.9</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>However, before you do that, I would recommend reading the next step about using the Couchbase Kafka Connector.</strong></p>
</div>
<div class="paragraph">
<p>Once the above Connect image is running, you can configure and start the connector with a single call to Kafka Connect&#8217;s REST API. Specifically, you can make a call like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">POST http://localhost:8083/connectors/

{
  "name": "inventory-connector",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "tasks.max": "1",
    "database.hostname": "mysql",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "dbz",
    "database.server.id": "184054",
    "database.server.name": "dbserver1",
    "database.whitelist": "inventory",
    "database.history.kafka.bootstrap.servers": "kafka:9092",
    "database.history.kafka.topic": "schema-changes.inventory"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take special note of <code>database.server.name</code> and <code>database.whitelist</code>. After you POST this (see <a href="https://docs.confluent.io/current/connect/references/restapi.html#post&#8212;&#8203;connectors">more about the Kafka Connect REST API here</a>), data will immediately start flowing from MySQL into Kafka.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-connect-to-couchbase"><a class="anchor" href="#kafka-connect-to-couchbase"></a>Kafka Connect to Couchbase</h3>
<div class="paragraph">
<p>At this point, data is flowing into Kafka whenever it&#8217;s added or updated in MySQL. The last step is to get Couchbase to listen to this flow of data and ingest it into the <em>staging</em> bucket.</p>
</div>
<div class="paragraph">
<p>Couchbase has created and supports a <a href="https://docs.couchbase.com/kafka-connector/current/quickstart.html">Kafka Connector</a>. Be sure to read that documentation and quick start guide. For this tutorial, we&#8217;re going to put the Couchbase Kafka Connector inside the same image as used in the above step.</p>
</div>
<div class="sect3">
<h4 id="custom-docker-image"><a class="anchor" href="#custom-docker-image"></a>Custom Docker Image</h4>
<div class="paragraph">
<p>Once again, Docker is not a prerequisite for using Couchbase Kafka Connect (or anything in this tutorial). But for convenience sake, I created a customer Docker image that has both the MySQL connector and the Couchbase connector in it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Dockerfile hljs" data-lang="Dockerfile">Unresolved include directive in modules/customer-360/pages/ingestion.adoc - include::../examples/docker-connect-couchbase/Dockerfile[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build this custom docker image on your machine, start by downloading the <a href="https://docs.couchbase.com/kafka-connector/current/quickstart.html#download">kafka-connect-couchbase-X.X.X.jar</a> file and placing in the same directory as the above Dockerfile. Then execute this Docker command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker build . --tag couchbasedebezium</code></pre>
</div>
</div>
<div class="paragraph">
<p>(I used <code>couchbasedebezium</code> but you&#8217;re free to name it whatever you&#8217;d like).</p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-custom-connect-image"><a class="anchor" href="#running-the-custom-connect-image"></a>Running the Custom Connect Image</h4>
<div class="paragraph">
<p>Once that custom image is created, execute it like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">docker run -it --rm --name connect -p 8083:8083 -e GROUP_ID=1 -e CONFIG_STORAGE_TOPIC=my_connect_configs -e OFFSET_STORAGE_TOPIC=my_connect_offsets -e STATUS_STORAGE_TOPIC=my_connect_statuses --link zookeeper:zookeeper --link kafka:kafka --link mysql:mysql --link db:db couchbasedebezium</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this is identical to running the debezium image as in the last section, except for two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It&#8217;s linking to db (which is where I&#8217;m running Couchbase)</p>
</li>
<li>
<p>It&#8217;s running my <code>couchbasedebezium</code> image</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="starting-the-connectors"><a class="anchor" href="#starting-the-connectors"></a>Starting the Connector(s)</h4>
<div class="paragraph">
<p>When this image starts, you can again make REST requests to start data flowing. To start the Couchbase connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">POST http://localhost:8083/connectors/

{
  "name": "home-delivery-sink",
  "config": {
    "connector.class": "com.couchbase.connect.kafka.CouchbaseSinkConnector",
    "tasks.max": "2",
	"topics" : "dbserver1.inventory.customers",
	"connection.cluster_address" : "db",
	"connection.timeout.ms" : "2000",
	"connection.bucket" : "staging",
	"connection.username" : "Administrator",
	"connection.password" : "password",
	"couchbase.durability.persist_to" : "NONE",
	"couchbase.durability.replicate_to" : "NONE",
	"key.converter" : "org.apache.kafka.connect.storage.StringConverter",
	"value.converter" : "org.apache.kafka.connect.json.JsonConverter",
	"value.converter.schemas.enable" : "false"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration is largely pulled from the <a href="https://docs.couchbase.com/kafka-connector/3.4/quickstart.html">Couchbase Quickstart</a>. Instead of being a text file for the command line, it’s an HTTP POST. Take special note of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connector.class</code> – This is the connector class that lives in the JAR file</p>
</li>
<li>
<p><code>topics</code> – The topics that Couchbase will sink from.</p>
</li>
<li>
<p><code>connection.cluster_address</code> – When I started Couchbase in Docker, I gave it a name of "db"</p>
</li>
<li>
<p><code>connection.bucket, connection.username, connection.password</code> – These are all settings I created when setting up Couchbase.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this point, data should be flowing into your Couchbase staging bucket, and it will look similar to this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/00204-staging-delivery.png" alt="Home Delivery data flowing into Couchbase"></span></p>
</div>
<div class="paragraph">
<p>Those documents contain a lot of information about the data flow. Some of which you might need, some of which you can ignore. But for now, the data is being ingested, and will continue to be ingested in real time as changes are made to the data in MySQL.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-ingestion-example-with-csv"><a class="anchor" href="#data-ingestion-example-with-csv"></a>Data Ingestion example with CSV</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next part of the enterprise to ingest data from is the Loyalty Program system. Since it&#8217;s using Postgres, we could absolutely follow a similar procedure as was done with Kafka in the previous section. However, that&#8217;s not always possible. Perhaps the Loyalty Program team doesn&#8217;t want the database to connect to Kafka, perhaps they are interested in scrubbing their data first, etc.</p>
</div>
<div class="paragraph">
<p>There could be any number of reasons, but the end result is that all we have to go on is a nightly CSV export of all the customer data. Well, that&#8217;s okay, because we have a few options for ingesting data from a CSV file into the <em>staging</em> bucket in Couchbase.</p>
</div>
<div class="sect2">
<h3 id="using-cbimport"><a class="anchor" href="#using-cbimport"></a>Using cbimport</h3>
<div class="paragraph">
<p>The first option is a tool that comes with Couchbase called <a href="https://docs.couchbase.com/server/current/tools/cbimport.html">cbimport</a>. This command line utility is able to import data from <a href="https://docs.couchbase.com/server/current/tools/cbimport-csv.html">CSV</a> (as well as JSON).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-PowerShell hljs" data-lang="PowerShell">cbimport csv -c couchbase://127.0.0.1 -u Administrator -p password \
 -b staging -d file:///data/loyalty_members.csv -g key::#MONO_INCR# -t 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>That command will import every record from loyalty_members.csv into the <em>staging</em> bucket.</p>
</div>
<div class="paragraph">
<p>To run this nightly, you could set up a <a href="https://en.wikipedia.org/wiki/Cron">cron</a> job (or similar) to run shortly after new CSV files appear. You could schedule it or trigger it to run when a new CSV is found. This requires cbimport to have read access to the CSV file, and it requires some understanding of scripting.</p>
</div>
<div class="paragraph">
<p>Using <strong>cbimport</strong> is the simplest approach. It is a powerful, flexible tool that will work for you in many situations.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-a-couchbase-sdk"><a class="anchor" href="#using-a-couchbase-sdk"></a>Using a Couchbase SDK</h3>
<div class="paragraph">
<p>If scripting/cron/cbimport can&#8217;t accomplish what you want, you can take the approach of writing your own CSV import tool. You can write a program using any of the <a href="https://docs.couchbase.com/server/6.0/sdk/overview.html">Couchbase Server SDKs</a>, including C, .NET, Go, Java, Node, PHP, Python, or Scala (and there are other community supported options).</p>
</div>
<div class="paragraph">
<p>For this tutorial, I created a small program using <a href="https://docs.couchbase.com/dotnet-sdk/current/start-using-sdk.html">.NET</a> and the <a href="https://joshclose.github.io/CsvHelper/">CsvHelper</a> library.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-C# hljs" data-lang="C#">public async Task ImportCsv()
{
    var csvFilePath = GetNewestCsvPath();
    if (csvFilePath == null)
        return;

    // check to make sure it's newer than the file that was imported last time
    // if not, then bail out
    if (!ThisFileIsNewerThanTheLastImport(csvFilePath))
    {
        _logger.LogInformation($"Not importing {csvFilePath}");
        return;
    }

    // start importing from CSV into Couchbase
    using (var reader = new StreamReader(csvFilePath))
    {
        using (var csv = new CsvReader(reader))
        {
            var records = csv.GetRecords&lt;dynamic&gt;();

            var documents = new List&lt;IDocument&lt;dynamic&gt;&gt;();
            foreach (var record in records)
            {
                var document = new Document&lt;dynamic&gt;
                {
                    Id = $"loyalty-member-{record.Id}",
                    Content = record,
                    Expiry = 90000
                };
                documents.Add(document);
            }

            // consider breaking this up into multiple batches
            await _bucket.InsertAsync(documents);
        }
    }

    TrackImportComplete(csvFilePath);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very straightforward approach: it loops through every CSV record, reads it into a C# object, and then sends it to Couchbase. It&#8217;s using C#'s async/await functionality as well as the .NET SDK&#8217;s batch insert capabilities. This code will also keep track of which CSV files have already been imported, so that no redundant importing happens. It also makes use of a logging library, just in case something goes wrong.</p>
</div>
</div>
<div class="sect2">
<h3 id="time-to-live"><a class="anchor" href="#time-to-live"></a>Time-to-live</h3>
<div class="paragraph">
<p>It&#8217;s also worth pointing out that this CSV import code is setting an <code>Expiry</code> of 90000 on each document. Since this is a nightly task, and <strong>all</strong> of the customers will be exported every day, it&#8217;s important to clean up the old staging data. By setting an Expiry, Couchbase will automatically remove these temporary documents in staging after a certain period of time. <a href="https://docs.couchbase.com/dotnet-sdk/2.7/core-operations.html#expiry">Couchbase SDKs can set this Expiry (also know as time-to-live or TTL)</a> on a per document basis. You can also choose to set a TTL at the bucket level.</p>
</div>
<div class="paragraph">
<p>Since the <em>staging</em> bucket is meant to be a place for the initial ingestion of data to appear, but NOT a place for data to be stored long term, using TTL here will save you the headache of having to clean up data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-ingestion-with-http-rest-api-polling"><a class="anchor" href="#data-ingestion-with-http-rest-api-polling"></a>Data Ingestion with HTTP REST API polling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, we have one more system to ingest data from. In the previous two examples, we set up data pipelines that <strong>push</strong> the data from their respective systems <strong>to</strong> Couchbase. The data comes to us.</p>
</div>
<div class="paragraph">
<p>For this next system, the only way to get data out of it is through a REST HTTP API. Additionally, we have to get data out of it piecemeal. That is, it won&#8217;t simply be one request to ingest all the data at once. We can only make requests for one person at a time.</p>
</div>
<div class="paragraph">
<p>For this tutorial, I&#8217;ve constructed a "mock" REST API with the following endpoints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">GET ​/api​/onlineStore​/getCustomerDetailsByEmail
GET ​/api​/onlineStore​/getOrdersByCustomerId
GET ​/api​/onlineStore​/getProductDetailsByProductId</code></pre>
</div>
</div>
<div class="paragraph">
<p>In reality, a REST API will have a much larger suite of endpoints, including POST, DELETE, PUT, etc, as well as a variety of difference resources. But for the purposes of this tutorial, these three endpoints are all we have available that allow us to retrieve data from the Online Store system.</p>
</div>
<div class="sect2">
<h3 id="getcustomerdetailsbyemail-endpoint"><a class="anchor" href="#getcustomerdetailsbyemail-endpoint"></a>getCustomerDetailsByEmail endpoint</h3>
<div class="paragraph">
<p>This endpoint expects an email address to identify the customer you want to get details about. It returns some information about the customer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">GET /api/onlineStore/getCustomerDetailsByEmail?customerEmail=gia_kutch%40oconnell.biz

{
  "Id": 1,
  "Name": "Matt Groves",
  "Email": "matthew.groves@couchbase.com",
  "Password": "edzchzmatv5"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s not much here about the customer, but it&#8217;s certainly worth ingesting to start with.</p>
</div>
</div>
<div class="sect2">
<h3 id="getordersbycustomerid"><a class="anchor" href="#getordersbycustomerid"></a>getOrdersByCustomerId</h3>
<div class="paragraph">
<p>This endpoint expects a customer ID (which can be obtained using the previous endpoint). It returns information about all the orders this customer has made:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">GET /api/onlineStore/getOrdersByCustomerId?customerId=1

[
  {
    "OrderId": 1,
    "PurchaseDate": "2019-04-25T15:15:5800838522",
    "CustomerId": 1,
    "Items": [
      { "OrderId": 1, "ProductId": 200, "Quantity": 2, "Price": 87.81 },
      { "OrderId": 1, "ProductId": 400, "Quantity": 4, "Price": 129.86 },
      { "OrderId": 1, "ProductId": 410, "Quantity": 1, "Price": 78.64 },
      { "OrderId": 1, "ProductId": 300, "Quantity": 2, "Price": 25.03 },
      { "OrderId": 1, "ProductId": 110, "Quantity": 2, "Price": 191.92 }
    ]
  },
  {
    "OrderId": 2,
    "PurchaseDate": "2019-04-13T16:15:5801361975",
    "CustomerId": 1,
    "Items": [
      { "OrderId": 2, "ProductId": 100, "Quantity": 2, "Price": 219.74       }
    ]
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The way this data is being returned indicates that a relational database of some sort is being used behind the scenes. However, much like the Loyalty system, <strong>we don&#8217;t have any direct access to that database</strong>. We must make do with the REST endpoints for now.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a third endpoint, <code>getProductDetailsByProductId</code>, which will return details about a product, given a product ID. For this tutorial, I&#8217;m going to ignore this endpoint. However, it will likely become critical to ingest this information efficiently as the Customer 360 system starts to mature (in a future tutorial).</p>
</div>
</div>
<div class="sect2">
<h3 id="ingesting-this-data"><a class="anchor" href="#ingesting-this-data"></a>Ingesting this data</h3>
<div class="paragraph">
<p>One approach to ingesting this data is to again use a Couchbase SDK and write a program. This program could examine our Customer 360 documents, make requests to the API, and update the Customer 360 documents (in the <em>customer360</em> bucket) with the details that are returned. At the same time, it could gather the order information and put those into the Customer 360 bucket. In psuedo-code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">for each document X in the customer360 bucket B
  email = X.email
  details = HTTP request to getCustomerDetailsByEmail
  orders = HTTP request to getOrdersByCustomerId
  update X.details
  create order document(s) in B
next X</code></pre>
</div>
</div>
<div class="paragraph">
<p>This could be run on a regular basis, much like the CSV task earlier.</p>
</div>
<div class="paragraph">
<p>This is a valid approach. However, since we&#8217;ll be writing code anyway, this seems like a good opportunity to write a Couchbase Eventing Function. We&#8217;ll need this function to consolidate all the other data in staging anyway. And since Functions can make HTTP requests on their own, we can put all this functionality inside of the Couchbase Data Platform, together with the data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-integration-with-couchbase-eventing-functions"><a class="anchor" href="#data-integration-with-couchbase-eventing-functions"></a>Data Integration with Couchbase Eventing Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Everything in this tutorial has lead to this point. There is a <em>staging</em> bucket that contains, for each person, at most two documents: one with data from the home delivery system, one with data from the loyalty system. (Your enterprise may, of course, have dozens of documents, depending on how many systems you&#8217;re pulling from). There is also data in the Online Store, waiting to be queries.</p>
</div>
<div class="paragraph">
<p>Now, it&#8217;s time to consolidate information into the <em>customer360</em> bucket. Let&#8217;s manually walk through an example of how the consolidation should look.</p>
</div>
<div class="sect2">
<h3 id="review-of-available-data"><a class="anchor" href="#review-of-available-data"></a>Review of available data</h3>
<div class="paragraph">
<p>In the <em>staging</em> bucket, there are two documents for Matthew Groves. Here is (a truncated version of) the home delivery document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">{
    "schema": { ... },
    "payload": {
      "after": {
        "zipcode": "04006",
        "password": "5owhiy1j.isq",
        "city": "West Evertchester",
        "name": "Matthew Groves",
        "address_line_1": "600 Sporer Curve",
        "phonenumber": "811.128.4320 x4808",
        "id": 1029,
        "address_line_2": "Suite 528",
        "state": "NH",
        "email": "matthew.groves@couchbase.com"
      },
      "source": {
        "name": "dbserver1", ...
      },
      ...
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is a loyalty member document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">{
    "id": "27",
    "password": "xrinn5xp.swd",
    "firstName": "Matthew",
    "lastName": "Groves",
    "email": "matthew.groves@couchbase.com",
    "points": "47"
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, though it doesn&#8217;t exist in the staging bucket, here is what we can expect to find when making a REST API request for Matthew Groves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">GET /api/onlineStore/getCustomerDetailsByEmail?customerEmail=gia_kutch%40oconnell.biz

{
  "Id": 1,
  "Name": "Matthew Groves",
  "Email": "matthew.groves@couchbase.com",
  "Password": "edzchzmatv5"
}

GET /api/onlineStore/getOrdersByCustomerId?customerId=1

[
  {
    "OrderId": 1,
    "Items": [ ... ], ...
  },
  {
    "OrderId": 2,
    "Items": [ ... ], ...
    ]
  }
]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customer-360-data-end-state"><a class="anchor" href="#customer-360-data-end-state"></a>Customer 360 Data end state</h3>
<div class="paragraph">
<p>Based on the data available in staging and the REST API, we want to consolidate all of the above into 3 total documents: 1 for the customer and 2 for that customer&#8217;s orders. We want the customer to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">KEY: matthew.groves@couchbase.com
{
	"type": "user",
	"profile": {
		"name": "Matthew Groves",
		"address1": "600 Sporer Curve",
		"address2": "Suite 528",
    ...
    "loyaltyPoints": "47"
	},
	"xrefs": [{
			"external_system": "online_store",
			"external_ID": 1,
			"pass": "edzchzmatv5"
		},
		{
			"external_system": "home_delivery",
			"external_ID": 1029,
			"pass": "5owhiy1j.isq"
		},
		{
			"external_system": "loyalty",
			"external_ID": "27",
			"pass": "xrinn5xp.swd"
		}
	]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is only <strong>one</strong> customer document, with consolidated fields like <code>name</code>, but it has <strong>three</strong> cross-references in which to store system specific data like <code>external_ID</code> and <code>pass</code>.</p>
</div>
<div class="paragraph">
<p>Since the order data is unbounded (a given customer could have hundreds of orders), the orders are stored in separate documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">KEY order::1
{
  "PurchaseDate": "2019-04-25T15:15:5800838522",
  "CustomerId": 1,
  "Items": [
    { "OrderId": 1, "ProductId": 200, "Quantity": 2, "Price": 87.81 },
    ...
  ]
}

KEY order::2
{
  "OrderId": 2,
  "PurchaseDate": "2019-04-13T16:15:5801361975",
  "CustomerId": 1,
  "Items": [
    { "OrderId": 2, "ProductId": 100, "Quantity": 2, "Price": 219.74 }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To recap, we expect 1 customer document to be created/updated out of 3+ total pieces of enterprise data. We expect all order documents to be copied over from the online store for a given customer.</p>
</div>
</div>
<div class="sect2">
<h3 id="create-an-integration-function"><a class="anchor" href="#create-an-integration-function"></a>Create an Integration Function</h3>
<div class="paragraph">
<p>This tutorial assumes you have some familiarity with how to create, deploy, and debug <a href="https://docs.couchbase.com/server/current/eventing/eventing-overview.html">Eventing Functions in Couchbase</a>. If not, please take the time to look through the fundamentals and work through some of the <a href="https://docs.couchbase.com/server/6.0/eventing/eventing-examples.html">eventing service examples</a>.</p>
</div>
<div class="paragraph">
<p>Since this will be a relatively complicated function, I decided to start by writing it as a plain <a href="https://nodejs.org">Node.JS</a> application, and test it with a series of <a href="https://mochajs.org/">Mocha</a> unit tests. If you elect to do this, make sure to keep the <a href="https://docs.couchbase.com/server/6.0/eventing/eventing-language-constructs.html">limitations of the Couchbase Eventing JavaScript engine</a> in mind.</p>
</div>
<div class="paragraph">
<p>The full <a href="//">source code is available on GitHub</a>. To start with, let&#8217;s create a function in the eventing service. Note that creating a function requires the use of a Metadata Bucket, which was mentioned earlier in this tutorial. If you didn&#8217;t create it then, it will need to be created now.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_images/00205-eventing-function.png" alt="Create an eventing function"></span></p>
</div>
<div class="paragraph">
<p><strong>Important note</strong>: <em>This tutorial was written with Couchbase Server 6.0 in mind. In Couchbase Server 6.5, CURL functionality will be changing. Be sure to check out the blog post <a href="https://blog.couchbase.com/using-curl-eventing-service-update/">Using cURL with the Eventing Service: Update</a> for more details. This tutorial will be (slightly) updated after a Couchbase Server 6.5 release.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="onupdate-function"><a class="anchor" href="#onupdate-function"></a>OnUpdate Function</h3>
<div class="paragraph">
<p>The next step is to write the JavaScript that will go into the <code>OnUpdate</code> function. This is the function that will be called for every document that appears in the staging bucket. Hypothetically, the code for the entire integration could live in this function. I&#8217;ve elected to break up the functionality into testable functions as much as possible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">function OnUpdate(doc, meta) {
	// when an email comes along, save it here for later
	// to poll the Online CRM API
	var emailToPollOnlineCRM = '';
	
	if(IsUserDelivery(doc)) {
        emailToPollOnlineCRM = IngestUserDelivery(doc, cust, log);
	}

	if(IsLoyaltyMember(doc)) {
        emailToPollOnlineCRM = IngestLoyaltyMember(doc, cust, log);
	}

	if(emailToPollOnlineCRM) {
        PollOnlineCrm(doc, emailToPollOnlineCRM, cust, curl, log);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The functions <code>IsUserDelivery</code> and <code>IsLoyaltyMember</code> make the determination as to what kind of document is being examined.</p>
</div>
</div>
<div class="sect2">
<h3 id="isuserdeliveryisloyaltymember"><a class="anchor" href="#isuserdeliveryisloyaltymember"></a>IsUserDelivery/IsLoyaltyMember</h3>
<div class="paragraph">
<p>For example, <code>IsUserDelivery</code> looks for payload source name, which was supplied by the Debezium connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">function IsUserDelivery(doc) {
    if(doc.payload)
      if(doc.payload.source)
        if(doc.payload.source.name)
            return doc.payload.source.name === 'dbserver1';
    return false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>IsLoyaltyMember</code> is similar. Next, <code>IngestUserDelivery</code> performs the actual creation or update of a Customer 360 document, using the User Delivery information:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">function IngestUserDelivery(doc, cust, log)
{
    log('INGEST', 'User Delivery System');
		
    var email = doc.payload.after.email;

    var customerDoc = GetCustomer360DocIfItExists(cust, email);
    if(!customerDoc) {
        customerDoc = {};
    }
    customerDoc = UpdateCustomerDocFromUserDelivery(customerDoc, doc);
    
    cust[email] = customerDoc;

    return email;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a good idea to keep these functions small so that they are readable and testable. In fact, this function has <code>cust</code> and <code>log</code> as parameters, even though they are technically available without being parameters. However, if I&#8217;m testing this with Mocha, I can inject fakes/mocks into those parameters. An example of a Mocha unit test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">it('should create a new customer 360 doc if one doesnt exist', function() {
    var expectedDocKey = doc.payload.after.email;

    eventing.IngestUserDelivery(doc, cust, log);

    assert.notStrictEqual(cust[expectedDocKey], undefined);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use caution when developing with Node/Mocha. It can help speed up your development, but be sure not to use any NPM packages or any functionality that is not available to the <a href="https://docs.couchbase.com/server/6.0/eventing/eventing-language-constructs.html">Couchbase Eventing JavaScript engine</a>. Additionally, there are <a href="https://docs.couchbase.com/server/6.0/eventing/eventing-language-constructs.html#added-lang-features">some features that have been added</a> that are not typically available with most JavaScript engines. Proceed with caution.</p>
</div>
</div>
<div class="sect2">
<h3 id="integrating-with-rest"><a class="anchor" href="#integrating-with-rest"></a>Integrating with REST</h3>
<div class="paragraph">
<p>The last step of the function involves making REST requests to the Online Store API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">function PollOnlineCrm(doc, email, cust, curl, log)
{
    var customerDoc = GetCustomer360DocIfItExists(cust, email);
    
    customerDoc = UpdateCustomerDocFromOnlineStore(customerDoc, email, cust, curl, log);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Again, note that CURL functionality is changing in Couchbase Server 6.5</strong>, but here is the relevant portion of <code>UpdateCustomerDocFromOnlineStore</code> for Couchbase Server 6.0 with the unsupported developer preview functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-JavaScript hljs" data-lang="JavaScript">var onlineStoreCustomerDetailsUrl = "http://172.17.0.8/api/onlineStore/getCustomerDetailsByEmail?customerEmail=" + email;
var onlineStoreCustomerDetails = curl(onlineStoreCustomerDetailsUrl, { "method" : "GET"});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the base URL is hard-coded. With Couchbase Server 6.5, the URL will be a binding that you specify when creating the function. The result of curl in this case is a JavaScript object that can be ingested into the customer 360 document in the same manor as the other integrations.</p>
</div>
<div class="paragraph">
<p>After the function is deployed, it will immediately go to work on the documents in the <em>staging</em> bucket, and documents will start to appear in the <em>customer360</em> bucket.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, the data ingestion process is well underway. The <em>customer360</em> bucket will start to be populated with information from our customers. If you&#8217;re using nightly CSV imports, it may take that long for <strong>all</strong> of the data to show, but at least you have a head start.</p>
</div>
<div class="paragraph">
<p>So now that we have a bucket containing complete pictures of our customers, what do we do next?</p>
</div>
<div class="paragraph">
<p>The initial goals may be just to use this Customer 360 data in a "read-only" fashion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Build a customer dashboard to view all the details of a specific customer</p>
</li>
<li>
<p>Build an enterprise dashboard to view aggregate information about the entire customer base</p>
</li>
<li>
<p>Use the customer 360 data as input to machine learning or recommendation algorithms (e.g. "customers who bought the same items as you were also interested in X").</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, the longer term goal may be to transition/move/replace/transform some or all of these individual systems to use Couchbase as a primary data store.</p>
</div>
<div class="paragraph">
<p>Either way, the first step is to start ingesting data into Couchbase. Now that we have this solid foundation in place, future tutorials will explore all the options that the Couchbase Data Platform can provide.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2021 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
