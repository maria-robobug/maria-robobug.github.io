<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Connecting Sync Gateway to a Couchbase Cluster | Couchbase Docs (Local)</title>
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/tutorial-sync-gateway.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/tutorial-sync-gateway.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Tutorials</li>
<li class="crumb">Sync Gateway</li>
<li class="crumb"><a href="tutorial-sync-gateway.html">Connecting Sync-Gateway to a Couchbase Cluster</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Connecting Sync Gateway to a Couchbase Cluster</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Connect the Couchbase Sync Gateway to a Couchbase cluster
</blockquote>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tutorials are accurate at the time of writing but rely heavily on third party software.
Tutorials are provided to demonstrate how a particular problem may be solved.
Use of third party software is not supported by Couchbase.
For further help in the event of a problem, contact the relevant software maintainer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Sync Gateway is a synchronization server that is responsible for secure data synchronization and routing between Couchbase Lite-enabled clients and Couchbase Server.
It is an integral component of the <a href="#sync-gateway::index.adoc" class="xref unresolved">Couchbase Mobile</a> platform.</p>
</div>
<div class="paragraph">
<p>This tutorial defines best practices for deploying Sync Gateway on Kubernetes.
It covers basic connectivity between Sync Gateway and a Couchbase Cluster deployed by the Autonomous Operator.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A Couchbase Server cluster deployed and running.
While it is <em>recommended</em> that Couchbase Server is deployed on Kubernetes, it is <em>not required</em>.
It is possible to deploy Sync Gateway on Kubernetes and connect it to a Couchbase Server cluster that is not on Kubernetes.
However, this guide and all of its instructions assume that Couchbase Server is deployed on Kubernetes using the Autonomous Operator.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-sync-gateway"><a class="anchor" href="#configuring-sync-gateway"></a>Configuring Sync Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sync Gateway is configured with a configuration file within its container.
The configuration contains sensitive data such as usernames, passwords, and TLS private keys.
We therefore should define the configuration as a secret.
Create a <code>sync-gateway-config.yaml</code> file with the relevant configuration variables.
An example is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: sync-gateway
stringData:
  config.json: |-
    {
      "logging": {
        "console": {
          "enabled": true, <i class="conum" data-value="1"></i><b>(1)</b>
          "log_level": "info", <i class="conum" data-value="2"></i><b>(2)</b>
          "log_keys": [
            "*"
          ]
        }
      },
      "databases": {
        "cb-example": { <i class="conum" data-value="3"></i><b>(3)</b>
          "server": "couchbase://cb-example-srv.my-namespace?network=default", <i class="conum" data-value="4"></i><b>(4)</b>
          "bucket": "default", <i class="conum" data-value="5"></i><b>(5)</b>
          "username": "Administrator", <i class="conum" data-value="6"></i><b>(6)</b>
          "password": "password", <i class="conum" data-value="7"></i><b>(7)</b>
          "users": {
            "GUEST": {
              "disabled": false,
              "admin_channels": [
                "*"
              ]
            }
          },
          "allow_conflicts": false,
          "revs_limit": 20,
          "enable_shared_bucket_access": true
        }
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>logging.console.enabled</code> enables logging to the console.
This is especially relevant on Kubernetes where applications are expected to log to standard out.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>logging.console.log_level</code> defines what messages are printed.
For most use cases <code>info</code> is sufficient, however <code>debug</code> may provide additional information that can aid in problem determination.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>databases.cb-example</code> is the name of a database connection.
The database name is arbitrary.
In this instance we have named it after the <code>CouchbaseCluster</code> resource it references.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>databases.cb-example.server</code> defines the connection string of the Couchbase Server instance that Sync Gateway will connect to.
The connection string may be determined in the same way as for <a href="howto-client-sdks.html" class="xref page">client SDKs</a>.
<div class="paragraph">
<p>The connection string in the example&#8201;&#8212;&#8201;<code>couchbase://cb-example-srv.my-namespace</code>&#8201;&#8212;&#8201;assumes that Sync Gateway and Couchbase Server are running on the same Kubernetes cluster.
If we examine each part of the string:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>couchbase</code> (as opposed to <code>couchbases</code>) specifies that the connection is over plain text and not secured by TLS</p>
</li>
<li>
<p><code>cb-example</code> is the name of the Couchbase cluster</p>
</li>
<li>
<p><code>-srv</code> specifies that the connection utilizes DNS SRV lookup to <a href="howto-client-sdks.html#dns-based-addressing" class="xref page">discover</a> Couchbase cluster pods running the Data Service</p>
</li>
<li>
<p><code>?network=default</code> instructs Sync Gateway to <a href="howto-client-sdks.html#client-explicit-network-selection" class="xref page">explicitly select</a> the internal network addresses of Couchbase cluster pods.
<em>Requires Sync Gateway 2.8.2 or higher; otherwise omit this parameter.</em></p>
</li>
<li>
<p><code>my-namespace</code> is the namespace in which the Couchbase cluster is deployed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>server</code> property can technically accept connection endpoints as defined in the Sync Gateway <a href="#sync-gateway::configuration-properties.adoc#databases-this_db-server" class="xref unresolved">documentation</a>.
However, many of these connection endpoints are not recommended (some not even supported) when connecting to Couchbase Server deployments that are managed by the Autonomous Operator.
In particular, there are <a href="concept-couchbase-networking.html#sync-gateway-exposed-features-limitations" class="xref page">limitations when using exposed features</a> that affect which connection methods can be used with certain versions of Sync Gateway.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>databases.cb-example.bucket</code> defines the <code>metadata.name</code> to connect to and use to store mobile data.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>databases.cb-example.username</code> defines the user that will be used to connect to the cluster.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>databases.cb-example.password</code> defines the user password that will be used to connect to the cluster.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the configuration file is named <code>sync-gateway-config.yaml</code>, the command to deploy it would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway.yaml</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="enabling-tls-connectivity-to-couchbase-server"><a class="anchor" href="#enabling-tls-connectivity-to-couchbase-server"></a>Enabling TLS Connectivity to Couchbase Server</h3>
<div class="paragraph">
<p>TLS is fully supported between Sync Gateway and Couchbase Server.
This includes <a href="concept-tls.html" class="xref page">server-side TLS or mutual TLS</a>.</p>
</div>
<div class="paragraph">
<p>Your Sync Gateway configuration can be modified to allow use of TLS as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: sync-gateway
stringData:
  config.json: |-
    {
      "databases": {
        "cb-example": {
            "cacertpath": "/etc/sync_gateway/ca.pem", <i class="conum" data-value="1"></i><b>(1)</b>
            "certpath": "/etc/sync_gateway/cert.pem", <i class="conum" data-value="2"></i><b>(2)</b>
            "keypath": "/etc/sync_gateway/key.pem", <i class="conum" data-value="3"></i><b>(3)</b>
        }
      }
    }
  ca.pem: |- <i class="conum" data-value="4"></i><b>(4)</b>
    -----BEGIN CERTIFICATE-----
    MIIDSzCCAjOgAwIBAgIUDsYnaG+RFwhtoz9hSMwyzfoxOCcwDQYJKoZIhvcNAQEL
    ...
  cert.pem: |- <i class="conum" data-value="5"></i><b>(5)</b>
    -----BEGIN CERTIFICATE-----
    MIIDXDCCAkSgAwIBAgIRAOUsHgVlGyJbvOIYuxD90x4wDQYJKoZIhvcNAQELBQAw
    ...
  key.pem: |- <i class="conum" data-value="6"></i><b>(6)</b>
    -----BEGIN PRIVATE KEY-----
    MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDLaRvd8BxDBsPc
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Certificates have been truncated for brevity.</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>databases.cb-example.cacertpath</code> defines where the CA certificate will be read from.
This path is related to the deployment volume mount as described in <a href="#deploying-sync-gateway">Deploying Sync Gateway</a> and the file name as described in this <code>Secret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Mutual TLS Only:</strong> <code>databases.cb-example.certpath</code> defines where the client certificate chain will be read from.
This path is related to the deployment volume mount as described in <a href="#deploying-sync-gateway">Deploying Sync Gateway</a> and the file name as described in this <code>Secret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Mutual TLS Only:</strong> <code>databases.cb-example.keypath</code> defines where the client key will be read from.
This path is related to the deployment volume mount as described in <a href="#deploying-sync-gateway">Deploying Sync Gateway</a> and the file name as described in this <code>Secret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>ca.pem</code> secret is the CA certificate.
The name of this secret data item defines the file name as used by <code>databases.cb-example.cacertpath</code> in the Sync Gateway configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>Mutual TLS Only:</strong> The <code>cert.pem</code> secret is the client certificate chain.
The name of this secret data item defines the file name as used by <code>databases.cb-example.certpath</code> in the Sync Gateway configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><strong>Mutual TLS Only:</strong> The <code>key.pem</code> secret is the client key.
The name of this secret data item defines the file name as used by <code>databases.cb-example.keypath</code> in the Sync Gateway configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the configuration file is named <code>sync-gateway-tls.yaml</code>, the command to deploy it would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway-tls.yaml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-an-rbac-user-for-sync-gateway"><a class="anchor" href="#configure-an-rbac-user-for-sync-gateway"></a>Configuring an RBAC User for Sync Gateway</h3>
<div class="paragraph">
<p>If not using client certificate authentication, secure the system further by using a limited role to access Couchbase Server.
In doing so, the scope of operations that can be performed in the event that the Sync Gateway configuration is compromised is limited.
The RBAC user corresponding to Sync Gateway can be manually configured as specified in the Sync Gateway <a href="#sync-gateway::get-started-prepare.adoc#configure-server" class="xref unresolved">Getting Started Guide</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can take advantage of the <a href="concept-user-rbac.html" class="xref page">Couchbase user RBAC management</a> capability introduced in Autonomous Operator 2.0.
With this method, the Autonomous Operator takes care of creating the relevant Sync Gateway user and binds it to a specified role.
The following subsections assume that you will be using this feature.</p>
</div>
<div class="sect3">
<h4 id="enabling-rbac-management"><a class="anchor" href="#enabling-rbac-management"></a>Enabling RBAC Management</h4>
<div class="paragraph">
<p>RBAC security management on the Couchbase cluster defaults to <code>false</code>.
Therefore, you&#8217;ll need to enable it by setting <a href="resource/couchbasecluster.html#couchbaseclusters-spec-security-rbac-managed" class="xref page"><code>couchbaseclusters.spec.security.rbac.managed</code></a> to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">security:
  rbac:
    managed: true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Enabling RBAC management by the Autonomous Operator will remove any RBAC users that were manually created on the cluster.
Therefore, you will need to specify the relevant users and role bindings for those RBAC users if you want to continue using those identities after enabling RBAC management.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-sync-gateway-rbac-user"><a class="anchor" href="#creating-a-sync-gateway-rbac-user"></a>Creating a Sync Gateway RBAC User</h4>
<div class="paragraph">
<p>First, define a secret for the <code>sync-gateway</code> user that contains a password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: sync-gateway
data:
  password: cGFzc3dvcmQ= <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This example password is literally the encoded form of the word <code>password</code>.
The correctly encoded form can be generated on a "UNIX-like" command line terminal with <code>echo -n 'password' | base64</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the configuration file is named <code>sync-gateway-rbac-user.yaml</code>, the command to deploy it would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway-rbac-user.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a sync gateway user with the specified password.</p>
</div>
</div>
<div class="sect3">
<h4 id="role-binding-of-sync-gateway-user"><a class="anchor" href="#role-binding-of-sync-gateway-user"></a>Role Binding of Sync Gateway User</h4>
<div class="paragraph">
<p>Next, define the <code>sync-gateway</code> user and bind it to a group that allows it the "application access" role as defined by Couchbase Server.
The Autonomous Operator will create the required user and group on any Couchbase cluster that selects that user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseUser
metadata:
  name: sync-gateway
  labels:
    cluster: my-cluster <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  authDomain: local <i class="conum" data-value="2"></i><b>(2)</b>
  authSecret: sync-gateway <i class="conum" data-value="3"></i><b>(3)</b>
---
apiVersion: couchbase.com/v2
kind: CouchbaseGroup
metadata:
  name: sync-gateway
spec:
  roles:
  - name: mobile_sync_gateway <i class="conum" data-value="4"></i><b>(4)</b>
    bucket: default <i class="conum" data-value="5"></i><b>(5)</b>
---
apiVersion: couchbase.com/v2
kind: CouchbaseRoleBinding
metadata:
  name: sync-gateway
spec:
  subjects:
  - kind: CouchbaseUser
    name: sync-gateway
  roleRef:
    kind: CouchbaseGroup
    name: sync-gateway</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>CouchbaseUser</code> is labeled so it can be explicitly selected by a specific cluster.
This is the recommended method of deployment as defined in the <a href="concept-label-selection.html" class="xref page">label selection concepts</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>CouchbaseUser</code> uses the <code>local</code> authentication domain, meaning that a password will be locally installed on the Couchbase cluster for authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>CouchbaseUser</code> references the secret we previously created so that the Autonomous Operator can associate the <code>sync-gateway</code> user with its password.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>CouchbaseGroup</code> that the <code>sync-gateway</code> user will be a member of needs the <code>mobile_sync_gateway</code> role.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>CouchbaseGroup</code> that the <code>sync-gateway</code> user will be a member of only requires access to a single bucket.
We therefore further limit scope to only enable modification of the <code>default</code> bucket.
By default this would be set to <code>*</code> granting access to all buckets.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the configuration file is named <code>sync-gateway-user-rolebinding.yaml</code>, the command to deploy it would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway-user-rolebinding.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-sync-gateway-with-the-rbac-user"><a class="anchor" href="#configure-sync-gateway-with-the-rbac-user"></a>Configure Sync Gateway with the RBAC User</h4>
<div class="paragraph">
<p>Finally, to enable Sync Gateway to use the <code>sync-gateway</code> user, we&#8217;ll need to modify the configuration that we previously defined in <a href="#configuring-sync-gateway">Configuring Sync Gateway</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: sync-gateway
stringData:
  config.json: |-
    {
      "databases": {
        "cb-example": {
          "bucket": "default", <i class="conum" data-value="1"></i><b>(1)</b>
          "username": "sync-gateway", <i class="conum" data-value="2"></i><b>(2)</b>
          "password": "password" <i class="conum" data-value="3"></i><b>(3)</b>
        }
      }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>databases.cb-example.bucket</code> attribute must match the bucket granted access to in the <code>CouchbaseGroup</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>databases.cb-example.username</code> attribute must match the <code>CouchbaseUser</code> resource&#8217;s name.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>databases.cb-example.password</code> attribute must match the plain-text password associated with the <code>CouchbaseUser</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the configuration file is named <code>sync-gateway.yaml</code>, the command to deploy the configuration changes would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-sync-gateway"><a class="anchor" href="#deploying-sync-gateway"></a>Deploying Sync Gateway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sync Gateway is a simple stateless application, and therefore does not require any application-specific controller like the Autonomous Operator.
The following is a typical <code>Deployment</code> resource configuration for Sync Gateway:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: sync-gateway
spec:
  replicas: 1 <i class="conum" data-value="1"></i><b>(1)</b>
  selector:
    matchLabels:
      app: sync-gateway
  template:
    metadata:
      labels:
        app: sync-gateway
    spec:
      containers:
      - name: sync-gateway
        image: couchbase/sync-gateway:2.8.3-enterprise <i class="conum" data-value="2"></i><b>(2)</b>
        volumeMounts:
        - name: config
          mountPath: /etc/sync_gateway <i class="conum" data-value="3"></i><b>(3)</b>
          readOnly: true
        ports: <i class="conum" data-value="4"></i><b>(4)</b>
        - name: http-api
          containerPort: 4984
        - name: http-metrics
          containerPort: 4986
        resources: <i class="conum" data-value="5"></i><b>(5)</b>
          requests:
            cpu: 1
            memory: 1Gi
          limits:
            cpu: 2
            memory: 2Gi
        env:
        - name: GOMAXPROCS <i class="conum" data-value="6"></i><b>(6)</b>
          value: "1"
      volumes:
      - name: config
        secret:
          secretName: sync-gateway <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>spec.replicas</code> defines how many Sync Gateway pods to create.
As Sync Gateway is stateless, this attribute can be modified to horizontally scale the deployment as needs require.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>spec.template.spec.containers[].image</code> defines the container image to deploy.
Version 2.8.2 or higher is recommended as it has the fewest number of <a href="concept-couchbase-networking.html#sync-gateway-exposed-features-limitations" class="xref page">network limitations</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>spec.template.spec.containers[].volumeMounts[].mountPath</code> mounts the configuration secret in the correct location.
By default the Sync Gateway container will try to load configuration from <code>/etc/sync_gateway/config.json</code>, and this is how the <code>Secret</code> and <code>Deployment</code> are configured.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>spec.template.spec.containers[].ports[]</code> defines the Sync Gateway ports.
The <code>sync-gateway</code> port is required for Couchbase Mobile to connect to, this can be load balanced and exposed via a service, load-balancer or ingress.
The <code>metrics</code> port is optional, and provides integration with Prometheus.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>spec.template.spec.containers[].resources</code> allows the a pod&#8217;s resource requirements to be configured.
We highly recommend that this is configured to ensure fair scheduling and access to the required resources.
The actual values are dependent on your actual workload, and the ones depicted are an example only.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>spec.template.spec.containers[].env</code> allows environment variables to the passed to Sync Gateway.
Particular attention should be paid to <code>GOMAXPROCS</code> and this defines the number of CPUs that Sync Gateway can use.
This is directly related to the resources defined previously.
If you have allocated 4 CPUs, you should set the maximum number of CPUs to 4 also.
The limits should be above this number to allow for any overheads, as Kubernetes will terminate pods who exceed their resource limits.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>spec.template.spec.volumes[].secret.secretName</code> references the <a href="#configuring-sync-gateway">Sync Gateway configuration</a> <code>Secret</code> that is mounted in the Sync Gateway container.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Deploy the Sync Gateway cluster from the specified deployment controller file.
If the above configuration is in a file named <code>sync-gateway.yaml</code>, the command to deploy it would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f sync-gateway.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>If successful, the equivalent of the following output will be returned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">deployment.extensions "sync-gateway" created</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the status of the deployment with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get deployments sync-gateway</code></pre>
</div>
</div>
<div class="paragraph">
<p>If successful, a listing of the Sync Gateway pods that were deployed is returned.
In the sample output below, 2 out of 2 requested Sync Gateway pods up and running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME           READY   UP-TO-DATE   AVAILABLE   AGE
sync-gateway   2/2     2            2           24d</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps"><a class="anchor" href="#next-steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this stage, the Sync Gateway cluster is configured to communicate with Couchbase Server.
You can now move on to <a href="tutorial-sync-gateway-clients.html" class="xref page">connecting Couchbase Lite clients</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="templates"><a class="anchor" href="#templates"></a>Templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Template files are provided in the Autonomous Operator binary distribution available at <a href="https://www.couchbase.com/downloads" target="_blank" rel="noopener">couchbase.com/downloads</a>.
These template files are provided as <strong>evaluation examples</strong>&#8201;&#8212;&#8201;they should be modified to suit production deployments.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sync-gateway.yaml</code>: Sample Deployment Controller for Sync Gateway using RBAC for server connectivity.
This template creates a sync gateway RBAC user per procedures outlined in the previous section <a href="#configure-an-rbac-user-for-sync-gateway">Configuring an RBAC User for Sync Gateway</a>.</p>
</li>
<li>
<p><code>couchbase-custer.yaml</code>: Sample <code>CouchbaseCluster</code> custom resource deployment to be used with the Autonomous Operator.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>couchbase-custer.yaml</code> template has RBAC management set to <code>false</code> by default.
So before you deploy the Sync Gateway cluster using the <code>sync-gateway.yaml</code> template, you must enable RBAC management as specified in the previous section <a href="#configure-an-rbac-user-for-sync-gateway">Configuring an RBAC User for Sync Gateway</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Red Hat OpenShift users will need to modify the provided template to reference an image pull secret.
This must grant permission to pull container images from the Red Hat Container Registry.
Refer to <a href="install-openshift.html" class="xref page">Install the Operator on OpenShift</a> for details.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>Further Reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#sync-gateway::index.adoc" class="xref unresolved">Sync Gateway Documentation</a></p>
</li>
<li>
<p><a href="tutorial-sync-gateway-clients.html" class="xref page">Exposing Sync Gateway to Couchbase Lite Clients</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
