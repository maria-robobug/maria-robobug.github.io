<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Data Topology Save, Restore and Synchronization | Couchbase Docs (Local)</title>
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/concept-data-save-restore.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/concept-data-save-restore.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Learn</li>
<li class="crumb">Couchbase Cluster Concepts</li>
<li class="crumb">Data Management</li>
<li class="crumb"><a href="concept-data-save-restore.html">Data Topology Save, Restore and Synchronization</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Data Topology Save, Restore and Synchronization</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Operator and tooling provides features to aid with development and management of clusters.
This details what can be done, and when it should be used.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction-to-save-restore-and-synchronization"><a class="anchor" href="#introduction-to-save-restore-and-synchronization"></a>Introduction to Save, Restore and Synchronization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Operator provides a rich set of Kubernetes-native primitives for configuration and management of the Couchbase data topology.
Typically you would use a configuration and life-cycle manager to handle these resource for you e.g. Helm, Red Hat Operator Lifecycle Manager.
These provide enterprise features such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change control</p>
</li>
<li>
<p>Peer review</p>
</li>
<li>
<p>Auditing</p>
</li>
<li>
<p>Disaster recovery</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On some occasions, such as development environments, introducing a complex workflow may prove counter-productive, and negatively impact time to market.</p>
</div>
<div class="paragraph">
<p>This is where the save, restore and synchronization features come in to play.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Save, restore and synchronization are&#8201;&#8212;&#8201;ostensibly&#8201;&#8212;&#8201;manual operations outside of the scope of any life-cycle manager used to deploy and manage a Couchbase cluster.
To a lifecycle manager, any modifications to managed resources will look like external interference that needs to be reconciled back into the requested state.
A result of accidental reversion is deletion of buckets, scopes, collection, data and indexes.</p>
</div>
<div class="paragraph">
<p>It is your responsibility to ensure either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Life-cycle management is not used, or does not run periodically and update infrastructure.</p>
</li>
<li>
<p>Life-cycle management is updated with any necessary changes to prevent reversion.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-topology-save-and-restore"><a class="anchor" href="#data-topology-save-and-restore"></a>Data Topology Save and Restore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data topology save and restore does what it sounds like: allows data topology (buckets, scopes and collections), to be saved as a file, then restored to a Couchbase cluster.</p>
</div>
<div class="paragraph">
<p>Data topology is read directly from the Couchbase cluster being saved, and therefore is not constrained by resources whether managed or not&#8201;&#8212;&#8201;what&#8217;s live on the cluster is what&#8217;s considered.</p>
</div>
<div class="paragraph">
<p>When data topology is restored to the cluster, two things happen, resources representing the data topology are atomically applied to the cluster, and management of those resources is enabled.
After this point, any manual modifications to the data topology will be reverted by the Operator as per usual.</p>
</div>
<div class="paragraph">
<p>There are two use cases that save and restore fulfills:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local save and restore&#8201;&#8212;&#8201;from and to the same cluster&#8201;&#8212;&#8201;allows manually created resources to be converted into Kubernetes resources and managed.</p>
</li>
<li>
<p>Remote restoration allows a save file to be applied to another cluster, allowing you to define your database schema one time, then replicate it across your enterprise.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="using-save-and-restore"><a class="anchor" href="#using-save-and-restore"></a>Using Save and Restore</h3>
<div class="paragraph">
<p>Throughout this example, the Couchbase cluster being referred to is called <code>my-cluster</code>.
You will need to change this to your specific cluster name.</p>
</div>
<div class="sect3">
<h4 id="creating-a-save-file"><a class="anchor" href="#creating-a-save-file"></a>Creating a Save File</h4>
<div class="paragraph">
<p>Consider the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao save --couchbase-cluster my-cluster --filename my-cluster-save.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>cao</code> tool will connect to the named cluster defined by the <code>--couchbase-cluster</code> flag.
The command will read all buckets from Couchbase Server, then recursively any scopes and collections contained within them.
The command will then convert all discovered resources into native Kubernetes resource types, preserving all configuration and linkage information.
Finally the save file is stored as defined by the <code>--filename</code> flag.</p>
</div>
<div class="paragraph">
<p>The command above results in a <em>full-tree save</em>, i.e. everything on the system.</p>
</div>
<div class="paragraph">
<p>It is also possible to do a <em>sub-tree save</em>, that limits the scope to all resources contained within a single bucket, or scope.
For example, a sub-tree save of a bucket will contain all scopes and collections within it, and a sub-tree save of a scope will contain only the collections within that scope.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Due to the design of scopes and collections for Kubernetes, a default collection can only be preserved by also including its parent scope.
When taking a sub-tree save of a scope, the default collection will be discarded.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information on the <code>cao save</code> command, and all supported flags, read the <a href="tools/cao.html#cao-save-flags" class="xref page">reference documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="restoring-a-save-file"><a class="anchor" href="#restoring-a-save-file"></a>Restoring a Save File</h4>
<div class="paragraph">
<p>Restoring a save file to a cluster is equally easy as saving:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao restore --couchbase-cluster my-cluster --filename my-cluster-save.yaml
<span style="font-weight: bold">Data topology solution:</span>

  /
  └── <span style="font-weight: bold; color: blue">pail</span> (bucket) <span style="font-weight: bold; color: green">create</span>
      ├── <span style="font-weight: bold; color: blue">_default</span> (scope) <span style="font-weight: bold; color: green">create</span>
      ├── <span style="font-weight: bold; color: blue">periscope</span> (scope) <span style="font-weight: bold; color: green">create</span>
      └── <span style="font-weight: bold; color: blue">telescope</span> (scope) <span style="font-weight: bold; color: green">create</span>
          └── <span style="font-weight: bold; color: blue">copernicus</span> (collection) <span style="font-weight: bold; color: green">create</span>

<span style="font-weight: bold; color: orange">WARNING!</span> resources marked as <span style="font-weight: bold; color: red">delete</span> may result in data loss.

<span style="font-weight: bold">OK to proceed? (y/N)</span> y
couchbasebuckets/bucket-0bb85962-2f40-4492-a6dc-53c6aec37c80 created
couchbasescopes/scope-38413733-3965-4557-8520-815cbd710a30 created
couchbasescopes/scope-ef185678-6625-4378-8ed0-4d880446790f created
couchbasecollections/collection-cbaad53f-2a4e-4066-9d55-2798323417d9 created
couchbasecluster/my-cluster updated</code></pre>
</div>
</div>
<div class="paragraph">
<p>This demonstrates a number of features, and benefits of using this tooling:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Feedback is given to the user so you can review changes before applying them.</p>
</li>
<li>
<p>You can back out of a change if it&#8217;s not as desired.</p>
</li>
<li>
<p>Each resource listed has an action that will be performed to conform the cluster to the save file:</p>
<div class="ulist">
<ul>
<li>
<p><code>create</code>: the resource is new and will be created.</p>
</li>
<li>
<p><code>update</code>: the resource is different, e.g. bucket memory quota has changed, and will be updated.</p>
</li>
<li>
<p><code>delete</code>: the resource is no longer required and will be deleted.</p>
</li>
<li>
<p><code>retain</code>: the resource is unchanged.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, this tool will never delete any resource, this is a safe mode of operation that ensures no data will be accidentally deleted.
You can change the merge strategy to delete resources that appear in the cluster but not in the save file.
This mode of operation is for enforcement of schema, and ensures that unneeded data will be cleaned up.</p>
</div>
<div class="paragraph">
<p>For more information on the <code>cao restore</code> command, and all supported flags, read the <a href="tools/cao.html#cao-restore-flags" class="xref page">reference documentation</a>.</p>
</div>
<div class="paragraph">
<p>Read on for a more technical breakdown of how this command works, or skip to the <a href="#data-topology-synchronization">Data Topology Synchronization</a> section for more options migrating from an unmanaged data topology to a managed one.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When performing a restore, there are a number of cluster conditions that must be met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data topology is not be managed</p>
</li>
<li>
<p>or data topology is managed, and bucket label selectors are in use</p>
</li>
<li>
<p>or data topology is managed, bucket label selectors are not in use, but there are no bucket resources selected</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The use of label selectors is two-fold.
First, this is a strong indicator that other clusters in the same namespace will not be affected, it is your responsibility to ensure selector uniqueness.
Second, this allows atomic updates of the entire topology, and rollback in the event of an error.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="restore-internals"><a class="anchor" href="#restore-internals"></a>Restore Internals</h3>
<div class="paragraph">
<p>This section gives a technical breakdown of how a save file is restored to a Couchbase cluster, and how various options affect the outcome.</p>
</div>
<div class="sect3">
<h4 id="data-model"><a class="anchor" href="#data-model"></a>Data Model</h4>
<div class="paragraph">
<p>You should be familiar with the concepts of <a href="concept-scopes-and-collections.html" class="xref page">buckets, scopes and collections</a>.
If we took the naive approach of modeling this as is, then we&#8217;d end up with a forest of trees&#8201;&#8212;&#8201;buckets contain scopes and collections, there are multiple buckets.
This is an inefficient model for our purposes, so instead we introduce a root node, then our forest becomes a single tree.</p>
</div>
<div class="paragraph">
<div class="title">Restore Data Model</div>
<p><span class="image"><img src="_images/save-restore-data-model.png" alt="save restore data model"></span></p>
</div>
<div class="paragraph">
<p>When we first start processing the save file, two things happen.</p>
</div>
<div class="paragraph">
<p>First, the save data is processed and it is organized into a tree, the <em>requested tree</em>.
This may take the form of a full-tree&#8201;&#8212;&#8201;where buckets are children of the root node&#8201;&#8212;&#8201;or a sub-tree&#8201;&#8212;&#8201;where scopes or collections are children of the root node.</p>
</div>
<div class="paragraph">
<p>Second, the Couchbase cluster is polled for its current data topology, essentially the same process as a save, which is also organized into a full-tree, the <em>current tree</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sub-tree-splicing"><a class="anchor" href="#sub-tree-splicing"></a>Sub-tree Splicing</h4>
<div class="paragraph">
<p>When merging trees together in the next phase, it&#8217;s far easier to consider full-trees, where at each level of the tree, the resource types are the same.
When provided with a full-tree, this can just be left as-is.</p>
</div>
<div class="paragraph">
<p>Sub-trees however need to be "attached" to some point in the hierarchy, yielding an <em>effective requested tree</em>.</p>
</div>
<div class="paragraph">
<div class="title">Example Splice</div>
<p><span class="image"><img src="_images/save-restore-splicing.png" alt="save restore splicing"></span></p>
</div>
<div class="paragraph">
<p>In the above example, a sub-tree save of scopes and collections is spliced into the existing tree to yield the <em>effective requested tree</em>.
All children of the attach point are removed, and replaced with the contents of the sub-tree save.
The point at where the sub-tree is attached is under the direction of the <code>--path</code> command flag.</p>
</div>
<div class="paragraph">
<p>When a sub-tree save is loaded, the command will ensure a path is provided, and that the path defines an element at the correct level.</p>
</div>
</div>
<div class="sect3">
<h4 id="merging"><a class="anchor" href="#merging"></a>Merging</h4>
<div class="paragraph">
<p>Merging is the most important step in the process.
It takes the current tree and merges it with the effective requested tree to yield a merged tree.
The end product is a single tree that contains all nodes that exist in both input trees, but with an action associated with it.</p>
</div>
<div class="paragraph">
<p>The default operation is to merge trees so that nothing is deleted:</p>
</div>
<div class="paragraph">
<div class="title">Merging with the Merge Strategy</div>
<p><span class="image"><img src="_images/save-restore-merge-merge.png" alt="save restore merge merge"></span></p>
</div>
<div class="paragraph">
<p>Here we can see that even though <code>Scope1</code> in <code>Bucket1</code> is not in the requested tree, it will be preserved, so no data is lost.
Likewise, <code>Collection2</code> in <code>Scope2</code> in <code>Bucket1</code>.
<code>Collection3</code> in <code>Scope2</code> in <code>Bucket1</code> is requested, but does not exist, so that is flagged for creation (green).
<code>Scope2</code> in <code>Bucket1</code> may have changed in some way, so that is flagged for an update (orange).</p>
</div>
<div class="paragraph">
<p>The other option when merging is to use the replace strategy (the <code>--strategy=replace</code> command flag):</p>
</div>
<div class="paragraph">
<div class="title">Merging with the Replace Strategy</div>
<p><span class="image"><img src="_images/save-restore-merge-replace.png" alt="save restore merge replace"></span></p>
</div>
<div class="paragraph">
<p>The difference between this strategy and the default merge strategy is that things that currently exist, but have not been requested will be marked for deletion (red).</p>
</div>
<div class="paragraph">
<p>Whatever merge strategy was selected, the <em>merged tree</em> output from this stage is what is presented to the user on the command line for user verification.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may have noticed that as sub-tree saves are spliced into the <em>current tree</em>, therefore anything outside of the scope of the save data will always be preserved, regardless of the merge strategy.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="compaction"><a class="anchor" href="#compaction"></a>Compaction</h4>
<div class="paragraph">
<p>Once the merge tree is generated, and the user has given the go ahead, it is processed into a <em>compacted tree</em>.
This stage does a traversal of the merged tree, and compacts retained, created and updated resources into groups, where it can.
For example, collections can be combined into collection groups where their specifications match.
Likewise, scopes can be combined into scope groups if they contain the same set of child collections.</p>
</div>
<div class="paragraph">
<p>Compaction can dramatically reduce the number of resources that are required to fulfill a data topology, leading to fewer Kubernetes API calls, faster performance, and simpler resource management.</p>
</div>
</div>
<div class="sect3">
<h4 id="pivoting-and-cleanup"><a class="anchor" href="#pivoting-and-cleanup"></a>Pivoting and Cleanup</h4>
<div class="paragraph">
<p>The final step is to commit the data topology and make it live.
This is a simple case of generating all resources in the compacted tree, giving each resource a unique name, linking them together and creating them in Kubernetes.
The Couchbase cluster is then updated to manage buckets, and select those that we have just created (with a label selector).</p>
</div>
<div class="paragraph">
<p>This pivot from an existing tree, to a new one, is atomic, therefore if anything goes wrong during this process, the operation can be rolled back.</p>
</div>
<div class="paragraph">
<p>Cleanup occurs after the new data topology is live.
The restore command interrogated the Couchbase cluster before doing the pivot to determine any Kubernetes resources linked to it (e.g. <code>CouchbaseBucket</code>, <code>CouchbaseScope</code>, etc.)
These are now deleted to provide automated garbage collection.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because multiple Couchbase clusters can run in the same namespace, there is a danger that any resource created, or deleted, by a restore may be erroneously picked up by another cluster.
It is your responsibility to ensure any other clusters in this namespace have a unique bucket/scope/collection label selectors that will not be affected by this synchronization operation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-topology-synchronization"><a class="anchor" href="#data-topology-synchronization"></a>Data Topology Synchronization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unlike <a href="#data-topology-save-and-restore">Data Topology Save and Restore</a>, synchronization is a fully online process.</p>
</div>
<div class="paragraph">
<p>Synchronization allows data topology to be manually created by the user, either via the Couchbase user interface, or other external management tools.
This provides rapid and agile development of your database schema.</p>
</div>
<div class="paragraph">
<p>Once completed, the Operator can be told to synchronize data topology.
This will poll Couchbase for the full data-topology&#8201;&#8212;&#8201;including buckets, scopes and collections&#8201;&#8212;&#8201;then mirror this configuration as Kubernetes-native custom resources.
The user can then poll for completion before finally setting the Couchbase cluster to manage buckets.
After this point, any manual modifications to the data topology will be reverted by the Operator as per usual.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As this feature is completely controlled by the Operator, there are a number of things to be aware of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The Operator will never modify user managed custom resources (e.g. <code>CouchbaseCluster</code>, <code>CouchbaseBucket</code>, etc).
These resources are intended solely for management by users&#8201;&#8212;&#8201;either manually, or through life-cycle managers.
To modify a resource specification would be to alter the managing entity&#8217;s original intent, and is not allowed in Kubernetes.
Operator modifications would also be reverted by any automated life-cycle manager.</p>
</li>
<li>
<p>The Operator will never delete user managed custom resources.
Like modification, deletion may go against the user&#8217;s intent, or be reverted by a life-cycle manager.
It also may result in accidental data loss.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="using-data-topology-synchronization"><a class="anchor" href="#using-data-topology-synchronization"></a>Using Data Topology Synchronization</h3>
<div class="paragraph">
<p>Throughout this example, the Couchbase cluster being referred to is called <code>my-cluster</code>.
You will need to change this to your specific cluster name.</p>
</div>
<div class="sect3">
<h4 id="preparation"><a class="anchor" href="#preparation"></a>Preparation</h4>
<div class="paragraph">
<p>The first thing that needs to be done is to clear any old resources out of the way.
If you do not have any existing <code>CouchbaseBucket</code>, <code>CouchbaseScope</code>, etc. resources, and buckets are not managed (<a href="resource/couchbasecluster.html#couchbaseclusters-spec-buckets-managed" class="xref page"><code>couchbaseclusters.spec.buckets.managed</code></a> is <code>false</code>, or undefined), then skip to the next section.</p>
</div>
<div class="paragraph">
<p>First, you need to disable bucket management, so existing configuration is not deleted once backing resources are removed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl patch couchbasecluster my-cluster --type=merge -p '{"spec":{"buckets":{"managed":false}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, remove any resources that may conflict with those the Operator will generate.
An example of manually clearing out resources could look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ for i in couchbasebuckets \
    couchbaseephemeralbuckets \
    couchbasememcachedbuckets \
    couchbasescopes \
    couchbasescopegroups \
    couchbasecollections \
    couchbasecollectiongroups
  do
    kubectl delete $i --all
  done</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command deletes all resources in the namespace that will be affected by a synchronization operation.
You can replace <code>--all</code> with a label, or field, selector if you wish to be more selective, especially in the case where multiple Couchbase clusters are running in the same namespace.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Data topology resources can be <a href="concept-label-selection.html" class="xref page">shared between clusters</a>.
If they are shared, then deletion may affect another&#8201;&#8212;&#8201;unrelated&#8201;&#8212;&#8201;cluster and result in data loss.
For this reason we recommend only ever deploying one Couchbase cluster per namespace.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="synchronizing"><a class="anchor" href="#synchronizing"></a>Synchronizing</h4>
<div class="paragraph">
<p>Once you have manually updated the data topology to how you want it, we can begin synchronizing it so it can be managed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because multiple Couchbase clusters can run in the same namespace, there is a danger that any resource created by synchronization may be erroneously picked up by another cluster.
For this reason, the Operator enforces the use of a label selector to generate and select buckets for inclusion on the cluster to be synchronized.
It is your responsibility to ensure any other clusters in this namespace have a unique bucket label selector that will not be affected by this synchronization operation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Synchronization is triggered by first setting a label selector, then triggering the operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl patch couchbasecluster my-cluster --type merge -p '{"spec":{"buckets":{"selector":{"matchLabels":{"foo":"bar"}}}}}'
$ kubectl patch couchbasecluster my-cluster --type merge -p '{"spec":{"buckets":{"synchronize":true}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The synchronization operation proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Couchbase server is polled for all buckets, scopes and collections.</p>
</li>
<li>
<p>Kubernetes resources are generated for those Couchbase resources.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Buckets are labeled as defined by the provided label selector, therefore they should be considered by this cluster only.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Kubernetes resources are created and persisted.</p>
</li>
<li>
<p>The Operator reports the status in the cluster conditions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To check for completion status, you can wait until the condition is reported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl wait --for=condition=Synchronized couchbasecluster/my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then check whether or not the synchronization succeeded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe couchbasecluster/my-cluster | grep Synchronized -B 5
    Last Transition Time: 2022-01-14T10:33:25Z
    Last Update Time:     2022-01-14T10:33:25Z
    Message:              Data topology synchronized and ready to be managed
    Reason:               SynchronizationComplete
    Status:               True
    Type:                 Synchronized</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You must ensure synchronization has completed successfully before switching to managed mode.
Failure to do so may result in backing resources not being created, and data loss.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Once synchronization has been triggered, you should not make any more manual adjustments to the data topology.
Doing so may result in a conflict between what is expected and what has already been generated and committed.
If you do encounter a conflict, then restart the process from the <a href="#preparation">Preparation</a> stage to remove the conflicting resource.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Unlike save and restore, synchronization does not optimize the data topology Kubernetes resources.
In a worst case scenario, where 1000&#8217;s of scopes and collections are in use, then you can expect synchronization to take several minutes due to the throttling of requests to the Kubernetes API to ensure fair use.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="managing-synchronized-resources"><a class="anchor" href="#managing-synchronized-resources"></a>Managing Synchronized Resources</h4>
<div class="paragraph">
<p>Once you have confirmed synchronization has completed successfully, you can switch the cluster&#8217;s bucket management on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl patch couchbasecluster my-cluster --type=merge -p '{"spec":{"buckets":{"synchronize":false,"managed":true}}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>From this point onward, any managed resources that are deleted or modified manually will be recovered, and any additional resources that are added will be deleted, as per the usual operation of the Operator.</p>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
