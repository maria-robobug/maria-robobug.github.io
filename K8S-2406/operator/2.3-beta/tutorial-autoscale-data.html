<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Auto-scaling the Couchbase Data Service | Couchbase Docs (Local)</title>
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3-beta">
<meta name="page-url" content="/operator/2.3-beta/tutorial-autoscale-data.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/tutorial-autoscale-data.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Tutorials</li>
<li class="crumb">Autoscaling</li>
<li class="crumb"><a href="tutorial-autoscale-data.html">Autoscaling Couchbase Data Service</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Auto-scaling the Couchbase Data Service</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Learn how to configure auto-scaling for Data Service nodes using the Autonomous Operator.
</blockquote>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tutorials are accurate at the time of writing but rely heavily on third party software.
Tutorials are provided to demonstrate how a particular problem may be solved.
Use of third party software is not supported by Couchbase.
For further help in the event of a problem, contact the relevant software maintainer.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial you&#8217;ll learn how to use the Autonomous Operator to automatically scale the Couchbase Data Service in order to maintain a target memory utilization threshold for an <a href="../../server/7.1/learn/buckets-memory-and-storage/buckets.html" class="xref page">Ephemeral bucket</a>.
You&#8217;ll also learn more about how the Kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">Horizontal Pod Autoscaler</a> (HPA) initiates a request to scale the Data Service in order to maintain desired thresholds.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="before-you-begin"><a class="anchor" href="#before-you-begin"></a>Before You Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before you begin this tutorial, you&#8217;ll need to set up a few things first:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You&#8217;ll need a Kubernetes cluster with at least seven available worker nodes.</p>
<div class="ulist">
<ul>
<li>
<p>Worker nodes should have 4 vCPU and 16 GiB memory in order to exhibit the expected auto-scaling behavior that you&#8217;ll be initiating later on in this tutorial.</p>
</li>
</ul>
</div>
</li>
<li>
<p>You&#8217;ll need <a href="https://helm.sh/docs/intro/install/">Helm version 3.1</a> or higher for installing the necessary dependencies (e.g. the Autonomous Operator, the Couchbase cluster, etc.)</p>
<div class="ulist">
<ul>
<li>
<p>Once you have Helm installed, you&#8217;ll need to add the Couchbase chart repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm repo add couchbase https://couchbase-partners.github.io/helm-charts/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then make sure to update the repository index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm repo update</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-couchbase-cluster-deployment"><a class="anchor" href="#create-the-couchbase-cluster-deployment"></a>Create the Couchbase Cluster Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first thing we&#8217;re going to do is set up our Couchbase deployment.
To speed up the process, we&#8217;ll be using the Couchbase Helm chart to conveniently install a Couchbase cluster that has auto-scaling enabled for the nodes running the Data Service.</p>
</div>
<div class="paragraph">
<p>Run the following command to create a file with the necessary override values for the Couchbase chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cat &lt;&lt; EOF &gt; autoscale_values.yaml
---
cluster:
  cluster:
    dataServiceMemoryQuota: 4Gi
    indexServiceMemoryQuota: 6Gi
  monitoring:
    prometheus:
      enabled: true
      image: couchbase/exporter:1.0.5 <i class="conum" data-value="1"></i><b>(1)</b>
  autoscaleStabilizationPeriod: 0s <i class="conum" data-value="2"></i><b>(2)</b>
  name: scale-couchbase-cluster
  servers:
    default:
      autoscaleEnabled: true <i class="conum" data-value="3"></i><b>(3)</b>
      size: 2
      services:
        - data
      resources:
        limits:
          cpu: 3
          memory: 12Gi
        requests:
          cpu: 3
          memory: 12Gi
    query:
      size: 1
      services:
        - index
        - query
      resources:
        limits:
          cpu: 3
          memory: 12Gi
        requests:
          cpu: 3
          memory: 12Gi
users:
  developer:
    password: password
    authDomain: local
    roles:
      - name: admin

buckets:
  default:
    name: travel-sample
    kind: CouchbaseEphemeralBucket <i class="conum" data-value="4"></i><b>(4)</b>
    evictionPolicy: noEviction
    memoryQuota: 1Gi <i class="conum" data-value="5"></i><b>(5)</b>
EOF</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Deploying the <a href="howto-prometheus.html" class="xref page">Couchbase Prometheus Exporter</a> will allow us to start collecting Couchbase metrics.
Later on in this tutorial we&#8217;ll be passing Couchbase metrics to the Kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics" target="_blank" rel="noopener">custom metrics API</a>, which will allow them to be monitored by the HPA.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-autoscalestabilizationperiod" class="xref page"><code>couchbaseclusters.spec.autoscaleStabilizationPeriod</code></a>: Setting this field to <code>0s</code> serves two purposes: 1.) It disables additional auto-scaling while the cluster is rebalancing; and 2.) it re-enables auto-scaling immediately after rebalance is complete, without any additional delay to allow for cluster stabilization.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The reason that no additional delay is required in this case is because memory metrics for the Data Service are relatively stable after rebalance is complete.
However, please refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance about what values you should use in production.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a>: Setting this field to <code>true</code> enables auto-scaling for the server class that contains the Data Service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We&#8217;re going to create an Ephemeral bucket in order to demonstrate the benefits of auto-scaling in situations when persisting to disk isn&#8217;t an option.
Please refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional information about how the bucket type affects auto-scaling behavior when scaling the Data Service based on bucket memory utilization.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We&#8217;re setting the bucket memory quota relatively low (<code>1Gi</code>) so that we can more quickly and easily induce auto-scaling.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, install the Couchbase chart, making sure to specify the values override file we just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm upgrade --install -f autoscale_values.yaml scale couchbase/couchbase-operator</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Couchbase chart deploys the Autonomous Operator by default.
If you already have the Autonomous Operator deployed in the current namespace, then you&#8217;ll need to specify additional overrides during chart installation so that only the Couchbase cluster is deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm upgrade --install -f autoscale_values.yaml --set install.couchbaseOperator=false,install.admissionController=false scale couchbase/couchbase-operator</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="verify-the-installation"><a class="anchor" href="#verify-the-installation"></a>Verify the Installation</h3>
<div class="paragraph">
<p>The configuration we&#8217;re using calls for a three-node Couchbase cluster (two <code>default</code> nodes and one <code>query</code> node), which will take a few minutes to be created.
You can run the following command to verify the deployment status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe couchbasecluster scale-couchbase-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the console output, you should check for the events that signal the creation of the four nodes in the Couchbase cluster, as well as the creation of a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource for the <code>default</code> server class configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Events:
  Type    Reason                  Age   From  Message
  ----    ------                  ----  ----  -------
  Normal  EventNewMemberAdded     22m         New member scale-couchbase-cluster-0003 added to cluster
  ...
  Normal  EventAutoscalerCreated  22m         Autoscaler for config `default` added</pre>
</div>
</div>
<div class="paragraph">
<p>The Autonomous Operator automatically creates a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource for each server class configuration that has <a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a> set to <code>true</code>.
The Operator also keeps the size of the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource in sync with the size of its associated server class configuration.</p>
</div>
<div class="paragraph">
<p>Run the following command to verify that the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource exists and matches the size of its associated server configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get couchbaseautoscalers</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                               SIZE   SERVERS
default.scale-couchbase-cluster    2      default <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="paragraph">
<p>In the console output, you&#8217;ll see:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>NAME</code>: The Autonomous Operator creates <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resources with the name format <code><em>&lt;server-class&gt;</em>.<em>&lt;cluster-name&gt;</em></code>.
Considering that we enabled auto-scaling for the <code>default</code> server class configuration, and the name of our cluster is <code>scale-couchbase-cluster</code>, we can determine that the name of the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource created by the Autonomous Operator will be <code>default.scale-couchbase-cluster</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>SIZE</code>: This is the current number of Couchbase nodes that the Autonomous Operator is maintaining for the <code>default</code> server class.
Considering that we set <code>servers.default.size</code> to <code>2</code> in our cluster configuration, and because the cluster doesn&#8217;t yet have the ability to automatically scale, we can expect that the <code>SIZE</code> listed here will be <code>2</code>.
Once we create an HPA for the <code>default</code> server class, and the number of <code>default</code> nodes begins to scale, the <code>SIZE</code> will update to reflect the number of nodes currently being maintained.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="accessing-the-couchbase-web-console"><a class="anchor" href="#accessing-the-couchbase-web-console"></a>Accessing the Couchbase Web Console</h3>
<div class="paragraph">
<p>Having access to the Couchbase Web Console can make it easier to verify the result of certain actions in this tutorial.
To gain access, start by checking the <code>status</code> of the Helm chart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm status scale</code></pre>
</div>
</div>
<div class="paragraph">
<p>The console output conveniently contains the necessary details for accessing the Couchbase Web Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>== Connect to Admin console
   kubectl port-forward --namespace default scale-couchbase-cluster-0000 8091:8091

   # open http://localhost:8091
   username: Administrator
   password: &lt;redacted&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code>kubectl port-forward</code> command to forward the necessary port to the listed pod.
Once the port has been forwarded, you can access the Couchbase Web Console at <code><a href="http://localhost:8091" class="bare">http://localhost:8091</a></code>.
Log in using the listed username and password.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-the-monitoring-stack"><a class="anchor" href="#install-the-monitoring-stack"></a>Install the Monitoring Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When we created our Couchbase deployment, we also installed the <a href="howto-prometheus.html" class="xref page">Couchbase Prometheus Exporter</a> to collect Couchbase-specific metrics.
We now need to pass these metrics to the Kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics" target="_blank" rel="noopener">custom metrics API</a> so that the metrics can be monitored by the HPA.
To do this, we&#8217;ll need deploy an "adapter" API server.</p>
</div>
<div class="paragraph">
<p>To make this process easier, we can use the <code>couchbase-monitor-stack</code> Helm chart to conveniently install the <a href="https://github.com/kubernetes-sigs/prometheus-adapter" target="_blank" rel="noopener">Prometheus Adapter</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm upgrade --install --set clusterName=scale-couchbase-cluster monitor couchbase/couchbase-monitor-stack <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>clusterName</code> is the name of the <code>CouchbaseCluster</code> resource that was created when we <a href="#create-the-couchbase-cluster-deployment">deployed the Couchbase cluster</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verify-monitoring"><a class="anchor" href="#verify-monitoring"></a>Verify Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Verify that Couchbase metrics are being collected by the custom metrics API server.
The following command will return the value of the <code>cbbucketinfo_basic_quota_user_percent</code> (bucket memory utilization) metric being collected for the <code>travel-sample</code> bucket:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get --raw="/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/cbbucketinfo_basic_quota_user_percent"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>{"kind":"MetricValueList",
..."metricName":"cbbucketinfo_basic_quota_user_percent","value":"1385m"} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example output, <strong>~1%</strong> of the bucket memory quota is currently in use.
(The value is reported on a scale of 1000.)</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This validation is also helpful for debugging as the HPA takes the average of this value when making auto-scaling decisions.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-a-horizontal-pod-autoscaler"><a class="anchor" href="#create-a-horizontal-pod-autoscaler"></a>Create a Horizontal Pod Autoscaler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve confirmed that metrics data are being collected for bucket memory quota, we can create a <code>HorizontalPodAutoscaler</code> resource that targets this metric.
For this tutorial, we&#8217;ll be configuring an HPA to scale the number of Couchbase <code>default</code> nodes in our cluster when the memory utilization for the <code>travel-sample</code> bucket exceeds 70% of its <code>1Gi</code> quota.
(When memory utilization exceeds 70%, additional <code>default</code> nodes will be added, and when usage falls below 70% then the HPA will consider scaling down to reduce overhead.)</p>
</div>
<div class="paragraph">
<p>Run the following command to create a <code>HorizontalPodAutoscaler</code> resource that will take action when the memory utilization for the <code>travel-sample</code> bucket exceeds 70% of its quota:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cat &lt;&lt; EOF | kubectl apply -f -
---
kind: HorizontalPodAutoscaler
apiVersion: autoscaling/v2beta2
metadata:
  name: data-hpa
spec:
  scaleTargetRef:
    apiVersion: couchbase.com/v2
    kind: CouchbaseAutoscaler <i class="conum" data-value="1"></i><b>(1)</b>
    name: default.scale-couchbase-cluster <i class="conum" data-value="2"></i><b>(2)</b>
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
      - type: Pods
        value: 1
        periodSeconds: 15
    scaleDown:
      stabilizationWindowSeconds: 300
  minReplicas: 2 <i class="conum" data-value="3"></i><b>(3)</b>
  maxReplicas: 6 <i class="conum" data-value="4"></i><b>(4)</b>
  metrics:
  - type: Pods
    pods:
      metric:
        name: cbbucketinfo_basic_quota_user_percent <i class="conum" data-value="5"></i><b>(5)</b>
      target:
        type: AverageValue
        averageValue: 70 <i class="conum" data-value="6"></i><b>(6)</b>
EOF</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>scaleTargetRef.kind</code>: This field must be set to <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a>, which is the <code>kind</code> of custom resource that gets automatically created by the Autonomous Operator when you enable auto-scaling for a particular server class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>scaleTargetRef.name</code>: This field needs to reference the <code>name</code> of the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource.
Since the Autonomous Operator creates <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resources with the name format <code><em>&lt;server-class&gt;</em>.<em>&lt;cluster-name&gt;</em></code>, the name we&#8217;ll need to specify is <code>default.scale-couchbase-cluster</code>.
<div class="openblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As described previously in the <a href="#verify-the-installation">Verify the Installation</a> section, a quick way to view the existing <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resources (and their names) is to run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get couchbaseautoscalers</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>minReplicas</code>: This field sets the minimum number of Couchbase nodes for the specified server class.
Here, we&#8217;ve set the minimum number of <code>default</code> nodes to <code>2</code>.
This means that the number of <code>default</code> nodes will never be down-scaled to fewer than two nodes, even if the HPA detects that the target metric is relatively below the target value.
<div class="paragraph">
<p>Setting <code>minReplicas</code> is important for maintaining service availability.
Refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance on setting this value in production environments.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>maxReplicas</code>: This field sets the maximum number of Couchbase nodes for the specified server class.
It cannot be set to a value lower than what is defined for <code>minReplicas</code>.
Here, we&#8217;ve set the maximum number of <code>default</code> nodes to <code>6</code>.
This means that number of <code>default</code> nodes will never be up-scaled to more than six nodes, even if the HPA detects that the target metric is still relatively above the target value.
<div class="paragraph">
<p>Setting a value for <code>maxReplicas</code> is required because it provides important protection against runaway scaling events.
Refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance on setting this value in production environments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="#before-you-begin">prerequisites</a> for this tutorial state that seven Kubernetes worker nodes are required.
So far we&#8217;re currently using three worker nodes for our Couchbase cluster (two <code>default</code> nodes and one <code>query</code> node).
By setting <code>maxReplicas</code> to <code>6</code>, we&#8217;re allowing the <code>default</code> server class to scale up to an additional four nodes if necessary, thus potentially requiring up to seven worker nodes for our entire setup.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>metrics.pods.metric.name</code>: The name of the target metric that will be monitored by the HPA for the purposes of auto-scaling.
Here, we&#8217;ve specified <code>cbbucketinfo_basic_quota_user_percent</code> as the metric that will be used to scale the number <code>default</code> nodes.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>metrics.pods.target.type</code>: Specifying the <code>AverageValue</code> type means that the metric will be averaged across all of the pods.
Here, by setting a value of <code>70</code>, the HPA will scale the number of <code>default</code> nodes when the average bucket memory utilization across all <code>default</code> pods exceeds 70%.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Details about how sizing decisions are made are discussed in <a href="concept-couchbase-autoscaling.html" class="xref page">Couchbase Cluster Auto-scaling</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="verify-horizontalpodautoscaler-status"><a class="anchor" href="#verify-horizontalpodautoscaler-status"></a>Verify <code>HorizontalPodAutoscaler</code> Status</h3>
<div class="paragraph">
<p>Now that we&#8217;ve created the <code>HorizontalPodAutoscaler</code> resource, the HPA will begin to monitor the target metric and report that the initial size (number) of <code>default</code> nodes are within the desired range.
Run the following command to print these details to the console output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe hpa data-hpa</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Metrics:                                               ( current / target )
  "cbbucketinfo_basic_quota_user_percent" on pods:  2771m / 70 <i class="conum" data-value="1"></i><b>(1)</b>
Min replicas:                         2
Max replicas:                         6
CouchbaseAutoscaler pods:             2 current / 2 desired  <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we see that the current bucket memory utilization is <strong>~2%</strong> (again, on a scale of 1000) out of the <code>70</code> percent target.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we see that there are currently <code>3</code> <code>default</code> nodes in the cluster, and <code>3</code> are desired to maintain the current target.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-the-auto-scaling-behavior"><a class="anchor" href="#test-the-auto-scaling-behavior"></a>Test the Auto-scaling Behavior</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point, we&#8217;ve completed all the necessary steps to configure our cluster deployment to automatically scale the number of <code>default</code> nodes.
If the average bucket memory utilization across current <code>default</code> nodes exceeds 70%, an additional <code>default</code> node will be added to the cluster.</p>
</div>
<div class="paragraph">
<p>However, we should test our configuration to be sure that <code>default</code> nodes will automatically scale as expected.
To do this, we&#8217;ll be attempting to induce auto-scaling behavior by loading enough data into the <code>travel-sample</code> bucket to exceed 70% of its memory quota.</p>
</div>
<div class="sect2">
<h3 id="load-data"><a class="anchor" href="#load-data"></a>Load Data</h3>
<div class="paragraph">
<p>Let&#8217;s start loading some data into <code>travel-sample</code> bucket to increase memory usage towards the auto-scaling threshold.
Run the following command to create a Kubernetes Job that runs the Couchbase <a href="#server:cli:cbtools/cbworkloadgen.adoc" class="xref unresolved"><code>cbworkloadgen</code></a> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cat &lt;&lt; EOF | kubectl apply -f -
---
apiVersion: batch/v1
kind: Job
metadata:
  name: cb-workload-gen
spec:
  template:
    spec:
      containers:
      - name: doc-loader
        image: couchbase/server:7.0.0
        command: ["/opt/couchbase/bin/cbworkloadgen", "-n","scale-couchbase-cluster-0000.scale-couchbase-cluster.default.svc:8091", "-u", "developer", "-p", "password", "-t", "4", "-r", ".7", "-j", "-s", "1024","--prefix=wrote-a","-i", "2000000", "-b", "travel-sample"]
      restartPolicy: Never
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the Couchbase Web Console that we <a href="#accessing-the-couchbase-web-console">accessed previously</a> to ensure that the data set is being loaded.</p>
</div>
</div>
<div class="sect2">
<h3 id="verify-auto-scaling"><a class="anchor" href="#verify-auto-scaling"></a>Verify Auto-scaling</h3>
<div class="paragraph">
<p>Memory utilization of the <code>travel-sample</code> bucket should increase as <a href="#server:cli:cbtools/cbworkloadgen.adoc" class="xref unresolved"><code>cbworkloadgen</code></a> loads documents.
In the Couchbase Web Console, you should see the <a href="../../server/7.1/manage/manage-ui/manage-ui.html#console-buckets" class="xref page">RAM used/quota</a> increasing for the <code>travel-sample</code> bucket as <code>cbworkloadgen</code> loads documents.</p>
</div>
<div class="paragraph">
<p>The workload generator will create 2 M documents at 1 KB each.
Auto-scaling should occur once memory usage reaches just above 1.4 GB since there are two <code>default</code> nodes providing <code>1Gi</code> memory <em>each</em> to the <code>travel-sample</code> bucket.</p>
</div>
<div class="paragraph">
<p>Run the following command to view the behavior of the HPA as it monitors the bucket memory utilization as it approaches the target metric:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe hpa data-hpa</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should expect output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
Reference:                                             CouchbaseAutoscaler/default.scale-couchbase-cluster
Metrics:                                               ( current / target )
  "cbbucketinfo_basic_quota_user_percent" on pods:  81930m / 70 <i class="conum" data-value="1"></i><b>(1)</b>
Events:
  Type    Reason             Age   From                       Message
  ----    ------             ----  ----                       -------
  Normal  SuccessfulRescale  21s   horizontal-pod-autoscaler  New size: 3; reason: pods metric cbbucketinfo_basic_quota_user_percent above target <i class="conum" data-value="2"></i><b>(2)</b>
  Normal  SuccessfulRescale  48s    horizontal-pod-autoscaler  New size: 4; reason: pods metric cbbucketinfo_basic_quota_user_percent above target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The HPA has detected <strong>81%</strong> memory utilization.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The number of <code>default</code> nodes has been scaled from <strong>2</strong> to <strong>3</strong>.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#algorithm-details">scaling algorithm</a> was applied by the HPA to determine the desired replicas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]
              3 = ceil[       2        * (      91.0        /     70.0            )]</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleaning-up"><a class="anchor" href="#cleaning-up"></a>Cleaning up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Running the commands in this section will uninstall all of the resources that were created during the course of this tutorial.</p>
</div>
<div class="paragraph">
<p>Remove workload jobs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl delete jobs cb-workload-gen</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the HPA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl delete hpa data-hpa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Uninstall the monitoring stack by deleting the Helm release:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm delete monitor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Uninstall both the Autonomous Operator and Couchbase cluster by deleting the Helm release:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ helm delete scale</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will very likely need to do some experimentation before settling on a particular metric and target value that makes sense for your workload objectives.
Refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance when determining the best target value for bucket memory utilization when scaling Data Service nodes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>Further Reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Concepts: <a href="concept-couchbase-autoscaling.html" class="xref page">Couchbase Cluster Auto-scaling</a></p>
</li>
<li>
<p>Best Practices: <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a></p>
</li>
<li>
<p>Reference: <a href="resource/couchbaseautoscaler.html" class="xref page">CouchbaseAutoscaler Resource</a></p>
</li>
<li>
<p>Reference: <a href="reference-couchbasecluster-events.html#autoscaling-lifecycle" class="xref page">Autoscaling Lifecycle Events</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3-beta"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
