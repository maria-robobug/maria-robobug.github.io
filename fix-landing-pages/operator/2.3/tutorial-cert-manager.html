<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Using a Certificate Manager | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/operator/2.3/tutorial-cert-manager.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/tutorial-cert-manager.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/tutorial-cert-manager.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Tutorials</li>
<li class="crumb">TLS</li>
<li class="crumb"><a href="tutorial-cert-manager.html">Using a Certificate Manager</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Using a Certificate Manager</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
This tutorial demonstrates how to set up a certificate manager (<a href="https://cert-manager.io/" target="_blank" rel="noopener">cert-manager</a>) to be used with the Operator dynamic admission controller (DAC) and managed Couchbase clusters.
Certificate managers like cert-manager provide native Kubernetes support for TLS certificate generation and rotation.
</blockquote>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Tutorials are accurate at the time of writing but rely heavily on third party software.
Tutorials are provided to demonstrate how a particular problem may be solved.
Use of third party software is not supported by Couchbase.
For further help in the event of a problem, contact the relevant software maintainer.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-cert-manager"><a class="anchor" href="#what-is-cert-manager"></a>What is cert-manager?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://cert-manager.io/" target="_blank" rel="noopener">cert-manager</a> is a Kubernetes controller&#8201;&#8212;&#8201;much like the Autonomous Operator&#8201;&#8212;&#8201;that defines Kubernetes resource types that represent X.509 primitives.
The key resources we will examine in further depth are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Issuer</dt>
<dd>
<p>This type represents a certificate issuer.
This may be a root certificate authority (CA), or a signing certificate (intermediate CA).
It is your responsibility to provide the certificate and private key for this resource.</p>
</dd>
<dt class="hdlist1">Certificate</dt>
<dd>
<p>This type represents a certificate and private key pair.
It allows the specification of the private key size and algorithm.
If allows the specification of the certificate name, lifetime, usages, and any subject alternative addresses (SANs).
A <code>Certificate</code> <em>references</em>, and <em>is signed by</em>, an <code>Issuer</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Certificates are initially issued by cert-manager, then at a defined time before the expiry, are automatically rotated.</p>
</div>
<div class="paragraph">
<p>Certificates are stored in a Kubernetes <code>Secret</code> resource, broadly similar to the standard <code>kubernetes.io/tls</code> secret type.
The one major difference is that, along with <code>tls.crt</code> and <code>tls.key</code> secret data, there is also a <code>ca.crt</code> copied in from the <code>Issuer</code>.</p>
</div>
<div class="paragraph">
<p>(You may notice that this has heavily influenced the design of the Autonomous Operator&#8217;s TLS interface.)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="before-we-begin"><a class="anchor" href="#before-we-begin"></a>Before We Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before continuing with this tutorial, please ensure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You have installed cert-manager.
Follow the official installation guides at <a href="https://cert-manager.io/docs/installation/" target="_blank" rel="noopener"><code>cert-manager.io</code></a>.</p>
</li>
<li>
<p>You have installed Autonomous Operator 2.2 or higher.
This tutorial assumes that the installed resources are present, and also leverages the <a href="tools/cao.html" class="xref page"><code>cao</code></a> command line tool that comes with the Autonomous Operator binary package.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can actually integrate/perform the steps in this tutorial as part of the process of installing the Autonomous Operator.
However, for the sake of making the tutorial more straightforward, it is assumed that you&#8217;ve already performed a basic <a href="install-kubernetes.html" class="xref page">installation</a> of the Autonomous Operator.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Another thing to note is that all of the commands in this tutorial are run from the same, default, namespace.
cert-manager runs cluster scoped, and can see Issuers and Certificates in any namespace, so you can use any namespace you desire.
Before you begin the tutorial, make sure to configure your Kubernetes context to point to the namespace where you deploy Couchbase resources, or ensure you use the <code>--namespace</code> configuration flag with the given commands.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-common-configuration"><a class="anchor" href="#creating-a-common-configuration"></a>Creating a Common Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The best way to explain cert-manager is by example.
The following subsections describe how to create a common configuration that will be used to sign certificates for both the dynamic admission controller (DAC) and our Couchbase clusters.</p>
</div>
<div class="sect2">
<h3 id="create-a-root-ca"><a class="anchor" href="#create-a-root-ca"></a>Create a Root CA</h3>
<div class="paragraph">
<p>First, we need to create a root CA.
The following commands demonstrate how to create a root CA using <code>easy-rsa</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ git clone https://github.com/OpenVPN/easy-rsa
$ cd easy-rsa/easyrsa3
$ ./easyrsa init-pki
$ ./easyrsa build-ca nopass
$ cat pki/private/ca.key | base64 -w 0 <i class="conum" data-value="1"></i><b>(1)</b>
$ cat pki/ca.crt | base64 -w 0 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The output of this command is the encoded CA key, and will be used in the next step.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The output of this command is the encoded CA certificate, and will be used in the next step.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="create-an-issuer"><a class="anchor" href="#create-an-issuer"></a>Create an Issuer</h3>
<div class="paragraph">
<p>Next, we&#8217;ll create the CA&#8217;s <code>Secret</code> and <code>Issuer</code>.
Start by creating two files&#8201;&#8212;&#8201;<code>ca-secret.yaml</code> and <code>ca-issuer.yaml</code>&#8201;&#8212;&#8201;with the following configurations:</p>
</div>
<div class="listingblock">
<div class="title">ca-secret.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: ca
data:
  tls.key: LS0tLS1C... <i class="conum" data-value="1"></i><b>(1)</b>
  tls.crt: LS0tLS1C... <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the CA key from the previous step; textual representation has been shortened for brevity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the CA certificate from the previous step; textual representation has been shortened for brevity.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">ca-issuer.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: ca <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  ca:
    secretName: ca <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the issuer name; take a note of it, as it will be referred to by <code>Certificate</code> resources and used to sign certificates.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is a reference to the CA secret we have just created containing the CA certificate and key pair.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following commands to create the CA&#8217;s <code>Secret</code> and <code>Issuer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f ca-secret.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f ca-issuer.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-cert-manager-with-the-dac"><a class="anchor" href="#using-cert-manager-with-the-dac"></a>Using cert-manager with the DAC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The DAC <a href="concept-operator.html#dynamic-admission-controller" class="xref page">component</a> of the Autonomous Operator distribution has built-in certificate rotation detection and handling.
This makes it a perfect candidate for automation.</p>
</div>
<div class="sect2">
<h3 id="uninstall-the-existing-dac"><a class="anchor" href="#uninstall-the-existing-dac"></a>Uninstall the Existing DAC</h3>
<div class="paragraph">
<p>As mentioned in the <a href="#before-we-begin">prerequisites</a> section, this tutorial assumes that you&#8217;ve already performed a basic <a href="install-kubernetes.html" class="xref page">installation</a> of the Autonomous Operator.
As part of the installation, you would have also installed the DAC.
Before we can continue with the tutorial, we need to <em>uninstall</em> the DAC.
(Don&#8217;t worry, we&#8217;ll be re-installing it soon.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao delete admission</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-the-dac-certificate"><a class="anchor" href="#create-the-dac-certificate"></a>Create the DAC Certificate</h3>
<div class="paragraph">
<p>We need to create a <code>Certificate</code> resource to issue and rotate the DAC certificate and key.
Paste the following configuration into your editor of choice and save the file as <code>admission-certificate-resource.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: couchbase-operator-admission
spec:
  secretName: couchbase-operator-admission <i class="conum" data-value="1"></i><b>(1)</b>
  duration: 6h <i class="conum" data-value="2"></i><b>(2)</b>
  renewBefore: 1h <i class="conum" data-value="3"></i><b>(3)</b>
  commonName: couchbase-operator-admission
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS8
    size: 2048
  usages:
  - server auth <i class="conum" data-value="4"></i><b>(4)</b>
  dnsNames:
  - couchbase-operator-admission.default.svc <i class="conum" data-value="5"></i><b>(5)</b>
  issuerRef:
    group: cert-manager.io
    kind: Issuer
    name: ca <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the secret that will be generated containing the TLS certificate and key.
The name used in this example is the same as the default one created by <a href="tools/cao.html" class="xref page"><code>cao</code></a> during standard <a href="install-kubernetes.html" class="xref page">installation</a>, so we&#8217;ll just reuse it to make integration simpler.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The certificate will be issued immediately and will be valid for 6 hours.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The certificate will be reissued (rotated) 1 hour before the certificate expiration time.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The certificate can be used as server authentication&#8201;&#8212;&#8201;the DAC is a HTTPS server.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The certificate needs a subject alternative name that matches the network name used to connect to it.
This name is comprised of <code><em>&lt;service-name&gt;</em>.<em>&lt;namespace&gt;</em>.svc</code>.
The <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool usually handles this for you, however, as TLS generation is delegated to a 3rd party, we need to be aware of it.
Again, like the secret name, this is the default service name created by <a href="tools/cao.html" class="xref page"><code>cao</code></a>, so we&#8217;ll just keep this as is.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The issuer, <code>ca</code>, refers to the CA we defined in the section <a href="#creating-a-common-configuration">Creating a Common Configuration</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command to create the <code>Certificate</code> resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f admission-certificate-resource.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This command will not succeed if the DAC is already installed.
Ensure that you&#8217;ve followed the instructions in the section <a href="#uninstall-the-existing-dac">Uninstall the Existing DAC</a> before running this command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the following command to check the status of the resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get certificates</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it was created/applied properly, the output should look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                           READY   SECRET                         AGE
couchbase-operator-admission   True    couchbase-operator-admission   4s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update-the-dac-configuration-settings"><a class="anchor" href="#update-the-dac-configuration-settings"></a>Update the DAC Configuration Settings</h3>
<div class="paragraph">
<p>When you install the Autonomous Operator, the <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool automatically creates a default TLS configuration for you.
However, we don&#8217;t have to worry about this default configuration because we removed it entirely when we uninstalled the DAC in the section <a href="#uninstall-the-existing-dac">Uninstall the Existing DAC</a>.
Therefore, in this next step, we will generate a brand new DAC configuration, modify it to make use of our managed certificates, and then submit it to Kubernetes to redeploy the DAC.</p>
</div>
<div class="paragraph">
<p>Start by generating a copy of the default configuration template for the DAC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao generate admission &gt; admission.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <code>admission.yaml</code> with your editor of choice.</p>
</div>
<div class="paragraph">
<p>The first thing we&#8217;re going to do is <em>remove</em> (delete) the <code>Secret</code> resource configuration from this file, as cert-manager is now managing it for us.
The configuration that you need to remove looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
data:
  tls-cert-file: LS0tLS1CRU...
  tls-private-key-file: LS0tLS1CRU...
kind: Secret
metadata:
  annotations:
    config.couchbase.com/version: 2.2.0
  creationTimestamp: null
  name: couchbase-operator-admission</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, locate the <code>ValidatingWebhookConfiguration</code> resource.
This needs to be updated to include the signing CA&#8217;s certificate.
If you recall, when we <a href="#create-an-issuer">created the certificate issuer</a>, we configured its <code>Secret</code> with a <code>tls.crt</code> key.
We simply need to copy this same <code>tls.crt</code> key into each instance of <code>caBundle</code> in the webhook resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  creationTimestamp: null
  name: couchbase-operator-admission
webhooks:
- clientConfig:
    caBundle: LS0tLS1CRU... <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace the existing key with the <code>tls.crt</code> key of the certificate issuer.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now save all of your changes to <code>admission.yaml</code> and exit your editor&#8201;&#8212;&#8201;the configuration is ready to to be submitted to Kubernetes.
Run the following command to deploy the DAC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f admission.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>If all goes well, you can create Couchbase resources, and the DAC will reject any misconfiguration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f example/couchbase-cluster.yaml
couchbasebucket.couchbase.com/default created
Error from server: error when creating "example/couchbase-cluster.yaml": admission webhook "couchbase-operator-admission.default.svc" denied the request: validation failure list:
secret cb-example-auth referenced by spec.security.adminSecret must exist</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you see something similar to the following, it means that the Kubernetes API isn&#8217;t able to validate your server certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f example/couchbase-cluster.yaml
Error from server (InternalError): error when creating "example/couchbase-cluster.yaml": Internal error occurred: failed calling webhook "couchbase-operator-admission.default.svc": Post "https://couchbase-operator-admission.default.svc:443/couchbaseclusters/validate?timeout=10s": x509: certificate signed by unknown authority</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this is the case, check that the correct CA is installed in the webhooks, and ensure that the server certificate issued by cert-manager is valid and verifies against the CA.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-cert-manager-with-a-couchbase-cluster"><a class="anchor" href="#using-cert-manager-with-a-couchbase-cluster"></a>Using cert-manager with a Couchbase Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Autonomous Operator has been capable of rotating Couchbase Server certificates since version 2.0.
With the 2.2 release, we introduced the ability to use new certificate formats, in particular the standard form used by cert-manager.
This allows the database&#8217;s TLS configuration to be specified in code, along with security policies.
The key benefits of using this are 1.) oversight&#8201;&#8212;&#8201;the ability to peer review configuration; and 2.) auditing&#8201;&#8212;&#8201;providing simple, policy driven security constraints.</p>
</div>
<div class="sect2">
<h3 id="create-the-couchbase-server-certificate"><a class="anchor" href="#create-the-couchbase-server-certificate"></a>Create the Couchbase Server Certificate</h3>
<div class="paragraph">
<p>Using our common issuer, we will create a certificate for use with Couchbase Server.
Paste the following configuration into your editor of choice and save the file as <code>server-certificate-resource.yaml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: cb-example
spec:
  secretName: server-tls <i class="conum" data-value="1"></i><b>(1)</b>
  duration: 6h <i class="conum" data-value="2"></i><b>(2)</b>
  renewBefore: 1h <i class="conum" data-value="3"></i><b>(3)</b>
  commonName: couchbase-server
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS8 <i class="conum" data-value="4"></i><b>(4)</b>
    size: 2048
  usages:
    - server auth <i class="conum" data-value="5"></i><b>(5)</b>
  dnsNames: <i class="conum" data-value="6"></i><b>(6)</b>
    - "*.cb-example"
    - "*.cb-example.default"
    - "*.cb-example.default.svc"
    - "*.cb-example.default.svc.cluster.local"
    - "cb-example-srv"
    - "cb-example-srv.default"
    - "cb-example-srv.default.svc"
    - "*.cb-example-srv.default.svc.cluster.local"
    - localhost
  issuerRef:
    name: ca <i class="conum" data-value="7"></i><b>(7)</b>
    group: cert-manager.io
    kind: Issuer</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the secret that will be generated containing the TLS certificate and key.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The certificate will be issued immediately and will be valid for 6 hours.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The certificate will be reissued (rotated) 1 hour before the certificate expiration time.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Couchbase Server only works with PKCS#1 private keys, but, because we have to create a shadow copy of the certificates with hard coded names, we can also translate private keys from one format to another.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The certificate can be used as server authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The certificate needs a set of subject alternative names (SAN) that cover all possible methods of addressing the cluster by clients.
The canonical list of SANs can be found in the <a href="tutorial-tls.html" class="xref page">TLS tutorial</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The issuer, <code>ca</code>, refers to the CA we defined in the section <a href="#creating-a-common-configuration">Creating a Common Configuration</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command to create the <code>Certificate</code> resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f server-certificate-resource.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run the following command to check the status of the resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get certificates</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it was created/applied properly, the output should look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                           READY   SECRET                         AGE
cb-example                     True    server-tls                     10s
couchbase-operator-admission   True    couchbase-operator-admission   32m</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-the-couchbase-cluster"><a class="anchor" href="#create-the-couchbase-cluster"></a>Create the Couchbase Cluster</h3>
<div class="paragraph">
<p>Consuming certificates issued by cert-manager is fairly straightforward.
Using the <code>couchbase-cluster.yaml</code> template from the Autonomous Operator binary package, make the following edits to the <code>CouchbaseCluster</code> custom resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">apiVersion: v1
kind: Secret
metadata:
  name: cb-example-auth
type: Opaque
data:
  username: QWRtaW5pc3RyYXRvcg==
  password: cGFzc3dvcmQ=
---
apiVersion: couchbase.com/v2
kind: CouchbaseBucket
metadata:
  name: default
---
apiVersion: couchbase.com/v2
kind: CouchbaseCluster
metadata:
  name: cb-example
spec:
  image: couchbase/server:6.6.0
  security:
    adminSecret: cb-example-auth
  networking:
    tls:
      secretSource: <i class="conum" data-value="1"></i><b>(1)</b>
        serverSecretName: server-tls <i class="conum" data-value="2"></i><b>(2)</b>
  buckets:
    managed: true
  servers:
    - name: basic
      size: 3
      services:
        - data
        - index
        - query</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>secretSource</code> TLS provider tells the Autonomous Operator that the secrets will be in <code>kubernetes.io/tls</code> format.
This also requires a <code>ca.crt</code> key, which cert-manager provides automatically.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>serverSecretName</code> tells the Autonomous Operator to use the cert-manager issued secret defined in the previous section <a href="#create-the-Couchbase-server-certificate">[create-the-Couchbase-server-certificate]</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command to create the <code>Certificate</code> resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f couchbase-cluster.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run the following command to check the status of the deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get cbc</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the Couchbase cluster was deployed successfully, the output should look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME         VERSION   SIZE   STATUS      UUID                               AGE
cb-example   6.6.0     3      Available   8c531b1cc11680c286d04616cc7a8185   3m31s</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By embracing the <code>kubernetes.io/tls</code> format, the Autonomous Operator is able to draw upon great 3rd-party tools, like cert-manager, that offer simplicity, security, and regulation within your Kubernetes environment.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
