<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Configure Automated Backup and Restore | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/operator/2.3/howto-backup.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/howto-backup.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/howto-backup.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Manage</li>
<li class="crumb">Couchbase Cluster</li>
<li class="crumb">Configure</li>
<li class="crumb"><a href="howto-backup.html">Configure Backup &amp; Restore</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Automated Backup and Restore</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
You can configure the Autonomous Operator to take periodic, automated backups of your Couchbase cluster with the existing functionality provided by <code>cbbackupmgr</code>.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page details how to backup a Couchbase cluster and restore data in the face of disaster.
A conceptual overview of using the Autonomous Operator to backup and restore Couchbase clusters can be found in <a href="concept-backup.html" class="xref page">Couchbase Backup and Restore</a>.</p>
</div>
<div class="paragraph">
<p>The Autonomous Operator supports two of the backup strategies available in <code>cbbackupmgr</code>: <em>Full Only</em> and <em>Full/Incremental</em>.
Complete descriptions and explanations of these strategies can be found in the <a href="#server:backup-restore:cbbackupmgr-strategies.adoc" class="xref unresolved"><code>cbbackupmgr</code> documentation</a>.
The examples on this page assume a backup schedule based on the <em>Full/Incremental</em> strategy for both creating backups and performing restores.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Backup and restore jobs rely on a shared persistent volume claim (PVC) when in use.
On Kubernetes platforms you must specify a value for <a href="resource/couchbasecluster.html#couchbaseclusters-spec-securitycontext" class="xref page"><code>couchbaseclusters.spec.securityContext.fsGroup</code></a> in order for volume permissions to be the same across all jobs.
Red Hat OpenShift is not affected by this constraint.</p>
</div>
<div class="paragraph">
<p>For further information about setting file system groups see the <a href="concept-persistent-volumes.html#using-storage-classes" class="xref page">persistent volume concepts</a> page.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enable-automated-backup"><a class="anchor" href="#enable-automated-backup"></a>Enable Automated Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order for the Autonomous Operator to manage the automated backup of a cluster, the feature must be enabled in the <code>CouchbaseCluster</code> resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase/v2
kind: CouchbaseCluster
spec:
  backup:
    managed: true <i class="conum" data-value="1"></i><b>(1)</b>
    image: couchbase/operator-backup:1.3.0 <i class="conum" data-value="2"></i><b>(2)</b>
    serviceAccountName: couchbase-backup <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only required field to enable automated backup is <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-managed" class="xref page"><code>couchbaseclusters.spec.backup.managed</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-image" class="xref page"><code>couchbaseclusters.spec.backup.image</code></a> field is left unspecified, then it will be automatically populated with the most recent container image that was available when the installed version of the Autonomous Operator was released.
The default image for open source Kubernetes comes from <a href="https://hub.docker.com/r/couchbase/operator-backup" target="_blank" rel="noopener">Docker Hub</a>, and the default image for OpenShift comes from the <a href="https://access.redhat.com/containers/#/vendor/couchbase" target="_blank" rel="noopener">Red Hat Container Catalog</a>.
<div class="paragraph">
<p>When running on Red Hat OpenShift, you will want to modify this to use the Red Hat Container Catalog image.
The image will be something similar to <code>registry.connect.redhat.com/couchbase/operator-backup:1.3.0</code> (you can refer to the catalog for the most recent images).
If image pull secrets are required to access the image, they can be set explicitly with the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-imagepullsecrets" class="xref page"><code>couchbaseclusters.spec.backup.imagePullSecrets</code></a> field or implicitly with a service account specified with the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-serviceaccountname" class="xref page"><code>couchbaseclusters.spec.backup.serviceAccountName</code></a> field.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If left unspecified, <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-serviceaccountname" class="xref page"><code>couchbaseclusters.spec.backup.serviceAccountName</code></a> will default to the value of <code>couchbase-backup</code>.
These Kubernetes resources <strong>must</strong> exist, otherwise backup jobs will not have the required permissions to complete successfully.
This will be covered in the next <a href="#grant-backup-permissions">section</a>.</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="grant-backup-permissions"><a class="anchor" href="#grant-backup-permissions"></a>Grant Backup Permissions</h3>
<div class="paragraph">
<p>Backup Pods need read-only access to Kubernetes resources such as <code>Pods</code>, <code>CronJobs</code>, and <code>Jobs</code>.
They also need write access to Events and the <code>CouchbaseBackup</code>/<code>CouchbaseBackupRestore</code> custom resources.
Without these resources, backup jobs will still run as scheduled, but they will ultimately fail as the pods won&#8217;t have the required permissions.</p>
</div>
<div class="paragraph">
<p>You can use the <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool to create the resources that grant the required permissions.
The following command creates the necessary resources in the default namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ bin/cao create backup</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create the resources in a custom namespace, use the <code>-n</code> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ bin/cao create backup -n my-namespace</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make your own edits to these resources, you can use <code>cao generate backup</code> to generate the YAML output instead of creating the resources in Kubernetes immediately.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-backups"><a class="anchor" href="#configure-backups"></a>Configure Backups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After automated backup is enabled for the cluster, individual backup policies can be configured using <code>CouchbaseBackup</code> resources.
The following is a very simple configuration with only the minimum required fields set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackup
metadata:
  name: my-backup
spec:
  strategy: full_incremental
  full:
    schedule: "0 3 * * 0" <i class="conum" data-value="1"></i><b>(1)</b>
  incremental:
    schedule: "0 3 * * 1-6" <i class="conum" data-value="1"></i><b>(1)</b>
  size: 20Gi <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On detection of the <code>CouchbaseBackup</code> resource, the Autonomous Operator creates the correct cron jobs for the <code>spec.full.schedule</code> and the <code>spec.incremental.schedule</code>.
In this example a full backup would be performed at 3:00AM on a Sunday and then an incremental backup on every other day of the week at 3:00AM.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The Autonomous Operator will also create a PersistentVolumeClaim (PVC) to store the backups and logs with the same name that is specified in <code>metadata.name</code>.
So if a PVC called "my-backup" does not yet exist in this case, one will be created.
This would also happen if for some reason the PVC was deleted.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once you have created a <code>CouchbaseBackup</code>, we can check that for the expected behavior by viewing the Operator logs.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl logs -f deployments/couchbase-operator</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc logs deployments/couchbase-operator</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should observe that a Persistent Volume Claim and the correct number of cron jobs have been created along with the <code>CouchbaseBackup</code> itself. The output should be similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">{"level":"info","ts":1587134718.3592374,"logger":"cluster","msg":"Backup Cronjob created","cbbackup":"my-backup","cronjob":"my-backup-incremental"}
{"level":"info","ts":1587134718.3727212,"logger":"cluster","msg":"Backup Cronjob created","cbbackup":"my-backup","cronjob":"my-backup-full"}
{"level":"info","ts":1587134718.3722592,"logger":"cluster","msg":"Backup PVC created","cbbackup":"my-backup"}
{"level":"info","ts":1587134718.3727608,"logger":"cluster","msg":"Backup created","cbbackup":"my-backup"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then validate for yourself that these resources exist and check that their details match up with what was defined in the <code>CouchbaseBackup</code> configuration.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get cronjob
$ kubectl get pvc</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get cronjob
$ oc get pvc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For example, the output should look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                        SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
my-backup-full              0 3 * * 0     False     0        &lt;none&gt;          18s
my-backup-incremental       0 3 * * 1-6   False     0        &lt;none&gt;          18s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-console hljs" data-lang="console">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
my-backup   Bound    pvc-0c3c717f-e10b-423e-9279-a99edf81019b   5Gi        RWO            standard       14s</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deleting Persistent Volume Claims or Persistent Volumes will delete the backup data and backup log data permanently.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the first Job has been spawned by a backup cron job, the status fields of a <code>CouchbaseBackup</code> resource will update, and you can start <a href="#monitor-and-manage-backups">monitoring backup progress</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restoring-from-a-backup"><a class="anchor" href="#restoring-from-a-backup"></a>Restoring From a Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Restoring from a backup requires that you create a <code>CouchbaseBackupRestore</code> resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackupRestore
metadata:
  name: my-restore
spec:
  backup: my-backup
  repo: cb-example-2020-02-12T19_00_03
  start:
    int: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>CouchbaseBackupRestore</code> resource behaves differently from a <code>CouchbaseBackup</code> resource in that it spawns just a singular, one-time job which attempts to restore the requested backup or range of backups.</p>
</div>
<div class="paragraph">
<p>In the example above, the <code>CouchbaseBackupRestore</code> resource configuration is restoring the first backup in the repository <code>"cb-example-2020-02-12T19_00_03"</code>.
The first backup in any repository will be a full backup since the Autonomous Operator performs a full backup of the cluster after the creation of each backup repository.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t know the name of the backup repository that you want to restore from, you can find the name without having to explore the contents of a Persistent Volume Claim by simply referring to the <a href="resource/couchbasebackup.html#couchbasebackups-status" class="xref page"><code>couchbasebackups.status</code></a> object of the existing <code>CouchbaseBackup</code> resource.</p>
</div>
<div class="paragraph">
<p>You also have the option to restore a range of backups from the latest backup repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackupRestore
metadata:
  name: my-restore
spec:
  backup: my-backup
  start:
    str: oldest
  end:
    str: latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example above, the Autonomous Operator would restore a range of backups from the latest backup repository.
The omission of the <code>spec.repo</code> field means that the Autonomous Operator will look for the most recent backup repository.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Any <code>CouchbaseBackupRestore</code> edits performed with <code>kubectl edit</code> will not be reflected in the respective <code>Job</code> once the <code>Job</code> has been created.
The <code>CouchbaseBackupRestore</code> resource will have to be deleted and created from scratch.
When a <code>CouchbaseBackupRestore</code> resource is deleted, its associated <code>Job</code> and <code>Pod</code> resources are deleted immediately.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="additional-backup-options"><a class="anchor" href="#additional-backup-options"></a>Additional Backup Options</h3>
<div class="paragraph">
<p>Backups allow data to be filtered so that you only backup what you need, minimizing storage space and improving performance.
Backup options can only be modified on creation of a new backup repository, so when using a full/incremental backup strategy, modifications will be deferred until the next full backup.</p>
</div>
<div class="paragraph">
<p>Consider the following specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackup
metadata:
  name: my-backup
spec:
  data:
    include: <i class="conum" data-value="1"></i><b>(1)</b>
    - bucket1
    - bucket1.scope
    - bucket2.scope.collection
    exclude: <i class="conum" data-value="2"></i><b>(2)</b>
    - bucket3
  services: <i class="conum" data-value="3"></i><b>(3)</b>
    analytics: true
    bucketConfig: true
    bucketQuery: true
    clusterAnalytics: true
    clusterQuery: true
    data: true
    eventing: true
    ftsAliases: true
    ftsIndexes: true
    gsIndexes: true
    views: true
  threads: 16 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-data-include" class="xref page"><code>couchbasebackups.spec.data.include</code></a> allows data sources to be explicitly selected.
When this field is set, the backup will exclude all data by default, and you have to opt-in to data items being included.
Data items cannot alias, e.g. <code>bucket</code> and <code>bucket.scope</code> alias, because latter is contained in the former.
This field cannot be specified at the same time as <a href="resource/couchbasebackup.html#couchbasebackups-spec-data-exclude" class="xref page"><code>couchbasebackups.spec.data.exclude</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-data-exclude" class="xref page"><code>couchbasebackups.spec.data.exclude</code></a> allows data sources to be explicitly excluded.
When this field is set, the backup will include all data by default, and you have to opt-out from data items being included.
Data items cannot alias, e.g. <code>bucket</code> and <code>bucket.scope</code> alias, because latter is contained in the former.
This field cannot be specified at the same time as <a href="resource/couchbasebackup.html#couchbasebackups-spec-data-include" class="xref page"><code>couchbasebackups.spec.data.include</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-services" class="xref page"><code>couchbasebackups.spec.services</code></a> allows the selection of what services are backed up.
By default all available services are include in the backup, and you have to opt-out.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-threads" class="xref page"><code>couchbasebackups.spec.threads</code></a> allows the number of threads used by the backup to be tailored.
Increasing this value improves performance.
Ensure any value used here is less than that provided for backup pod CPU resource requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Further details can be found on the <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code> resource reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="additional-restore-options"><a class="anchor" href="#additional-restore-options"></a>Additional Restore Options</h3>
<div class="paragraph">
<p>Additional options from <a href="#server:backup-restore:cbbackupmgr-restore.adoc" class="xref unresolved"><code>cbbackupmgr restore</code></a> may also be specified.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackupRestore
metadata:
  name: my-restore
spec:
  backup: my-backup
  repo: cb-example-2020-02-12T19_00_03
  start:
    int: 1
  data:
    include: <i class="conum" data-value="1"></i><b>(1)</b>
    - default
    - peanutbutter
    - princess.caroline
    exclude:
    - horseman
    map: <i class="conum" data-value="2"></i><b>(2)</b>
    - source: default
      target: new-default
    - source: peanutbutter
      target: pickles
    filterKeys: "^cat.*" <i class="conum" data-value="3"></i><b>(3)</b>
  services: <i class="conum" data-value="4"></i><b>(4)</b>
    analytics: true
    bucketConfig: false
    bucketQuery: true
    clusterAnalytics: true
    clusterQuery: true
    data: true
    eventing: true
    ftAlias: true
    ftIndex: true
    gsiIndex: true
    views: true
  threads: 1 <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-data-include" class="xref page"><code>couchbasebackuprestores.spec.data.include</code></a>: Explicitly restore only the specified list of buckets, scopes and collections.
<div class="paragraph">
<p><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-data-exclude" class="xref page"><code>couchbasebackuprestores.spec.data.exclude</code></a>: Restore all buckets <em>except</em> the list of specified buckets, scopes and collections.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Include and exclude are mutually exclusive and cannot be specified at the same time.
Data items cannot alias, e.g. <code>bucket</code> contains <code>bucket.scope</code>, and therefore cannot be defined at the same time.</p>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-data-map" class="xref page"><code>couchbasebackuprestores.spec.data.map</code></a>: Specified when you want to restore a backup to a destination bucket, scope or collection that has a different name than the bucket, scope or collection that was originally backed up.
<div class="paragraph">
<p>This field requires a pair of fields named <code>source</code> and <code>target</code>.</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>source</code> refers to the name of the bucket, scope or collection to restore from in the backup archive</p>
</li>
<li>
<p><code>target</code> refers to the name of the existing (renamed) bucket, scope or collection to restore to in the Couchbase cluster</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Multiple <code>source</code>/<code>target</code> pairs may be specified.
Note that this option will only restore data to the Data Service and will not restore the metadata for any other service.
Refer to the <a href="#server:backup-restore:cbbackupmgr-restore.adoc#options" class="xref unresolved"><code>cbbackupmgr restore --map-buckets</code></a> documentation for more information.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-data-filterkeys" class="xref page"><code>couchbasebackuprestores.spec.data.filterKeys</code></a> allows only those documents whose name matches a regular expression to be restored.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-services" class="xref page"><code>couchbasebackuprestores.spec.services</code></a>: By default, all data and configuration settings, for all services, are restored to the Couchbase cluster, <em>apart from bucket configuration settings</em>.
<div class="paragraph">
<p>In order to skip restoring a particular service, simply set the service to <code>false</code> (these options correspond to the <a href="#server:backup-restore:cbbackupmgr-restore.adoc#options" class="xref unresolved"><code>cbbackupmgr restore --disable-&lt;service&gt;</code></a> flags).
In order to restore bucket configuration settings, set <a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-services-bucketconfig" class="xref page"><code>couchbasebackuprestores.spec.services.bucketConfig</code></a> to <code>true</code> (this option corresponds to the <a href="#server:backup-restore:cbbackupmgr-restore.adoc#options" class="xref unresolved"><code>cbbackupmgr restore --enable-bucket-config</code></a> flag).</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><a href="resource/couchbasebackuprestore.html#couchbasebackuprestores-spec-threads" class="xref page"><code>couchbasebackuprestores.spec.threads</code></a>: An integer that specifies the number of concurrent <code>cbbackupmgr</code> clients to use when restoring data.
Refer to the <a href="#server:backup-restore:cbbackupmgr-restore.adoc#options" class="xref unresolved"><code>cbbackupmgr restore --threads</code></a> documentation for more information.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitor-and-manage-backups"><a class="anchor" href="#monitor-and-manage-backups"></a>Monitor and Manage Backups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s important to regularly monitor backup performance to ensure you’re backing up all the required data within your desired time window.</p>
</div>
<div class="paragraph">
<p>For the simplest overview, run <code>get</code> commands on the <code>CouchbaseBackup</code> resources.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get couchbasebackup my-backup -o yaml</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get couchbasebackup my-backup -o yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The short names <code>cbbackup</code> and <code>cbrestore</code> are available for <code>CouchbaseBackup</code> and <code>CouchbaseBackupRestore</code> respectively.
So instead of executing <code>kubectl get couchbasebackup</code> you can instead write <code>kubectl get cbbackup</code>.
To find out if any other of your current Kubernetes resources support a short name, run <code>kubectl api-resources</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The command output should show the given <code>CouchbaseBackup</code> specification and also a <a href="resource/couchbasebackup.html#couchbasebackups-status" class="xref page"><code>couchbasebackups.status</code></a> section containing useful information similar to the following output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">status:
  archive: /data/backups
  backups:
  - full: 2020-02-12T15_25_10.712665995Z
    incrementals:
    - 2020-02-12T15_28_11.986341497Z
    - 2020-02-12T15_26_09.875255309Z
    name: cb-example-2020-02-12T15_25_09
  - full: 2020-02-12T15_15_08.443231128Z
    incrementals:
    - 2020-02-12T15_18_12.465643387Z
    - 2020-02-12T15_16_08.037612813Z
    - 2020-02-12T15_24_10.264088039Z
    - 2020-02-12T15_22_11.215924706Z
    name: cb-example-2020-02-12T15_15_07
  capacityUsed: 1.47Gi
  duration: 17s
  job: cbbackup-full-incr-incremental-1587137280
  lastRun: "2020-02-12T15:28:11Z"
  lastSuccess: "2020-02-12T15:28:28Z"
  repo: repo
  running: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Furthermore you can check that the cron jobs have updated and their status fields look correct.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset4_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get cronjob</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get cronjob</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                        SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
my-backup-full              0 3 * * 0     False     0        2d              2d
my-backup-incremental       0 3 * * 1-6   False     0        16h             2d</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset5_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get cronjob my-backup-full -o yaml</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get cronjob my-backup-full -o yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And finally we can check that the backup Jobs and their respective pods are there, and there is no more than the set limit specified in <a href="resource/couchbasebackup.html#couchbasebackups-spec-failedjobshistorylimit" class="xref page"><code>couchbasebackups.spec.failedJobsHistoryLimit</code></a> and <a href="resource/couchbasebackup.html#couchbasebackups-spec-successfuljobshistorylimit" class="xref page"><code>couchbasebackups.spec.successfulJobsHistoryLimit</code></a>.
These default to 5 and 3 respectively.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset6_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get jobs</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get jobs</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                        COMPLETIONS   DURATION   AGE
cbbackup-full-incr-full-1587138300          1/1           33s        11m
cbbackup-full-incr-incremental-1587138600   1/1           43s        6m8s</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_kubernetes"></a>Kubernetes</p>
</li>
<li>
<p><a id="tabset7_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_kubernetes">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get pods</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_openshift">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ oc get pods</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">NAME                                              READY   STATUS      RESTARTS   AGE
cb-example-0000                                   1/1     Running     0          72m
cb-example-0001                                   1/1     Running     0          72m
cb-example-0002                                   1/1     Running     0          72m
cbbackup-full-incr-full-1587138300-92rfp          0/1     Completed   0          11m
cbbackup-full-incr-incremental-1587138600-vzmd2   0/1     Completed   0          6m5s
couchbase-operator-admission-7ccbd85455-6g64p     1/1     Running     0          73m
couchbase-operator-b6496564f-qpqsb                1/1     Running     0          73m</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="editing-a-backup-configuration"><a class="anchor" href="#editing-a-backup-configuration"></a>Editing a Backup Configuration</h3>
<div class="paragraph">
<p>Only the preexisting schedules and volume size of a <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code></a> resource can be edited.
Attempts to edit things like the name or strategy will fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="online-backup-volume-resizing"><a class="anchor" href="#online-backup-volume-resizing"></a>Online Backup Volume Resizing</h3>
<div class="paragraph">
<p>A Backup PVC that is referenced by an existing <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code></a> resource can be resized <em>manually</em> by the user, or <em>automatically</em> by the Autonomous Operator.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A Backup PVC can only be resized if its associated StorageClass is configured to allow volume expansion.
This means the default StorageClass in your Kubernetes environment should have <code>allowVolumeExpansion</code> set to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Ensure that the StorageClass is configured to allow volume expansion <em>before</em> creating the <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code></a> resource.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="manual-backup-volume-resizing"><a class="anchor" href="#manual-backup-volume-resizing"></a>Manual Backup Volume Resizing</h4>
<div class="paragraph">
<p>To perform a manual resize, simply edit <a href="resource/couchbasebackup.html#couchbasebackups-spec-size" class="xref page"><code>couchbasebackups.spec.size</code></a> and change it to a value that is <em>larger</em> than the current size.
The resize will then be performed with the next scheduled backup job.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The underlying StorageClass must be configured to allow volume expansion in order to modify the size of the Backup PVC (as stated <a href="#online-backup-volume-resizing">previously</a>).
Changes to the volume size may go through,but the Autonomous Operator will error until the change is reverted.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="automated-backup-volume-resizing"><a class="anchor" href="#automated-backup-volume-resizing"></a>Automated Backup Volume Resizing</h4>
<div class="paragraph">
<p>A <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code></a> resource can be modified to allow the Autonomous Operator to automatically resize the Backup PVC once a specific percentage of space is left.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackup
metadata:
  name: my-backup
spec:
  strategy: full_incremental
  full:
    schedule: "0 3 * * 0"
  incremental:
    schedule: "0 3 * * 1-6"
  size: 20Gi <i class="conum" data-value="1"></i><b>(1)</b>
  autoscaling:
    thresholdPercent: 20 <i class="conum" data-value="2"></i><b>(2)</b>
    incrementPercent: 20 <i class="conum" data-value="3"></i><b>(3)</b>
    limit: 100Gi <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-size" class="xref page"><code>couchbasebackups.spec.size</code></a> is set to the initial size when the <a href="resource/couchbasebackup.html" class="xref page"><code>CouchbaseBackup</code></a> resource is created.
Here, the size is set to <code>20Gi</code> (the default).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-autoscaling-thresholdpercent" class="xref page"><code>couchbasebackups.spec.autoScaling.thresholdPercent</code></a> represents the percentage of free space <em>remaining</em> on the volume at which point a volume expansion will be triggered.
Here, the threshold is set to <code>20</code> (the default).
In this case, if the volume is currently 80 GiB, a volume expansion will be triggered once the used capacity reaches 64 GiB and free space is less than 16 GiB.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-autoscaling-incrementpercent" class="xref page"><code>couchbasebackups.spec.autoScaling.incrementPercent</code></a> controls how much the volume is increased each time the threshold is exceeded.
Here, the increment is set to <code>20</code> (the default).
In this case, if the volume is currently 80 GiB when the threshold is reached, the volume will be expanded to 100 GiB.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="resource/couchbasebackup.html#couchbasebackups-spec-autoscaling-limit" class="xref page"><code>couchbasebackups.spec.autoScaling.limit</code></a> imposes a hard limit on the size of the Backup PVC, at which point the volume size will no longer be incremented.
When this field is not defined, no bounds are imposed.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The underlying StorageClass must be configured to allow volume expansion in order to modify the size of the Backup PVC (as stated <a href="#online-backup-volume-resizing">previously</a>).
Changes to the volume size may go through, but the Autonomous Operator will error until the change is reverted.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deleting-a-backup-configuration"><a class="anchor" href="#deleting-a-backup-configuration"></a>Deleting a Backup Configuration</h3>
<div class="paragraph">
<p>When a <code>CouchbaseBackup</code> resource is deleted, any associated <code>Cronjob</code>(s) are deleted.
<code>Jobs</code> and their respective <code>Pods</code> from those <code>Cronjobs</code> are orphaned; the number of these resources that are left over is determined by the limits <code>spec.successfulJobsHistoryLimit</code> and <code>spec.failedJobsHistoryLimit</code>.</p>
</div>
<div class="paragraph">
<p>If a backup job is running whilst the parent <code>CouchbaseBackup</code> is deleted then the job will continue until completion or eventual failure.</p>
</div>
</div>
<div class="sect2">
<h3 id="viewing-detailed-logs"><a class="anchor" href="#viewing-detailed-logs"></a>Viewing Detailed Logs</h3>
<div class="paragraph">
<p>If anything goes wrong during a backup job, and backup pods return the <code>Error</code> status, detailed logging is stored on the Persistent Volume Claim for the backup.
You can access these logs by creating a Kubernetes job that creates a pod that mounts this PVC and then running <code>kubectl exec</code> to shell into this pod.
From there you can access the logs and backup data directly.</p>
</div>
<div class="paragraph">
<p>The following is an example file that creates such a Kubernetes job.
The job creates a pod and mounts the PVC on the path <code>/data</code> as the backup and restore pods themselves would.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Job
apiVersion: batch/v1
metadata:
  name: backup-exec
spec:
  template:
    spec:
      containers:
        - name: couchbase-cluster-backup-create
          image: couchbase/operator-backup:1.3.0
          command: ["sleep"]
          args: ["30000"] <i class="conum" data-value="1"></i><b>(1)</b>
          volumeMounts:
            - name: "couchbase-cluster-backup-volume"
              mountPath: "/data" <i class="conum" data-value="2"></i><b>(2)</b>
      volumes:
        - name: couchbase-cluster-backup-volume
          persistentVolumeClaim:
            claimName: my-backup <i class="conum" data-value="3"></i><b>(3)</b>
      restartPolicy: Never
      serviceAccountName: couchbase-backup</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The time in seconds to keep the pod running&#8201;&#8212;&#8201;make sure you give this argument sufficient time so you are not interrupted by the pod completing and any <code>exec</code> connection shutting down.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>mountPath</code> may be any valid path, but for purposes of consistency it should be set to <code>/data</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>claimName</code> refers to the name of the PVC to be accessed, and also the same name of the <code>CouchbaseBackup</code> resource.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Backups are available to view at <code>/data/backups</code> and their respective logs at <code>/data/scriptlogs</code>.
Inside <code>/data/scriptlogs</code> will be three folders, <code>full_only</code>, <code>incremental</code>, and <code>restore</code>.
The first two folders correspond to any logs run under the relevant <code>CouchbaseBackup</code> strategy and the last folder is for <code>CouchbaseBackupRestore</code> operations exclusively.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-backup-management"><a class="anchor" href="#advanced-backup-management"></a>Advanced Backup Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="backup-scheduling"><a class="anchor" href="#backup-scheduling"></a>Backup Scheduling</h3>
<div class="paragraph">
<p>As backups are performed on separate pods you will need to consider careful node scheduling when it comes to these pods in order to avoid performance issues and noisy neighbor problems.
The following YAML example builds upon the initial YAML in <a href="#enable-automated-backup">Enable Automated Backup</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase/v2
kind: CouchbaseCluster
spec:
  backup:
    managed: true
    image: couchbase/operator-backup:1.3.0
    serviceAccountName: couchbase-backup
    nodeSelector:
      instanceType: large <i class="conum" data-value="1"></i><b>(1)</b>
    resources:
      requests:
        cpu: 100m
        memory: 100Mi <i class="conum" data-value="2"></i><b>(2)</b>
    selector:
      matchLabels:
        cluster: my-cluster <i class="conum" data-value="3"></i><b>(3)</b>
    tolerations: <i class="conum" data-value="4"></i><b>(4)</b>
     - key: app
       operator: Equal
       value: cbbackup
       effect: NoSchedule</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>nodeSelector</code> field defines which Kubernetes nodes the pods running the automated backup process will be constrained to.
In this case we have specified that backup pods will be constrained to running on nodes of <code>instanceType</code> large.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If your Kubernetes environment requires it, you can set requests and limits for the pods that run the backup and restore jobs.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If you have more than one <code>CouchbaseCluster</code> resource deployed in the same namespace, you’ll need to use <a href="concept-label-selection.html" class="xref page">resource label selection</a> to ensure that <code>CouchbaseBackup</code> and <code>CouchbaseBackupRestore</code> resources get created on the correct cluster.
Like with other Couchbase custom resources, this means specifying a label for RBAC resources which matches the corresponding label selector of the <code>CouchbaseCluster</code> resource that you want the resources aggregated to.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tolerations are applied to pods, and allow (but do not require) the pods to be scheduled onto nodes with matching taints.
With taints and tolerations, you can grant backup pods exclusive access to specific nodes.
In this example, if we wish to run all backup pods on a dedicated node and isolate them from the rest of the Autonomous Operator pods, we can do this by tainting a node with the key-value of <code>app:cbbackup</code> and defining a matching toleration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Further reference on all of these fields can be found in the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup" class="xref page"><code>couchbaseclusters.spec.backup</code></a> resource configuration.
For more overall information please see <a href="#concept-scheduling">Couchbase Scheduling and Isolation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="backup-time-scheduling"><a class="anchor" href="#backup-time-scheduling"></a>Backup Time Scheduling</h3>
<div class="paragraph">
<p>When deciding on the Cron schedules for the Full/Incremental strategy, you should take care that the schedules are not defined in a way for a potential clash between Full and Incremental backups.
For the example given in this documentation and the <code>cbbackupmgr</code> documentation, this is obviously very unlikely but in a scenario where a backup is not given enough of a time window to complete, this could cause problems.
This particularly common in situations where backups have been scheduled too frequently.</p>
</div>
</div>
<div class="sect2">
<h3 id="pod-scheduling"><a class="anchor" href="#pod-scheduling"></a>Pod Scheduling</h3>
<div class="paragraph">
<p>Scheduling of backup and restore jobs is exactly the same as the mechanism used for Couchbase Server pods.
The affinity and anti-affinity mechanisms are described in <a href="concept-scheduling.html" class="xref page">Couchbase Scheduling and Isolation</a>.</p>
</div>
<div class="paragraph">
<p>Backup and restore job affinity can be set, per <code>CouchbaseCluster</code>, with the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-nodeselector" class="xref page"><code>couchbaseclusters.spec.backup.nodeSelector</code></a> attribute, and toleration of anti-affinity rules can be set with the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-tolerations" class="xref page"><code>couchbaseclusters.spec.backup.tolerations</code></a> attribute.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup-and-restore-to-s3"><a class="anchor" href="#backup-and-restore-to-s3"></a>Backup and Restore to S3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are running a Couchbase cluster version 6.6.x or higher and using the backup image <code>operator-backup:1.1.0</code> or higher, the ability to backup and restore to and from AWS S3 buckets is available.
This option requires some extra configuration related to your AWS credentials and the name of the S3 bucket to perform operations on.</p>
</div>
<div class="paragraph">
<p>There are two ways to configure your AWS credentials:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Manually through providing an access key and secret id.</p>
</li>
<li>
<p>Automatically through an attached IAM Role.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="configure-explicit-access-and-secret-keys"><a class="anchor" href="#configure-explicit-access-and-secret-keys"></a>Configure Explicit Access and Secret Keys</h3>
<div class="paragraph">
<p>When manually providing an access key and secret id, a separate <code>Secret</code> must be created that holds the AWS region name, access key ID, and secret access key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: s3-secret
type: Opaque
data:
  region: aGV5IG1h...
  access-key-id: bXVzaHJvb20ga2l...
  secret-access-key: cm9zY29lJ3Mgd2V0IHN...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your <code>CouchbaseCluster</code> object, you will need to reference this secret so the Operator knows where to extract the credentials from.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase/v2
kind: CouchbaseCluster
spec:
  backup:
    managed: true
    image: couchbase/operator-backup:1.3.0
    serviceAccountName: couchbase-backup
    s3Secret: s3-secret</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-iam-roles"><a class="anchor" href="#configure-iam-roles"></a>Configure IAM Roles</h3>
<div class="paragraph">
<p>To allow backup to automatically use an attached IAM Role, enable the <code>useIAMRole</code> parameter.
A secret with the region key set is still required.
If you have attached the IAM Role to an EKS node directly then this is sufficient configuration.</p>
</div>
<div class="paragraph">
<p>If you have <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html">setup IAM roles for service accounts</a>, the role <code>ARN</code> annotation must be applied to the backup service account either manually or when running <code>cao</code> using <code>bin/cao create backup --iam-role-arn arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/&lt;IAM_ROLE_NAME&gt;</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase/v2
kind: CouchbaseCluster
spec:
  backup:
    managed: true
    image: couchbase/operator-backup:1.3.0
    serviceAccountName: couchbase-backup
    useIAMRole: true
    s3Secret: s3-secret</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configure-s3-backup"><a class="anchor" href="#configure-s3-backup"></a>Configure S3 Backup</h3>
<div class="paragraph">
<p>The S3 bucket that we wish to hold backups needs to be specified in the desired <code>CouchbaseBackup</code> and <code>CouchbaseBackupRestore</code> CRDs.
Note that the <code>s3://</code> prefix is required, otherwise the Admission Controller will not allow the creation of the CRD.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackup
metadata:
  name: my-backup
spec:
  strategy: full_incremental
  full:
    schedule: "0 3 * * 0"
  incremental:
    schedule: "0 3 * * 1-6"
  size: 20Gi
  s3bucket: s3://my-backup-bucket</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseBackupRestore
metadata:
  name: my-restore
spec:
  backup: my-backup
  start:
    str: oldest
  end:
    str: latest
  s3bucket: s3://my-backup-bucket</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that operations involving S3 take more time to complete in comparison to regular backup to PVCs so please bear this in mind when configuring your automated backup schedules.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Backing up to S3 still requires a local PVC with enough space for <a href="#server:backup-restore:cbbackupmgr-cloud.adoc#the-staging-directory" class="xref unresolved">a <code>staging</code> folder</a>,
where files will be stored locally first before being uploaded to S3.
Please note that cleanup schedules will also apply to the local PVC as well as the S3 bucket.</p>
</div>
<div class="paragraph">
<p>The <code>staging</code> folder does not need to be created manually by the user.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup-and-restore-to-compatible-object-stores"><a class="anchor" href="#backup-and-restore-to-compatible-object-stores"></a>Backup and Restore to Compatible Object Stores</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are using Couchbase Operator version 2.3.0 or higher, and Couchbase Operator Backup 1.2.1 version or higher, the ability to backup/restore using a S3 compatible stores is available.
Please see <a href="#server:backup-restore:cbbackupmgr-cloud.adoc#compatible-object-stores" class="xref unresolved">Compatible Object Stores</a> for limitations.</p>
</div>
<div class="paragraph">
<p>Users wishing to use a compatible store should set <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-objectendpoint-url" class="xref page"><code>couchbaseclusters.spec.backup.objectEndpoint.url</code></a> to the host/address of the object store.</p>
</div>
<div class="paragraph">
<p>Optionally, <a href="resource/couchbasecluster.html#couchbaseclusters-spec-backup-objectendpoint-secret" class="xref page"><code>couchbaseclusters.spec.backup.objectEndpoint.secret</code></a> can be set to the name of the secret containing the CA certificate the compatible object endpoint is using.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase/v2
kind: CouchbaseCluster
spec:
  backup:
    managed: true
    image: couchbase/operator-backup:1.3.0
    serviceAccountName: couchbase-backup
    s3Secret: s3-secret
    objectEndpoint:
      url: https://minio.minio <i class="conum" data-value="1"></i><b>(1)</b>
      secret: my-tls-secret <i class="conum" data-value="2"></i><b>(2)</b>
      useVirtualPath: false <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only required parameter for using a custom object endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Only required if the custom object store is using a custom CA certificate for communication</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only required if the custom object store uses virtual-hosted style addressing instead of path-style addressing. e.g <code><a href="https://bucket.s3.amazonaws.com/file" class="bare">https://bucket.s3.amazonaws.com/file</a></code> vs <code><a href="https://s3.amazonaws.com/bucket/file" class="bare">https://s3.amazonaws.com/bucket/file</a></code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Where <code>my-tls-secret</code> contains the certificate of the endpoint, similarly to below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: my-tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1J...</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
