<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Manage Couchbase Server Logging | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/operator/2.3/howto-manage-couchbase-logging.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/howto-manage-couchbase-logging.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator/docs/user/modules/ROOT/pages/howto-manage-couchbase-logging.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Manage</li>
<li class="crumb">Couchbase Cluster</li>
<li class="crumb">Configure</li>
<li class="crumb"><a href="howto-manage-couchbase-logging.html">Manage Couchbase Logging</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Manage Couchbase Server Logging</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
The Autonomous Operator can be configured to manage certain aspects of Couchbase Server logging, and comes with tools for collecting Couchbase Server logs.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Couchbase Server application records important events, and saves the details to a <a href="../../server/7.1/manage/manage-logging/manage-logging.html#log-file-listing" class="xref page">variety</a> of log files.
These logs are distinct from the logs that are generated by the Autonomous Operator <a href="concept-operator-logging.html" class="xref page">itself</a>.</p>
</div>
<div class="paragraph">
<p>Logging is performed continuously within each Couchbase Server container in a Couchbase deployment.
When using <a href="concept-persistent-volumes.html" class="xref page">persistent volumes</a>&#8201;&#8212;&#8201;as is <a href="best-practices.html#storage" class="xref page">recommended</a> for all production deployments&#8201;&#8212;&#8201;log files are written to either the <code>default</code> or <code>logs</code> volume.</p>
</div>
<div class="paragraph">
<p>Couchbase Server manages logging automatically and uses default settings for things like logging level, file size, and rotation/expiration.
The one exception is <code>audit.log</code>.
This is a special log file, used to manage cluster-security, and is handled separately from the other log files.
For information on <code>audit.log</code>, refer to <a href="#configuring-audit-logging">Configuring Audit Logging</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-audit-logging"><a class="anchor" href="#configuring-audit-logging"></a>Configuring Audit Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Server <a href="../../server/7.1/learn/security/auditing.html" class="xref page">audit logging</a> is a special type of logging that is not enabled by default.
When audit logging is enabled, Couchbase Server begins recording information on <em>who</em> has performed <em>what</em> action, <em>when</em>, and <em>how</em> successfully.</p>
</div>
<div class="paragraph">
<p>Audit records are written as JSON documents to a default file, named <code>audit.log</code>, which is stored alongside all other Couchbase Server log files in the <code>default</code> or <code>logs</code> volume that is attached to the pod.
After a specified period time, or once the file reaches a specified size (whichever happens first), the file is closed, and is saved under a modified name that features a timestamp corresponding to the time of saving.
A new, empty <code>audit.log</code> file is created and saved when a new audit event is generated.</p>
</div>
<div class="paragraph">
<p>There are two approaches you can choose when it comes to implementing audit logging: <a href="#managed-audit-logging"><em>managed</em></a> and <a href="#automated-audit-logging"><em>automated</em></a>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Couchbase Server rotates audit logs, but never expires or deletes them.
This is by design, as Couchbase Server intentionally has no facility to modify or delete an audit log file once it has been rotated.
As a result, it is the explicit responsibility of the administrator to implement a policy for expiring and/or moving audit logs to a different storage location.
<em>Without active intervention, rotated audit logs will eventually consume all available storage, leading to node and cluster failures.</em></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="managed-audit-logging"><a class="anchor" href="#managed-audit-logging"></a>About Managed Audit Logging</h3>
<div class="paragraph">
<p><em>Managed</em> audit logging involves the administrator directly enabling audit logging in Couchbase Server, and requires that the administrator actively manage the resultant audit log files.
Managed audit logging can be implemented after the Couchbase cluster has been successfully deployed by the Autonomous Operator.
Once the cluster is deployed, the administrator can enable and configure audit logging directly through the Couchbase UI, CLI, or REST API.
Refer to <a href="../../server/7.1/manage/manage-security/manage-auditing.html" class="xref page">Manage Auditing</a> in the Couchbase Server documentation for more information.</p>
</div>
<div class="paragraph">
<p>Once audit logging is enabled, it&#8217;s up to the administrator to manage the resultant <code>audit.log</code> files.
It is expected that the administrator will implement an automated system for expiring and/or moving audit logs to a different storage location subject to a retention policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="automated-audit-logging"><a class="anchor" href="#automated-audit-logging"></a>Configuring Automated Audit Logging</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Automated audit logging requires that logs be written to a persistent volume (i.e. the Couchbase deployment&#8217;s <code>default</code> or <code>logs</code> volumes are backed by <a href="best-practices.html#storage" class="xref page">persistent storage</a>).
Fully-ephemeral clusters are not supported by this feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>Automated</em> audit logging involves having the Autonomous Operator handle the audit log configuration and optionally manage the resultant audit log files.
An audit logging configuration can be specified in the <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource specification, allowing the Autonomous Operator to set up audit logging in Couchbase Server, and optionally manage the resultant audit log files.</p>
</div>
<div class="paragraph">
<p>The required configuration parameters for enabling audit logging are described in the example below.
Specified values represent the defaults for their respective fields unless otherwise noted in a callout.
(The Autonomous Operator will set the default values for any fields that are not specified by the user.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
spec:
  logging:
    audit:
      enabled: true <i class="conum" data-value="1"></i><b>(1)</b>
      disabledEvents: <i class="conum" data-value="2"></i><b>(2)</b>
        - 8243
      disabledUsers: <i class="conum" data-value="3"></i><b>(3)</b>
        - "@eventing/local"
        - "@cbq-engine/local"
      rotation:
        interval: “15m”
        size: “20Mi”
      garbageCollection:
        sidecar:
          enabled: true <i class="conum" data-value="4"></i><b>(4)</b>
          image: "busybox:1.32.1" <i class="conum" data-value="5"></i><b>(5)</b>
          age: “1h”
          interval: “20m”
          resources:
            requests:
              cpu:
              memory:</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-enabled" class="xref page"><code>couchbaseclusters.spec.logging.audit.enabled</code></a>: Setting this field to <code>true</code> enables audit logging on the Couchbase cluster.
This field defaults to <code>false</code>.
<div class="paragraph">
<p>This is technically the only field that is required to configure audit logging.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-disabledevents" class="xref page"><code>couchbaseclusters.spec.logging.audit.disabledEvents</code></a>: This field can be set to an array of one or more <a href="../../server/7.1/learn/security/auditing.html#filterable-and-non-filterable-events" class="xref page">filterable</a> event <a href="../../server/7.1/audit-event-reference/audit-event-reference.html" class="xref page">id integers</a> that will be disabled for auditing purposes.
This field normally defaults to an empty array.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-disabledusers" class="xref page"><code>couchbaseclusters.spec.logging.audit.disabledUsers</code></a>: This field can be set to an array of one or more <a href="../../server/7.1/learn/security/auditing.html#filterable-and-non-filterable-events" class="xref page">filterable</a> <a href="../../server/7.1/manage/manage-security/manage-auditing.html#ignoring-events-by-user" class="xref page">user strings</a> that will be disabled for auditing purposes.
This field normally defaults to an empty array.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-garbagecollection-sidecar-enabled" class="xref page"><code>couchbaseclusters.spec.logging.audit.garbageCollection.sidecar.enabled</code></a>: Setting this field to <code>true</code> enables garbage collection of rotated audit logs.
This field defaults to <code>false</code>.
<div class="paragraph">
<p>This is technically the only field that is required to configure garbage collection of rotated audit logs.
Note, however, that garbage collection can only be enabled if <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-enabled" class="xref page"><code>couchbaseclusters.spec.logging.audit.enabled</code></a> is also set to <code>true</code>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-garbagecollection-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.audit.garbageCollection.sidecar.image</code></a>: This is the base image of the sidecar helper container that will be added to the server pods for handling the cleanup for rotated logs.
This sidecar is a standard Linux container that only needs to find and remove files of the appropriate name and age.
<div class="paragraph">
<p>Be aware that there are security concerns with using a standard Linux image, such as the potential for arbitrary shell execution and write-access to the volumes, which can potentially be exploited by a malicious image.
In order to limit potential abuse, the garbage collection sidecar uses a sub-path to only mount the logs directory.
In addition, the commands run by the garbage collector are not configurable, and the filenames of removed logs are printed to the garbage collector&#8217;s standard output.</p>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After enabling automated audit logging, you should take care only to use the <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource specification for making further modifications to the audit logging configuration.
Manual changes that are made to the configuration via the Couchbase UI, CLI, or REST API (such as changing the audit log directory) are not prevented by the Autonomous Operator, and can cause audit logging failures.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Changing the location of the audit log is not supported, as it would break the ability for the Autonomous Operator to <a href="concept-couchbase-logging.html#log-forwarding" class="xref page">forward</a> audit logs.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="collecting-logs"><a class="anchor" href="#collecting-logs"></a>Collecting Logs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Autonomous Operator package is distributed with a support tool&#8201;&#8212;&#8201;<a href="tools/cao.html" class="xref page"><code>cao</code></a>&#8201;&#8212;&#8201;which can be used to collect logs from Couchbase Server deployments.
The <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool performs <em>explicit logging</em>, which means it captures a snapshot of the current logs at the time the tool is was run.
Explicit logging can either be performed for all nodes in the cluster, or for one or more individual nodes.
The results are saved as zip files: each zip file contains the log-data generated for an individual node.</p>
</div>
<div class="paragraph">
<p>Note, however, there are some limitations to be aware of when collecting logs with <a href="tools/cao.html" class="xref page"><code>cao</code></a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only active, non-rotated log files are collected.</p>
</li>
<li>
<p><a href="tools/cao.html" class="xref page"><code>cao</code></a> requires <code>pods/exec</code> permissions in order to execute log collection scripts and run the <a href="../../server/7.1/cli/cbcollect-info-tool.html" class="xref page"><code>cbcollect_info</code></a> command locally on each pod in a Couchbase Server deployment, which may not be desirable for security and performance reasons.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To avoid these limitations, you can choose to configure <a href="concept-couchbase-logging.html#log-forwarding" class="xref page">log forwarding</a> as an alternative method for collecting logs.</p>
</div>
<div class="sect2">
<h3 id="collect-logs-with-cao"><a class="anchor" href="#collect-logs-with-cao"></a>Collecting Logs with <code>cao</code></h3>
<div class="paragraph">
<p>When run without any flags or options, the <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool collects a filtered list of the Kubernetes resources associated with the Autonomous Operator in a given namespace.
However, to also collect logs from Couchbase Server deployments, the <a href="tools/cao.html#cao-collect-logs" class="xref page"><code>--collectinfo</code></a> flag is required.</p>
</div>
<div class="paragraph">
<p>When <a href="tools/cao.html" class="xref page"><code>cao</code></a> is run unscoped with the <a href="tools/cao.html#cao-collect-logs" class="xref page"><code>--collectinfo</code></a> flag, it will look for logs from all Couchbase Server deployments that are managed by the Autonomous Operator.
However, you can scope the command to a particular cluster in order to look for just the logs from that cluster.</p>
</div>
<div class="paragraph">
<p>Run the following command to begin the log collection process for the Couchbase Server deployment named <code>cb-example</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao collect-logs --couchbase-cluster cb-example</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that no logs have been downloaded yet.
Instead, an interactive log collection menu opens on the command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Detected resources for log collection:
┌────┬─────────────────┬──────┬──────────┐
│ ID │ Pod             │ Type │ Detached │ <i class="conum" data-value="1"></i><b>(1)</b>
├────┼─────────────────┼──────┼──────────┤
│ 0  │ cb-example-0001 │ pod  │          │
│ 1  │ cb-example-0003 │ pod  │          │
│ 2  │ cb-example-0004 │ pod  │          │
└────┴─────────────────┴──────┴──────────┘
Please select volumes to collect [e.g. 1,2,5-6 or leave blank for all]: 1-2 <i class="conum" data-value="2"></i><b>(2)</b>
Please select whether to enable log redaction [Y/n]: <i class="conum" data-value="3"></i><b>(3)</b>
Server logs downloaded to the following files:
    cbinfo-default-cb-example-0002-20181016T131730+0100-redacted.zip <i class="conum" data-value="4"></i><b>(4)</b>
    cbinfo-default-cb-example-0001-20181016T131730+0100-redacted.zip
Wrote cluster information to cbopinfo-20181016T131730+0100.tar.gz</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The table lists the pods that have associated log volumes, along with the following information:
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>ID</code> is an arbitrary identification number that is used for specifying log volumes in later steps.</p>
</li>
<li>
<p><code>Pod</code> is the name of the pod associated with the log volume.</p>
</li>
<li>
<p><code>Type</code> specifies whether the logs are from a running <code>pod</code> or from an orphaned (detached) <code>persistentVolumeClaim</code>.</p>
</li>
<li>
<p>If <code>Type</code> is <code>persistentVolumeClaim</code>, then the <code>Detached</code> field will display the timestamp of when the log volume was detected as orphaned from its pod.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before attempting to collect logs from a detached PersistentVolumeClaim, please review <a href="#collecting-detached-volumes">About Collecting Logs from Detached Volumes</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Collect the logs from a limited set of log volumes by specifying a comma-separate list of `ID`s from the table.
Leaving this field blank will collect the logs from all of the listed log volumes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specify whether <a href="../../server/7.1/manage/manage-logging/manage-logging.html#understanding_redaction" class="xref page">partial redaction</a> should be applied to the collected logs.
As an added security measure, this field defaults to <code>yes</code> when left blank.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The logs are downloaded to the current working directory once collection is complete.</td>
</tr>
</table>
</div>
<div id="collecting-detached-volumes" class="sidebarblock">
<div class="content">
<div class="title">About Collecting Logs from Detached Volumes</div>
<div class="paragraph">
<p>The <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool collects logs from all log volumes in a Couchbase Server deployment, even PersistentVolumeClaims (PVCs) that are <em>detached</em> from pods.
Detached PVCs can occur more commonly when running <a href="best-practices.html#ephemeral-clusters" class="xref page">ephemeral clusters</a>.</p>
</div>
<div class="paragraph">
<p>When a detached PVC is encountered, <a href="tools/cao.html" class="xref page"><code>cao</code></a> will automatically create a temporary Couchbase Server pod, mount the log volume to it, and then run <a href="../../server/7.1/cli/cbcollect-info-tool.html" class="xref page"><code>cbcollect_info</code></a> to collect the logs.
Once the logs have been downloaded, the Autonomous Operator will delete the temporary pod (but will <em>not</em> delete the PVC).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool uses a default Couchbase Server container image when creating the temporary pod.
However, this container image may not match the version of the Couchbase Server container that the PVC was previously attached to.
To avoid compatibility issues when collecting logs from detached PVCs, make sure to use the <a href="tools/cao.html#cao-collect-logs" class="xref page"><code>--server-image</code></a> flag to specify a matching Couchbase Server container image when running <a href="tools/cao.html" class="xref page"><code>cao</code></a>.
For a Couchbase Server deployment named <code>cb-example</code>, the command would resemble the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ cao collect-logs --collectinfo cb-example --server-image couchbase/server:7.0.3</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It should be noted that detached PVCs can sometimes be caused by more serious issues.
Some of these issues may also cause <a href="tools/cao.html" class="xref page"><code>cao</code></a> to encounter errors while attempting to collect and download logs from detached PVCs.
If you encounter such errors, you can try to work around the issue by <a href="#manually-collect-logs-from-detached-volumes">manually collecting the logs</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="manually-collect-logs-from-detached-volumes"><a class="anchor" href="#manually-collect-logs-from-detached-volumes"></a>Manually Collecting Logs from Detached Volumes</h3>
<div class="paragraph">
<p>In most situations, the <a href="tools/cao.html" class="xref page"><code>cao</code></a> tool will allow logs to be collected and downloaded successfully.
Even in cases where logs are found to exist on detached PersistentVolumeClaims (PVCs), <a href="tools/cao.html" class="xref page"><code>cao</code></a> will <a href="#collecting-detached-volumes">automatically attempt to collect them</a> by creating temporary pods that mount the PVCs.</p>
</div>
<div class="paragraph">
<p>However, a case may arise where <a href="tools/cao.html" class="xref page"><code>cao</code></a> fails to collect logs from a detached PVC.
For example, if a stateful service&#8201;&#8212;&#8201;such as Data, Index, or Analytics&#8201;&#8212;&#8201;were to crash, and then continue to crash each time the Autonomous Operator recovered the pod, <a href="tools/cao.html" class="xref page"><code>cao</code></a> would unlikely be able to collect the Couchbase Server logs from the pod without manual intervention.
This is because in this hypothetical situation, the pod does not remain alive long enough for <a href="tools/cao.html" class="xref page"><code>cao</code></a> to perform normal log collection; <a href="tools/cao.html" class="xref page"><code>cao</code></a> also doesn&#8217;t see the PVC as detached, and therefore doesn&#8217;t automatically create a temporary pod to collect the logs as it normally would for a detached PVC.</p>
</div>
<div class="paragraph">
<p>The general process for manual log collection is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pause the Autonomous Operator&#8217;s management of the Couchbase cluster by setting <a href="resource/couchbasecluster.html#couchbaseclusters-spec-paused" class="xref page"><code>couchbaseclusters.spec.paused</code></a> to <code>true</code>.</p>
<div class="paragraph">
<p>Pausing management of the Couchbase cluster serves two purposes.
The first purpose is that it will prevent the Autonomous Operator from attempting to recover the malfunctioning pod after Kubernetes has killed it.
The second purpose is that it allows you to create a temporary replacement pod and mount the the detached PVCs to it without the Autonomous Operator interfering.</p>
</div>
</li>
<li>
<p>Create a temporary pod resource with the persistent volumes mounted.
The basic template will look like the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: cb-example-0005
  namespace: default
spec:
  restartPolicy: never
  containers:
  - name: couchbase-server
    image: couchbase/server:7.0.3 <i class="conum" data-value="1"></i><b>(1)</b>
    command: '/bin/sleep' <i class="conum" data-value="2"></i><b>(2)</b>
    args:
    - '86400'
    volumeMounts: <i class="conum" data-value="3"></i><b>(3)</b>
    - mountPath: /opt/couchbase/var/lib/couchbase <i class="conum" data-value="4"></i><b>(4)</b>
      name: pvc-couchbase-cb-example-0005-00-default
      subPath: default
    - mountPath: /opt/couchbase/etc <i class="conum" data-value="4"></i><b>(4)</b>
      name: pvc-couchbase-cb-example-0005-00-default
      subPath: etc
    - mountPath: /mnt/data <i class="conum" data-value="5"></i><b>(5)</b>
      name: pvc-couchbase-cb-example-0005-00-data
    - mountPath: /mnt/index <i class="conum" data-value="6"></i><b>(6)</b>
      name: pvc-couchbase-cb-example-0005-00-index
    - mountPath: /mnt/analytics-00 <i class="conum" data-value="7"></i><b>(7)</b>
      name: pvc-couchbase-cb-example-0005-00-analytics-00
    - mountPath: /mnt/analytics-01 <i class="conum" data-value="7"></i><b>(7)</b>
      name: pvc-couchbase-cb-example-0005-00-analytics-01
  volumes:
    - name: pvc-couchbase-cb-example-0005-00-default <i class="conum" data-value="4"></i><b>(4)</b>
      persistentVolumeClaim:
        claimName: pvc-couchbase-cb-example-0005-00-default
    - name: pvc-couchbase-cb-example-0005-00-data <i class="conum" data-value="5"></i><b>(5)</b>
        persistentVolumeClaim:
          claimName: pvc-couchbase-cb-example-0005-00-data
    - name: pvc-couchbase-cb-example-0005-00-index <i class="conum" data-value="6"></i><b>(6)</b>
        persistentVolumeClaim:
          claimName: pvc-couchbase-cb-example-0005-00-index
    - name: pvc-couchbase-cb-example-0005-00-analytics-00 <i class="conum" data-value="7"></i><b>(7)</b>
        persistentVolumeClaim:
          claimName: pvc-couchbase-cb-example-0005-00-analytics-00
    - name: pvc-couchbase-cb-example-0005-00-analytics-01 <i class="conum" data-value="7"></i><b>(7)</b>
        persistentVolumeClaim:
          claimName: pvc-couchbase-cb-example-0005-00-analytics-01</code></pre>
</div>
</div>
<div class="openblock">
<div class="content">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The pod contains only the Couchbase Server container.
It&#8217;s necessary to run the Couchbase Server container image since it contains the necessary command-line tools, namely <a href="../../server/7.1/cli/cbcollect-info-tool.html" class="xref page"><code>cbcollect_info</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The container entry point is modified to run <code>/bin/sleep</code> for <code>86400</code> seconds (a day) while logs are collected and downloaded.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the following command to get the list of PVCs associated with the malfunctioning Couchbase Server pod (in this case, <code>cb-example-0005</code>):
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get pvc -lcouchbase_node=cb-example-0005</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any returned PVCs will need to be defined in the temporary pod&#8217;s <code>volumes</code>, and correctly mounted in the pod via <code>volumeMounts</code>.
The <code>volumeMounts</code> names refer to their corresponding entries in <code>volumes</code>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>pvc-couchbase-cb-example-0005-00-default</code>: The <code>default</code> PVC needs to be defined in the temporary pod&#8217;s <code>volumes</code>, and requires two mounts in <code>volumeMounts</code>:
<div class="ulist">
<ul>
<li>
<p><code>subPath: default</code> must be mounted at <code>/opt/couchbase/etc</code></p>
</li>
<li>
<p><code>subPath: etc</code> must be mounted at <code>/opt/couchbase/var/lib/couchbase</code></p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>pvc-couchbase-cb-example-0005-00-data</code>: A <code>data</code> PVC, if returned, needs to be defined in the temporary pod&#8217;s <code>volumes</code>, and requires a single mount in <code>volumeMounts</code> that must be mounted as <code>/mnt/data</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>pvc-couchbase-cb-example-0005-00-index</code>: An <code>index</code> PVC, if returned, needs to be defined in the temporary pod&#8217;s <code>volumes</code>, and requires a single mount in <code>volumeMounts</code> that must be mounted as <code>/mnt/index</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>pvc-couchbase-cb-example-0005-00-analytics-00</code>: An <code>analytics</code> PVC, if returned, needs to be defined in the temporary pod&#8217;s <code>volumes</code>, and requires a single mount in <code>volumeMounts</code> that must be mounted as <code>/mnt/analytics-00</code>.
Note, however, that if multiple analytics PVCs are returned, they will have different numeric suffixes.
Each unique <code>analytics</code> PVC that is returned needs to be defined in <code>volumes</code>, with each requiring its own individual mount in <code>volumeMounts</code>.
For example: <code>pvc-couchbase-cb-example-0005-00-analytics-01</code> would be mounted as <code>/mnt/analytics-01</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</li>
<li>
<p>Once the temporary pod is created (with the PVCs correctly mounted), run <a href="../../server/7.1/cli/cbcollect-info-tool.html" class="xref page"><code>cbcollect_info</code></a> to collect the logs.
A typical command would resemble the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl exec -ti pod/cb-example-0005 /opt/couchbase/bin/cbcollect_info /tmp/cbinfo-default-cb-example-0005-$(date +%y%m%dT%H%M%S%z)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>pod/cb-example-0005</code> name refers to the name given to the temporary pod in the example configuration from the previous step.
The convention for logs is <code>cbinfo</code>, <em>namespace</em>, <em>pod name</em>, <em>timestamp</em>.</p>
</div>
</li>
<li>
<p>Once the logs have finished being collected, download them to localhost.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl cp default/cb-example-0005:/tmp/cbcollectinfo-default-cb-example-0005-181005T154746+0100.zip .</code></pre>
</div>
</div>
</li>
<li>
<p>After successfully downloading the logs, make sure to delete the temporary pod.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl delete pod cb-example-0005</code></pre>
</div>
</div>
</li>
<li>
<p>Resume the Autonomous Operator&#8217;s management of the Couchbase cluster either by removing <a href="resource/couchbasecluster.html#couchbaseclusters-spec-paused" class="xref page"><code>couchbaseclusters.spec.paused</code></a> or setting it to <code>false</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
