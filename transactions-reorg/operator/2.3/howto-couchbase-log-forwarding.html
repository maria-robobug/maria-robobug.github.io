<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Configure Log Forwarding | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/operator/2.3/howto-couchbase-log-forwarding.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/howto-couchbase-log-forwarding.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator//docs/user/modules/ROOT/pages/howto-couchbase-log-forwarding.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Manage</li>
<li class="crumb">Couchbase Cluster</li>
<li class="crumb">Configure</li>
<li class="crumb"><a href="howto-couchbase-log-forwarding.html">Configure Log Forwarding</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Log Forwarding</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Configure Couchbase Server logs to be forwarded to standard console output.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Server produces a <a href="../../server/7.1/manage/manage-logging/manage-logging.html#log-file-listing" class="xref page">variety</a> of log files.
By default, these logs cannot be collected from the Couchbase Server container&#8217;s standard console output.
This limits the ability to integrate Couchbase logging with 3rd-party monitoring or collection technologies deployed within a Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>However, the Autonomous Operator can optionally enable <a href="concept-couchbase-logging.html#log-forwarding" class="xref page"><em>log forwarding</em></a> by deploying a third party log processor in a sidecar container on each Couchbase pod, which then reads the log files and forwards them to standard console output.
For this purpose, Couchbase supplies a default <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a> based on <a href="https://fluentbit.io/" target="_blank" rel="noopener">Fluent Bit</a>.</p>
</div>
<div class="paragraph">
<p>The sections on this page describe how to enable and configure log forwarding using the Couchbase-supplied log processor image.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Couchbase-supplied log processor container image is only supported on Kubernetes platforms in conjunction with the Couchbase Autonomous Operator.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Log forwarding requires that logs be written to a persistent volume (i.e. the Couchbase deployment&#8217;s <code>default</code> or <code>logs</code> volumes are backed by <a href="best-practices.html#storage" class="xref page">persistent storage</a>).
Fully-ephemeral clusters are not supported by this feature.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Log forwarding requires that <a href="resource/couchbasecluster.html#couchbaseclusters-spec-securitycontext" class="xref page"><code>couchbaseclusters.spec.securityContext</code></a> is set as appropriate for your Kubernetes distribution, as the sidecar requires read access to the shared volume.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-log-forwarding"><a class="anchor" href="#enabling-log-forwarding"></a>Enabling Log Forwarding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Log forwarding is fundamentally provided by two components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the <em>log processor image</em> that is used by the Autonomous Operator to deploy the <code>logging</code> sidecar container onto each Couchbase Server pod, and</p>
</li>
<li>
<p>the <em>log forwarding configuration</em>, stored in a Kubernetes Secret, that gets consumed by the <code>logging</code> sidecar container and which controls its behavior.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Enabling log forwarding for a particular Couchbase cluster involves enabling these two components in the <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource specification.</p>
</div>
<div class="paragraph">
<p>The required configuration parameters for enabling log forwarding are described in the example below.
Specified values represent the defaults for their respective fields unless otherwise noted in a callout.
(The Autonomous Operator will set the default values for any fields that are not specified by the user.)</p>
</div>
<div class="listingblock">
<div class="title">Basic <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> Parameters That Enable Log Forwarding</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
spec:
  logging:
    server:
      enabled: true <i class="conum" data-value="1"></i><b>(1)</b>
      sidecar:
        image: "couchbase/fluent-bit:1.2.0" <i class="conum" data-value="2"></i><b>(2)</b>
    audit:
      enabled: false <i class="conum" data-value="3"></i><b>(3)</b>
      garbageCollection:
        sidecar:
          enabled: false</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-enabled" class="xref page"><code>couchbaseclusters.spec.logging.server.enabled</code></a>: This is technically the only field that must be changed in order to enable log forwarding.
Setting this field to <code>true</code> (defaults to <code>false</code>) instructs the Autonomous Operator to deploy the <code>logging</code> sidecar container on each pod.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.image</code></a>: This field specifies the container image that the Autonomous Operator will use for deploying the <code>logging</code> sidecar container.
This field defaults to <code>couchbase/fluent-bit:1.2.0</code>, which pulls the Couchbase-supplied <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a>.
You may need to modify this field if your Kubernetes nodes can&#8217;t pull from the Docker public registry.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>(Optional) <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-audit-enabled" class="xref page"><code>couchbaseclusters.spec.logging.audit.enabled</code></a>: This field is used to enable Couchbase audit logging, and defaults to <code>false</code>.
Unlike other Couchbase logs, audit logging is not turned on by default.
If you intend to forward audit logs, you must <a href="howto-manage-couchbase-logging.html#configuring-audit-logging" class="xref page">configure audit logging</a> first.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After deploying the <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource specification, the logs will be available on the standard output of the <code>logging</code> container on each pod:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl logs cb-example-0000 logging</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-log-forwarding"><a class="anchor" href="#configuring-log-forwarding"></a>Configuring Log Forwarding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As described in <a href="#enabling-log-forwarding">Enabling Log Forwarding</a>, there are two primary components that provide log forwarding: the <em>log processor image</em> and the <em>log forwarding configuration</em>.
The Autonomous Operator uses Couchbase-provided defaults for both of these components, which can be used <em>as-is</em> (refer to <a href="#using-default-log-forwarding">Using Default Log Forwarding</a>).
However, these components can be further customized to better meet the needs of your environment (refer to <a href="#using-custom-log-forwarding">Using Custom Log Forwarding</a>).</p>
</div>
<div class="sect2">
<h3 id="enable-memory-buffer-limits"><a class="anchor" href="#enable-memory-buffer-limits"></a>Enable memory buffer limits</h3>
<div class="paragraph">
<p>The Fluent Bit input plugins have memory buffer limits that can be used to help prevent the container from being terminated for exceeding memory limits.
Once an input plugin reaches its memory buffer limit, all new incoming data is instead buffered to file system.</p>
</div>
<div class="paragraph">
<p>Memory buffer limits are disabled by default and can be enabled by adding the annotation <code>fluentbit.couchbase.com/mem.buf.limits.enabled</code> to a pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
spec:
  servers:
  - name: default
    pod:
      metadata:
        annotations:
          fluentbit.couchbase.com/mem.buf.limits.enabled: "true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://docs.fluentbit.io/manual/administration/backpressure#mem_buf_limit" target="_blank" rel="noopener">Fluent Bit Memory Buffer Limits</a> and <a href="https://docs.fluentbit.io/manual/administration/buffering-and-storage" target="_blank" rel="noopener">Fluent Bit Buffering and Storage</a> from more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-default-log-forwarding"><a class="anchor" href="#using-default-log-forwarding"></a>Using Default Log Forwarding</h3>
<div class="paragraph">
<p>A Couchbase deployment is considered to be using <em>default log forwarding</em> when the Couchbase-supplied defaults for both the <em>log processor image</em> and the <em>log forwarding configuration</em> are being used.</p>
</div>
<div class="listingblock">
<div class="title"><a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> Parameters Involved with Default Log Forwarding</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
spec:
  logging:
    server:
      enabled: true
      manageConfiguration: true <i class="conum" data-value="1"></i><b>(1)</b>
      configurationName: “fluent-bit-config” <i class="conum" data-value="2"></i><b>(2)</b>
      sidecar:
        image: couchbase/fluent-bit:1.2.0” <i class="conum" data-value="3"></i><b>(3)</b>
        configurationMountPath: “/fluent-bit/config/”
        resources:
          requests:
            cpu: 100m
            memory: 500Mi</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a>: When this field is set to <code>true</code> (the default), the Autonomous Operator ensures that the <code>logging</code> sidecar container always uses the default log forwarding configuration.
The Autonomous Operator accomplishes this by creating a Secret that contains the default log forwarding configuration, which is then consumed by the <code>logging</code> sidecar container.
The name of the Secret will be whatever name is specified in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a>.
If a Secret already exists with the same name, the Autonomous Operator overwrites it, ensuring that the default log forwarding configuration is maintained.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a>: This field defines the name of the Secret that contains the log forwarding configuration that will be consumed by the <code>logging</code> sidecar container.
This field defaults to <code>fluent-bit-config</code> and will be the name of the Secret that gets automatically created by the Autonomous Operator when <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> is set to <code>true</code>.
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If running multiple clusters in the same Kubernetes namespace, make sure to use a different name for the Secret of each cluster rather than attempting to share the same Kubernetes Secret.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.image</code></a>: This field specifies the container image that the Autonomous Operator will use for deploying the <code>logging</code> sidecar container.
This field defaults to <code>couchbase/fluent-bit:1.2.0</code>, which pulls the Couchbase-supplied <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a>.
You may need to modify this field if your Kubernetes nodes can&#8217;t pull from the Docker public registry.
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> is set to <code>true</code>, then the default log processor image supplied by Couchbase (or an image that is effectively equivalent) must also be used.
This is because the default log forwarding configuration requires certain features that are a part of the default image.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, this configuration will only output to the standard console output, however, there are other output plugins included that do not match any existing streams.
It is possible to enable matching of streams to output plugins by setting the  <code>fluentbit.couchbase.com/&lt;PLUGIN&gt;_MATCH</code> annotation.
The following is an example for Loki usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>      pod:
        metadata:
          annotations:
            fluentbit.couchbase.com/loki.match: "*"
            fluentbit.couchbase.com/loki.host: loki.monitoring</pre>
</div>
</div>
<div class="paragraph">
<p>Other supported output plugins include Elasticsearch and Splunk.
See <a href="https://github.com/couchbase/couchbase-fluent-bit#configuration" target="_blank" rel="noopener">Configuring Couchbase Fluent Bit</a> for more detailed output configuration options.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-custom-log-forwarding"><a class="anchor" href="#using-custom-log-forwarding"></a>Using Custom Log Forwarding</h3>
<div class="paragraph">
<p>A Couchbase deployment is considered to be using <em>custom log forwarding</em> when either a custom <em>log processor image</em> and/or a custom <em>log forwarding configuration</em> is being used for log forwarding.</p>
</div>
<div class="listingblock">
<div class="title"><a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> Parameters Involved with Custom Log Forwarding</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
spec:
  logging:
    server:
      enabled: true
      manageConfiguration: false <i class="conum" data-value="1"></i><b>(1)</b>
      configurationName: fluent-bit-config” <i class="conum" data-value="2"></i><b>(2)</b>
      sidecar:
        image: couchbase/fluent-bit:1.2.0” <i class="conum" data-value="3"></i><b>(3)</b>
        configurationMountPath: “/fluent-bit/config/” <i class="conum" data-value="4"></i><b>(4)</b>
        resources:
          requests:
            cpu: 100m
            memory: 500Mi</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a>: When this field is set to <code>false</code> (defaults to <code>true</code>), the Autonomous Operator allows the Secret specified in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a> to contain a non-default log forwarding configuration.
This field <em>must</em> be set to <code>false</code> in order to use a custom log forwarding configuration, otherwise the Autonomous Operator will always reconcile and update the Secret with the <em>default</em> log forwarding configuration.
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> was ever set to <code>true</code> when you enabled log forwarding, then the Autonomous Operator will have already created the default Secret.
In this situation, if you were to then set this field to <code>false</code>, the <code>logging</code> sidecar container would continue to consume the default Secret.
You could then choose to add your custom log forwarding configuration to this same Secret.
However, if you were to change <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a> to point to a different Secret, it won&#8217;t get picked up until the next time a pod starts.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a>: This field defines the name of the Secret that contains the <em>custom</em> log forwarding configuration that will be consumed by the <code>logging</code> sidecar container.
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
When <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> is set to <code>false</code>, then <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a> <em>must</em> specify the name of a Secret that currently exists in the same namespace.
Otherwise, <em>new Couchbase pods will not start</em>, since they will be waiting on a non-existent Secret.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since the log forwarding configuration is stored in a Secret, it can be shared by two or more Couchbase clusters in the same namespace.
This has the benefit of allowing you to manage a single log forwarding configuration for multiple clusters.
However, when sharing a <em>custom</em> log forwarding configuration between clusters, it&#8217;s important to remember that setting <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> to <code>true</code> on any of the clusters will overwrite the shared Secret with the <em>default</em> log forwarding configuration.
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.image</code></a>: If desired, you can use this field to specify a custom log processing image.
A few reasons for specifying a custom image include adding certificates for self-signed endpoints internally, or using another implementation of either the Fluent Bit image or any other log forwarder/processor.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-configurationmountpath" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.configurationMountPath</code></a>: This field defines the location to mount the Secret into the <code>logging</code> sidecar container.
This field currently defaults to the usual Fluent Bit mount path (<code>/fluent-bit/config/</code>).
This field only needs to be modified if a custom image is specified in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.image</code></a>, and only if that image requires a non-default mount path.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-custom-log-forwarding-configuration"><a class="anchor" href="#creating-a-custom-log-forwarding-configuration"></a>Creating a Custom Log Forwarding Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since a log forwarding configuration can contain sensitive information, it is stored in a Kubernetes Secret.
The Secret is used to <a href="https://kubernetes.io/docs/concepts/configuration/secret/#restrictions" target="_blank" rel="noopener">populate the volume mounted into the sidecar</a> so that the actual <em>configuration files</em> get picked up by the log processor.</p>
</div>
<div class="paragraph">
<p>When <a href="#using-default-log-forwarding">using default log forwarding</a>, the Autonomous Operator automatically creates a Secret named <code>fluent-bit-config</code> that contains the default log forwarding configuration.
This configuration, which can be viewed on <a href="https://github.com/couchbase/couchbase-fluent-bit/blob/main/conf/fluent-bit.conf" target="_blank" rel="noopener">GitHub</a>, is used by the Couchbase-supplied <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a> in order to provide features like automatic <em>parsing</em> of a number of supported logs, automatic <em>filtering</em> for adding useful information to the logs (e.g. pod host names), as well as optional log <em>redaction</em> (another type of filtering).</p>
</div>
<div class="paragraph">
<p>When <a href="#using-custom-log-forwarding">using <em>custom</em> log forwarding</a>, the Autonomous Operator does <em>not</em> automatically create a log forwarding configuration Secret.
Instead, the administrator is expected to create a custom Secret themselves, and specify that Secret in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a>.</p>
</div>
<div class="paragraph">
<p>The rest of this section covers some relatively simple ways in which you can customize the default log forwarding configuration, such as limiting the number of forwarded logs, and enabling log redaction.
However, since the Couchbase-supplied log processor image is based on Fluent Bit, you can technically customize the log forwarding configuration with any kind of configuration that is <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit" target="_blank" rel="noopener">supported by Fluent Bit</a>.
Some examples of these types of customizations are covered in the tutorial <a href="howto-couchbase-log-forwarding.html" class="xref page">Configure Log Forwarding</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only custom configurations that leverage the built-in parsing, redaction, and other standard features of the Couchbase-supplied log processor image are supported.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="create-custom-log-forwarding-config-secret"><a class="anchor" href="#create-custom-log-forwarding-config-secret"></a>Creating a Secret That Contains a Custom Log Forwarding Configuration</h3>
<div class="paragraph">
<p>The following is an example of a custom log forwarding configuration Secret that is based on the <a href="https://github.com/couchbase/couchbase-fluent-bit/blob/main/conf/fluent-bit.conf" target="_blank" rel="noopener">default configuration</a>, but which limits the number of Couchbase logs that are processed and forwarded to just the Couchbase <a href="howto-manage-couchbase-logging.html#configuring-audit-logging" class="xref page">audit log</a>:</p>
</div>
<div id="custom-log-forwarding-config-secret" class="listingblock">
<div class="title">Example: Custom Log Forwarding Configuration Secret</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: fluent-bit-config <i class="conum" data-value="1"></i><b>(1)</b>
stringData:
  fluent-bit.conf: | <i class="conum" data-value="2"></i><b>(2)</b>
    [SERVICE]
        flush        1
        daemon       Off
        log_level    Warning
        parsers_file /fluent-bit/etc/parsers-couchbase.conf <i class="conum" data-value="3"></i><b>(3)</b>

    # @include /fluent-bit/etc/couchbase/in-*.conf <i class="conum" data-value="4"></i><b>(4)</b>
    @include /fluent-bit/etc/couchbase/in-audit-log.conf <i class="conum" data-value="5"></i><b>(5)</b>

    [FILTER]
        Name modify
        Match couchbase.log.*
        Add pod ${HOSTNAME}
        Add logshipper couchbase.sidecar.fluentbit

    [OUTPUT] <i class="conum" data-value="6"></i><b>(6)</b>
        name  stdout
        match couchbase.log.audit <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>metadata.name</code>: The Autonomous Operator expects the default name <code>fluent-bit-config</code>.
If you use a different name, then you will need to specify that name in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>stringData.fluent-bit.conf</code>: Log forwarding configuration files are defined here in the <code>stringData</code> field of the Secret (the <code>data</code> field is also <a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="noopener">potentially an option</a>).
The <code>fluent-bit.conf</code> file is specified with a field that starts with a space and a vertical bar (<code>|</code>), followed by the contents of the <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file" target="_blank" rel="noopener"><em>main configuration</em></a>.
Note that Fluent Bit is very particular about its <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/format-schema" target="_blank" rel="noopener">format and schema</a>&#8201;&#8212;&#8201;files must all follow the same indentation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>/fluent-bit/etc/parsers-couchbase.conf</code>: This is the path to the built-in file that contains all of the default <a href="https://docs.fluentbit.io/manual/pipeline/filters/parser" target="_blank" rel="noopener"><em>parser configurations</em></a> in the Couchbase-supplied log processor image (you can view this file on <a href="https://github.com/couchbase/couchbase-fluent-bit/blob/main/conf/parsers-couchbase.conf" target="_blank" rel="noopener">GitHub</a>).
<div class="paragraph">
<p>You should only have to modify this if you&#8217;re using a custom log processor image that invokes a parser file from a different location.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>@include /fluent-bit/etc/couchbase/in-*.conf</code>: This is the default <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file#config_input" target="_blank" rel="noopener"><em>input configuration</em></a> that processes most Couchbase logs.
Since the example is meant to only process the Couchbase audit log, this line is commented out.
<div class="paragraph">
<p>Couchbase logs are supported by individual <em>input configurations</em>, with those that are <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file#config_include_file-1" target="_blank" rel="noopener"><em>included</em></a> in the default configuration being prefixed with <code>in-</code>.
Therefore by including a wildcard <code>in-*.conf</code>, all default input configurations are invoked.</p>
</div>
<div class="paragraph">
<p>Some logs are not included by default.
The individual input configurations for non-default logs are ones that are <em>not</em> prefixed with <code>in-</code>.
The reason that a particular log is left out of the default input configuration is often because the log has negligible value compared to the load that it puts on the log processor.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">About Input Configurations</div>
<div class="paragraph">
<p>Input configurations determine <em>which</em> Couchbase logs are processed, as well as some details about <em>how</em> they are processed.
A typical input configuration for a Couchbase log will specify (among other things): the input plugin (usually <a href="https://docs.fluentbit.io/manual/pipeline/inputs/tail" target="_blank" rel="noopener"><code>tail</code></a>), the logs that the input configuration applies to, the parsers to use on those logs, and the <a href="https://docs.fluentbit.io/manual/concepts/key-concepts#tag" target="_blank" rel="noopener">tags</a> to apply to those logs.</p>
</div>
<div class="paragraph">
<p>Each Couchbase log is supported by an input configuration, with many input configurations supporting more than one log.
The reason input configurations usually support more than one log is because certain logs are similar enough that they can share the same input plugin, parser(s), etc.
Across all available input configurations, each Couchbase logging event can be captured.</p>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>@include /fluent-bit/etc/couchbase/in-audit-log.conf</code>: This is the path to the built-in file that contains the input configuration that processes just the Couchbase audit log (you can view this file on <a href="https://github.com/couchbase/couchbase-fluent-bit/blob/main/conf/couchbase/in-audit-log.conf" target="_blank" rel="noopener">GitHub</a>).
Since this line is <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file#config_include_file-1" target="_blank" rel="noopener"><em>included</em></a>, and <code>@include /fluent-bit/etc/couchbase/in-\*.conf</code> is commented out, only the Couchbase audit log will be processed.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>A log forwarding configuration includes one or more <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/configuration-file#config_output" target="_blank" rel="noopener"><em>output configurations</em></a>.
The default output configuration forwards the processed logs to the <a href="https://docs.fluentbit.io/manual/pipeline/outputs/standard-output" target="_blank" rel="noopener">standard output</a> of the <code>logging</code> container.
<div class="paragraph">
<p>A log forwarding configuration can include more than one output configuration.
This allows for specific logs to be <a href="https://docs.fluentbit.io/manual/concepts/data-pipeline/router" target="_blank" rel="noopener"><em>routed</em></a> to different, or multiple, destinations.
For example, all Couchbase logs could be sent to standard output, with the Couchbase audit log also being sent to AWS S3.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>couchbase.log.audit</code>: By default, all parsed Couchbase log events are <a href="https://docs.fluentbit.io/manual/concepts/key-concepts#tag" target="_blank" rel="noopener"><em>tagged</em></a> with <code>couchbase.log.<em>&lt;name-of-log</em>&gt;</code>.
Therefore, specifying the <a href="https://docs.fluentbit.io/manual/concepts/key-concepts#match" target="_blank" rel="noopener"><em>match</em></a> <code>couchbase.log.audit</code> ensures that only Couchbase audit log events are sent to the specified output destination.
(The default output configuration normally uses the wildcard match <code>couchbase.log.*</code> to forward all tagged Couchbase logs to the output.)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can copy the <a href="#custom-log-forwarding-config-secret">example</a> Secret above and create it in your Kubernetes cluster for use with existing and future Couchbase cluster deployments.
However, please review <a href="#using-custom-log-forwarding">Using Custom Log Forwarding</a>, as there are a few things that you need to be aware of when creating a custom log forwarding configuration Secret.
In particular, you should make sure that any Couchbase cluster deployment that references the Secret in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-configurationname" class="xref page"><code>couchbaseclusters.spec.logging.server.configurationName</code></a> <em>also</em> has <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-manageconfiguration" class="xref page"><code>couchbaseclusters.spec.logging.server.manageConfiguration</code></a> set to <code>false</code>, otherwise the Autonomous Operator will overwrite the custom Secret with the <em>default</em> log forwarding configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="updating-existing-custom-log-forwarding-configuration"><a class="anchor" href="#updating-existing-custom-log-forwarding-configuration"></a>Updating an Existing Custom Log Forwarding Configuration</h3>
<div class="paragraph">
<p>Further updates can be made to a custom log forwarding configuration Secret, even after it has been <a href="#create-custom-log-forwarding-config-secret">created</a> in Kubernetes and consumed by the <code>logging</code> sidecar containers in Couchbase deployments.
Changing the Secret will update the volume in the sidecar, and when the configuration change is detected in the <a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-configurationmountpath" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.configurationMountPath</code></a> directory, the watcher process restarts Fluent Bit internally to pick it up without having to restart the entire Couchbase Server pod.</p>
</div>
<div class="paragraph">
<p>The ability to restart Fluent Bit internally is a special characteristic of the Couchbase-supplied <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a>.
If you&#8217;re using a custom sidecar container image, be aware that Fluent Bit, on its own, does not currently support <a href="https://github.com/fluent/fluent-bit/issues/365" target="_blank" rel="noopener">dynamic reload</a> of its configuration.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
The Couchbase-supplied log forwarding implementation does not currently support log buffering during restart.
Therefore, log events that occur while Fluent Bit is restarting may be lost.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-log-redaction"><a class="anchor" href="#configuring-log-redaction"></a>Configuring Log Redaction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Couchbase-supplied <a href="https://hub.docker.com/r/couchbase/fluent-bit" target="_blank" rel="noopener">log processor image</a> provides optional support for <a href="concept-couchbase-logging.html#log-redaction" class="xref page"><em>log redaction</em></a>, whereby sensitive data from Couchbase log events are redacted before the events are forwarded to standard console output or other locations.
Log redaction isn&#8217;t enabled by default, and therefore must be enabled via the <a href="#create-custom-log-forwarding-config-secret">log forwarding configuration Secret</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section describes how to configure the built-in LUA-based log redaction facility.
However, there are simpler, more rudimentary methods of performing log redaction that may be more desirable depending on the use-case.
Refer to log forwarding <a href="#">tutorial</a> for examples.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example is the same custom log forwarding configuration Secret from the section <a href="#create-custom-log-forwarding-config-secret">Creating a Secret That Contains a Custom Log Forwarding Configuration</a>, except that it is configured to additionally perform redaction of the audit log:</p>
</div>
<div id="custom-log-forwarding-config-secret-with-redaction" class="listingblock">
<div class="title">Example: Custom Log Forwarding Configuration That Redacts the Couchbase Audit Log</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: fluent-bit-config
stringData:
  fluent-bit.conf: |
    [SERVICE]
        flush        1
        daemon       Off
        log_level    Warning
        parsers_file /fluent-bit/etc/parsers-couchbase.conf

    @include /fluent-bit/etc/couchbase/in-audit-log.conf

    [FILTER]
        Name    lua
        Match   couchbase.log.audit <i class="conum" data-value="1"></i><b>(1)</b>
        script  /fluent-bit/etc/redaction/redaction.lua <i class="conum" data-value="2"></i><b>(2)</b>
        call    cb_sub_message <i class="conum" data-value="3"></i><b>(3)</b>

    [FILTER]
        Name modify
        Match couchbase.log.*
        Add pod ${HOSTNAME}
        Add logshipper couchbase.sidecar.fluentbit

    [OUTPUT]
        name  stdout
        match couchbase.log.audit <i class="conum" data-value="4"></i><b>(4)</b>

  redaction.salt: salty <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>couchbase.log.audit</code>: Log events that match this tag will be processed for redaction.
In this example, only events from the audit log will be processed.
To have all logs processed for redaction, you can specify the wildcard <code>couchbase.log.*</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>redaction.lua</code>: This is the path to the Couchbase-supplied <a href="https://github.com/couchbase/couchbase-fluent-bit/blob/main/redaction/redaction.lua" target="_blank" rel="noopener">LUA script file</a> in the default Couchbase-supplied log processor image.
You should only have to modify this if you&#8217;re using a custom log processor image that invokes a LUA script from a different location.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>cb_sub_message</code>: This is the function that is called within the Couchbase-supplied LUA script file.
You should only have to modify this if you&#8217;re using a custom log processor image and a custom LUA script.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>couchbase.log.audit</code>: Specifying <code>couchbase.log.audit</code> as the match ensures that only Couchbase audit log events are forwarded to standard console output.
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a means of reducing load on the <code>logging</code> container, it is recommended to only match the tags of the specific logs that you want to redact.
LUA scripting has an overhead and it is recommended to use at least one extra Fluent Bit worker thread if you enable redaction.</p>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>redaction.salt</code>: You can optionally define a custom salt for the hashing of tagged data.
The salt is specified in the configuration Secret as a separate file/value (in the example, the salt value is <code>salty</code>).
If a salt is not specified, the Autonomous Operator will default to using the cluster name as the salt.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After <a href="#updating-existing-custom-log-forwarding-configuration">updating</a> the log forwarding configuration with the <a href="#custom-log-forwarding-config-secret-with-redaction">example</a> above, you&#8217;ll notice output similar to the following, showing the redacted strings as hashes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[0] couchbase.log.audit: [1615320737.445039000, {"filename":"/fluent-bit/test/logs/audit.log","bucket":"default","description":"Cats are &lt;ud&gt;00b335216f27c1e7d35149b5bbfe19d4eb2d6af1&lt;/ud&gt; than dogs, and &lt;ud&gt;888f807d45ff6ce47240c7ed4e884a6f9dc7b4fb&lt;/ud&gt;","id":20492,"name":"select bucket","peername":"127.0.0.1:56021","real_userid":{"domain":"local","user":"@ns_server"},"sockname":"127.0.0.1:11209","timestamp":"2021-03-09T20:12:17.445039Z"}]</pre>
</div>
</div>
<div class="paragraph">
<p>One thing to note about the above configuration is that the log processor is <em>only</em> outputting a redacted version of the audit log.
There may be situations where it is desired to have the log processor output both a redacted <em>and</em> an unredacted version of a particular log.</p>
</div>
<div class="paragraph">
<p>The following is an example of a custom log forwarding configuration Secret that creates an additional stream of the Couchbase audit log that is then redacted and forwarded to a separate output:</p>
</div>
<div id="custom-log-forwarding-config-secret-with-redaction-multiple" class="listingblock">
<div class="title">Example: Custom Log Forwarding Configuration <em>with Separate Redaction Stream</em></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: fluent-bit-config
stringData:
  fluent-bit.conf: |
    [SERVICE]
        flush        1
        daemon       Off
        log_level    Warning
        parsers_file /fluent-bit/etc/parsers-couchbase.conf

    @include /fluent-bit/etc/couchbase/in-*.conf <i class="conum" data-value="1"></i><b>(1)</b>

    [FILTER]
        Name modify
        Match couchbase.log.*
        Add pod ${HOSTNAME}
        Add logshipper couchbase.sidecar.fluentbit

    [FILTER] <i class="conum" data-value="2"></i><b>(2)</b>
        Name rewrite_tag
        Match couchbase.log.audit
        Rule message .* couchbase.log.audit.redact true

    [FILTER] <i class="conum" data-value="3"></i><b>(3)</b>
        Name    lua
        Match   couchbase.log.*.redact
        script  /fluent-bit/etc/redaction/redaction.lua
        call    cb_sub_message

    [OUTPUT] <i class="conum" data-value="4"></i><b>(4)</b>
        name  stdout
        match couchbase.log.*

    [OUTPUT] <i class="conum" data-value="5"></i><b>(5)</b>
        Name                         s3
        Match                        couchbase.log.audit.redact
        bucket                       my-bucket
        region                       us-west-2
        total_file_size              250M
        s3_key_format                /$TAG[2]/$TAG[0]/%Y/%m/%d/%H/%M/%S
        s3_key_format_tag_delimiters .-

  redaction.salt: salty</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@include /fluent-bit/etc/couchbase/in-*.conf</code>: specifies the default input configuration that processes most Couchbase logs.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A <a href="https://docs.fluentbit.io/manual/pipeline/filters/rewrite-tag" target="_blank" rel="noopener">rewrite_tag</a> filter is defined in order to duplicate the Couchbase audit log events.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>Match  couchbase.log.audit</code>: specifies that only the events with the tag <code>couchbase.log.audit</code> are to be selected.</p>
</li>
<li>
<p><code>Rule message .* couchbase.log.audit.redact true</code>: specifies that a duplicate of each selected Couchbase audit log event is to be emitted with the new tag <code>couchbase.log.audit.redact</code>.
The final value in the rule&#8201;&#8212;&#8201;<code>true</code>&#8201;&#8212;&#8201;specifies that the events with the old tag (<code>couchbase.log.audit</code>) are to be preserved.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The final result is two streams of the same audit log events: one stream with the tag <code>couchbase.log.audit</code>, and another with the tag <code>couchbase.log.audit.redact</code>.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A <a href="https://docs.fluentbit.io/manual/pipeline/filters/lua" target="_blank" rel="noopener">LUA filter</a> is defined in order to perform redaction on one of the streams of audit log events.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>Match  couchbase.log.*.redact</code>: specifies that events with the tag suffix <code>.redact</code> are to be selected and subject to redaction.</p>
</li>
</ul>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An output configuration is defined that forwards all <em>unredacted</em> Couchbase log events to the <a href="https://docs.fluentbit.io/manual/pipeline/outputs/standard-output" target="_blank" rel="noopener">standard output</a> of the <code>logging</code> container.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>match  couchbase.log.*</code>: specifies that the log events with the wildcard tag <code>couchbase.log.*</code> are to be selected and forwarded.
Note that this includes the unredacted audit log events tagged <code>couchbase.log.audit</code>.</p>
</li>
</ul>
</div>
</div>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A second output configuration is defined that forwards <em>redacted</em> Couchbase audit log events to the <a href="https://docs.fluentbit.io/manual/pipeline/outputs/s3" target="_blank" rel="noopener">Amazon S3</a>.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>Match  couchbase.log.audit.redact</code>: specifies that only the audit log events with the tag <code>couchbase.log.audit.redact</code> (the ones that have been redacted) are to be selected and forwarded.</p>
</li>
</ul>
</div>
</div>
</div></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-custom-log-processor-images"><a class="anchor" href="#about-custom-log-processor-images"></a>About Custom Log Processor Images</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A different container image may be used in order to implement your own log processor and forwarding configuration.
<a href="resource/couchbasecluster.html#couchbaseclusters-spec-logging-server-sidecar-image" class="xref page"><code>couchbaseclusters.spec.logging.server.sidecar.image</code></a> supports specifying a different image and/or version for log forwarding support.
For example, this field can be used to specify a custom image with self-signed certificates.
It can also be used to specify an image made available by a public cloud provider, such a <a href="https://github.com/aws/aws-for-fluent-bit" target="_blank" rel="noopener">AWS for Fluent Bit</a>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that the built-in parsing, redaction, and other configurations provided by the Couchbase-supplied log processor image are lost if a stock log processor image is used.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
