<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Configure Couchbase Cluster Auto-scaling | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/operator/2.3/howto-couchbase-autoscaling.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="operator">
<meta name="dcterms.identifier" content="2.3">
<meta name="page-url" content="/operator/2.3/howto-couchbase-autoscaling.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/couchbase-operator//docs/user/modules/ROOT/pages/howto-couchbase-autoscaling.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="overview.html">Autonomous Operator</a></li>
<li class="crumb">Manage</li>
<li class="crumb">Couchbase Cluster</li>
<li class="crumb">Configure</li>
<li class="crumb"><a href="howto-couchbase-autoscaling.html">Configure Couchbase Cluster Auto-scaling</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Couchbase Cluster Auto-scaling</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Configure Couchbase clusters to automatically scale based on observed usage metrics.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Autonomous Operator supports <a href="concept-mds.html" class="xref page">Multi-Dimensional Scaling</a> through independently-configurable server classes, which are <a href="howto-couchbase-scale.html" class="xref page">manually scalable</a> by default.
However, the Autonomous Operator optionally supports the automatic scaling of Couchbase clusters through an integration with the <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">Horizontal Pod Autoscaler (HPA)</a>.</p>
</div>
<div class="paragraph">
<p>The sections on this page describe how to enable and configure auto-scaling for Couchbase clusters managed by the Autonomous Operator.
For a conceptual description of this feature, please refer to <a href="concept-couchbase-autoscaling.html" class="xref page">Couchbase Cluster Auto-scaling</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="preparing-for-auto-scaling"><a class="anchor" href="#preparing-for-auto-scaling"></a>Preparing for Auto-scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Metrics play the most important role in Couchbase cluster auto-scaling.
Metrics provide the means for the Horizontal Pod Autoscaler to measure cluster performance and respond accordingly when target thresholds are crossed.</p>
</div>
<div class="paragraph">
<p>Auto-scaling can be configured to use <em>resource metrics</em> or <em>Couchbase metrics</em>.
Resource metrics include pod CPU and memory, whereas Couchbase metrics can be stats like bucket memory utilization and query latency.
Refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance on how various metrics can be used as a measure of cluster performance.</p>
</div>
<div class="paragraph">
<p>The Horizontal Pod Autoscaler can only monitor metrics through the Kubernetes API, therefore metrics affecting the Couchbase cluster must be exposed within the Kubernetes cluster before auto-scaling can be configured.
Refer to <a href="concept-couchbase-autoscaling.html#about-exposed-metrics" class="xref page">About Exposed Metrics</a> in the concept documentation for more information about how metrics can be exposed for the purposes of auto-scaling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-auto-scaling"><a class="anchor" href="#enabling-auto-scaling"></a>Enabling Auto-scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enabling auto-scaling for a particular Couchbase cluster starts with modifying the relevant <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource.</p>
</div>
<div class="paragraph">
<p>The required configuration parameters for enabling log forwarding are described in the example below.
(The Autonomous Operator will set the default values for any fields that are not specified by the user.)</p>
</div>
<div class="listingblock">
<div class="title">Basic <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> Auto-Scaling Parameters</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
metadata:
  name: cb-example
spec:
  servers:
  - name: data
    size: 3
    services:
    - data
  - name: index
    autoscaleEnabled: true <i class="conum" data-value="1"></i><b>(1)</b>
    size: 2
    services:
    - index
  - name: query
    autoscaleEnabled: true <i class="conum" data-value="2"></i><b>(2)</b>
    size: 2
    services:
    - query
  autoscaleStabilizationPeriod: 600s <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a>: Setting this field to <code>true</code> triggers the Autonomous Operator to create a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource for the relevant server class.
In this example, a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource will be created for the <code>index</code> server class.
Refer to <a href="concept-couchbase-autoscaling.html#about-the-couchbase-autoscaler" class="xref page">About the Couchbase Autoscaler</a> for a conceptual overview of the role the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource plays in auto-scaling.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In this example, a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource will also be created for the <code>query</code> server class.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-autoscalestabilizationperiod" class="xref page"><code>couchbaseclusters.spec.autoscaleStabilizationPeriod</code></a>: This field defines the <a href="concept-couchbase-autoscaling.html#couchbase-stabilization-period" class="xref page"><em>Couchbase Stabilization Period</em></a>, which is an internal safety mechanism provided by the Autonomous Operator that is meant to help prevent over-scaling caused by metrics instability during rebalance.
The value specified in this field determines how long <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resources will remain in <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#implicit-maintenance-mode-deactivation" target="_blank" rel="noopener"><em>maintenance mode</em></a> after the cluster finishes rebalancing.
<div class="paragraph">
<p>In this example, the stabilization period has been set to <code>600s</code>, which means that the Horizontal Pod Autoscaler will not restart monitoring until 10 minutes after the previous rebalance has completed.
Refer to <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a> for additional guidance on setting this value in production environments.</p>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After deploying the <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource specification, the Autonomous Operator will create a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource for each server class configuration that has <a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a> set to <code>true</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Enabling auto-scaling for a particular server class configuration <strong>does not</strong> immediately subject the cluster to being auto-scaled.
The <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource simply acts as an endpoint for the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource to access the pods that are selected for auto-scaling.
The <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource is only activated when <a href="#creating-a-horizontalpodautoscaler-resource">referenced</a> by a <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="verifying-creation-of-couchbaseautoscaler-resources"><a class="anchor" href="#verifying-creation-of-couchbaseautoscaler-resources"></a>Verifying Creation of <code>CouchbaseAutoscaler</code> Resources</h3>
<div class="paragraph">
<p>The following command can be used to verify that the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resources exist and match the size of their associated server class configurations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl get couchbaseautoscalers</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                               SIZE   SERVERS
index.cb-example                   2      index <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
query.cb-example                   2      query</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>NAME</code>: Each <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource is named using the format <code><em>&lt;server-class&gt;</em>.<em>&lt;couchbase-cluster&gt;</em></code>.
The name is important as it must be referenced when <a href="#creating-a-horizontalpodautoscaler-resource">creating the <code>HorizontalPodAutoscaler</code> resource</a> in order link the two resources together.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>SIZE</code>: This is the current number of Couchbase nodes that the Autonomous Operator is maintaining for the <code>index</code> server class.
The Autonomous Operator keeps the size of a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource in sync with the size of its associated server class configuration.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resources are fully managed by the Autonomous Operator and should not be manually created, modified, or deleted by the user.
If one is manually deleted, the Autonomous Operator will re-create it.
However, it is possible to edit the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> (refer to <a href="#scale-subresource">[scale-subresource]</a> below).</p>
</div>
<div class="paragraph">
<p>A <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource only gets deleted by the Autonomous Operator when <a href="#disabling-auto-scaling">auto-scaling is disabled</a> for the associated server class, or if the associated <a href="resource/couchbasecluster.html" class="xref page"><code>CouchbaseCluster</code></a> resource is deleted altogether.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-a-horizontalpodautoscaler-resource"><a class="anchor" href="#creating-a-horizontalpodautoscaler-resource"></a>Creating a <code>HorizontalPodAutoscaler</code> Resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Autonomous Operator relies on the Kubernetes <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener">Horizontal Pod Autoscaler (HPA)</a> to provide auto-scaling capabilities.
The Horizontal Pod Autoscaler is configured via a <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource, which is the primary interface by which auto-scaling is configured.
Unlike the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource created by the Autonomous Operator, the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource is created and managed by the user.</p>
</div>
<div class="paragraph">
<p>The following configuration represents an example to scale the server class from <a href="#enabling-auto-scaling">Enabling Auto-scaling</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: query-hpa
spec:
  scaleTargetRef: <i class="conum" data-value="1"></i><b>(1)</b>
    apiVersion: couchbase.com/v2
    kind: CouchbaseAutoscaler
    name: query.cb-example
  behavior: <i class="conum" data-value="2"></i><b>(2)</b>
    scaleUp:
      policies: <i class="conum" data-value="3"></i><b>(3)</b>
      - type: Pods
        value: 1
        periodSeconds: 15
      stabilizationWindowSeconds: 30 <i class="conum" data-value="4"></i><b>(4)</b>
    scaleDown:
      stabilizationWindowSeconds: 300
  minReplicas: 2 <i class="conum" data-value="5"></i><b>(5)</b>
  maxReplicas: 6
  metrics: <i class="conum" data-value="6"></i><b>(6)</b>
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>spec.scaleTargetRef</code> section must be configured to reference the relevant <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>apiVersion</code>: This field must be set to be set to <code>couchbase.com/v2</code>.</p>
</li>
<li>
<p><code>kind</code>: This field must be set to <code>CouchbaseAutoscaler</code>.</p>
</li>
<li>
<p><code>name</code>: This field must reference the unique <code>name</code> of the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource.
As discussed in the previous section, <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resources are automatically created by the Autonomous Operator using the name format <code><em>&lt;server-class&gt;</em>.<em>&lt;couchbase-cluster&gt;</em></code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="concept-couchbase-autoscaling.html#referencing-the-couchbase-autoscaler" class="xref page">Referencing the Couchbase Autoscaler</a> in the concept documentation for more detailed information about these fields.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Fine-grained <a href="concept-couchbase-autoscaling.html#scaling-behavior" class="xref page"><em>scaling behavior</em></a> is configured via <em>policies</em> specified in the <code>spec.behavior</code> section.
Different policies can be specified for scaling up (<code>behavior.scaleUp</code>) and scaling down (<code>behavior.scaleDown</code>).
If no user-supplied values are specified in <code>behavior</code> fields, then the <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#default-behavior" target="_blank" rel="noopener">default values</a> are used.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>spec.behavior.[].policies</code>: Scaling policies are made up of the following fields: <code>type</code>, <code>value</code>, and <code>periodSeconds</code>.
The recommended settings are <code>type: Pods</code> and <code>value: 1</code>, while leaving <code>periodSeconds</code> with the default value.
<div class="paragraph">
<p>Refer to <a href="concept-couchbase-autoscaling.html#scaling-policies" class="xref page">Scaling Policies</a> and <a href="concept-couchbase-autoscaling.html#scaling-increments" class="xref page">Scaling Increments</a> in the concept documentation for more detailed information about these fields.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>behavior.[].stabilizationWindowSeconds</code>: A <a href="concept-couchbase-autoscaling.html#horizontal-pod-stabilization" class="xref page"><em>stabilization window</em></a> can be configured as a means to control undesirable scaling caused by fluctuating metrics.
A minimum <code>scaleUp</code> stabilization window of 30 seconds is generally recommended, unless indicated otherwise in <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>spec.minReplicas</code> and <code>spec.maxReplicas</code> fields set the minimum and maximum number of Couchbase nodes for the associated server class.
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>minReplicas</code> sets the boundary for the number of Couchbase nodes that the associated server class can ever be down-scaled to, and defaults to <code>1</code>.
This field is important for maintaining service availability.</p>
</li>
<li>
<p><code>maxReplicas</code> sets the upper boundary for the number of Couchbase nodes that the associated server class can ever be up-scaled to, and cannot be set to a value lower than what is defined for <code>minReplicas</code>.
This field is <em>required</em>, as it provides important protection against runaway scaling events.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Refer to <a href="concept-couchbase-autoscaling.html#sizing-constraints" class="xref page">Sizing Constraints</a> in the concept documentation for more detailed information about these fields.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>spec.metrics</code> section must target a specific <em>metric</em>, along with an associated <em>threshold</em> for that metric.
In this example, a Kubernetes resource metric (<code>cpu</code>) is being targeted with a threshold set to <code>70</code> percent utilization.
<div class="paragraph">
<p>Refer to <a href="concept-couchbase-autoscaling.html#target-metrics-and-thresholds" class="xref page">Target Metrics and Thresholds</a> in the concept documentation for more detailed information about targeting metrics in the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource.</p>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource can be created like any other resource by submitting the specifications in a file using <code>kubectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl create -f query-hpa.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>As soon as the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource has been successfully created, the Horizontal Pod Autoscaler will begin to monitor the target metric and the cluster will be subject to auto-scaling if the targeted metric is above or below the configured threshold.</p>
</div>
<div class="sect2">
<h3 id="verifying-horizontalpodautoscaler-status"><a class="anchor" href="#verifying-horizontalpodautoscaler-status"></a>Verifying <code>HorizontalPodAutoscaler</code> Status</h3>
<div class="paragraph">
<p>When the Horizontal Pod Autoscaler begins to monitor the target metric, it will begin reporting the value of metric along with the current vs desired size of the server class.</p>
</div>
<div class="paragraph">
<p>Run the following command to print these details to the console output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl describe hpa query-hpa</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Metrics:                                               ( current / target )
  resource cpu on pods  (as a percentage of request):  1% (50m) / 70% <i class="conum" data-value="1"></i><b>(1)</b>
Min replicas:                         2
Max replicas:                         6
CouchbaseAutoscaler pods:             2 current / 2 desired  <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>current</code> observed value of the metric is displayed vs the <code>target</code> threshold.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>current</code> size of the server class is displayed vs the <code>desired</code> size currently being recommended by the Horizontal Pod Autoscaler.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disabling-scale-down"><a class="anchor" href="#disabling-scale-down"></a>Disabling Scale Down</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In production environments, it may be desirable to only allow a cluster to automatically scale up while requiring manual intervention to scale down.
This can be accomplished by modifying the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: example-hpa
spec:
  behavior:
    scaleDown:
      selectPolicy: Disabled <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>spec.behavior.[].selectPolicy</code>: This field controls which policy is chosen by the Horizontal Pod Autoscaler if more than one policy is defined.
When set to <code>Disabled</code> no policy is chosen, and therefore auto-scaling is disabled in that direction.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By setting <code>spec.behavior.scaleDown.selectPolicy</code> to <code>Disabled</code>, the Horizontal Pod Autoscaler will never recommend scaling down the associated server class.
Specifying this setting for all <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resources associated with a particular Couchbase cluster ensures that the cluster will never automatically scale down.</p>
</div>
<div class="paragraph">
<p>Clusters that have automatic down-scaling disabled can be manually scaled down by editing the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ kubectl scale --replicas=2 query.cb-example</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command edits the <a href="concept-couchbase-autoscaling.html#scale-subresource" class="xref page"><em>scale subresource</em></a> and results in the Autonomous Operator scaling the server class named <code>query</code> to a size of <code>2</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disabling-auto-scaling"><a class="anchor" href="#disabling-auto-scaling"></a>Disabling Auto-scaling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Auto-scaling, having been <a href="#enabling-auto-scaling">enabled</a> and configured for a Couchbase cluster, can subsequently be <em>disabled</em>.</p>
</div>
<div class="paragraph">
<p>The recommended method for disabling auto-scaling is to set <a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a> back to <code>false</code> for each of the desired server classes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: couchbase.com/v2
kind: CouchbaseCluster
metadata:
  name: cb-example
spec:
  servers:
  - name: index
    autoscaleEnabled: false <i class="conum" data-value="1"></i><b>(1)</b>
    size: 2
    services:
    - index
  - name: query
    autoscaleEnabled: false
    size: 2
    services:
    - query</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a>: Setting this field to <code>false</code> triggers the Autonomous Operator to delete the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> custom resource that had previously been created for the relevant server class.
In this example, the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource associated with the <code>index</code> server class will be deleted by the Autonomous Operator upon submitting the configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Upon deleting the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource, the Autonomous Operator will no longer reconcile the current size of the server class with the recommendations of the Horizontal Pod Autoscaler, and instead the value specified in <a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-size" class="xref page"><code>couchbaseclusters.spec.servers.size</code></a> will become the new source of truth.
For example, if the above configuration were to be submitted, it would result in the <code>index</code> and <code>query</code> server classes each being scaled to <code>size: 2</code> from whatever size they had previously been auto-scaled to.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note, however, that the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource is not managed by the Autonomous Operator, and therefore does not get deleted along with the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource.
It will continue to exist in the current namespace until it is manually deleted by the user.
Since the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource can continue to be used if auto-scaling is subsequently re-enabled, it is important to <a href="#verifying-horizontalpodautoscaler-status">verify the status</a> of the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource to ensure that it is persisted as expected.</p>
</div>
<div class="paragraph">
<p>If the desire is to only temporarily disable auto-scaling, the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource can be left to persist until auto-scaling is eventually re-enabled.
This only works if the names of both the server class and the Couchbase cluster remain the same, because when <a href="resource/couchbasecluster.html#couchbaseclusters-spec-servers-autoscaleenabled" class="xref page"><code>couchbaseclusters.spec.servers.autoscaleEnabled</code></a> is set back to <code>true</code>, the Autonomous Operator will create a <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource that is already <a href="concept-couchbase-autoscaling.html#referencing-the-couchbase-autoscaler" class="xref page">referenced</a> by the existing <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource.
In this case, the cluster will immediately become subject to the recommendations of the Horizontal Pod Autoscaler.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Deleting just the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#horizontalpodautoscaler-v2beta2-autoscaling" target="_blank" rel="noopener"><code>HorizontalPodAutoscaler</code></a> resource will also have the effect of "disabling" auto-scaling.
In this scenario, the Autonomous Operator continues to maintain the <a href="resource/couchbaseautoscaler.html" class="xref page"><code>CouchbaseAutoscaler</code></a> resource, but it will remain at the same size that was last recommended by the Horizontal Pod Autoscaler before it was deleted.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-links"><a class="anchor" href="#related-links"></a>Related Links</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>Learn</strong>: <a href="concept-couchbase-autoscaling.html" class="xref page">Couchbase Cluster Auto-scaling</a></p>
</li>
<li>
<p><strong>Learn</strong>: <a href="concept-couchbase-autoscaling-best-practices.html" class="xref page">Couchbase Cluster Auto-scaling Best Practices</a></p>
</li>
<li>
<p><strong>Tutorial</strong>: <a href="tutorial-autoscale-query.html" class="xref page">Auto-scaling the Couchbase Query Service</a></p>
</li>
<li>
<p><strong>Tutorial</strong>: <a href="tutorial-autoscale-data.html" class="xref page">Auto-scaling the Couchbase Data Service</a></p>
</li>
<li>
<p><strong>Tutorial</strong>: <a href="tutorial-autoscale-index.html" class="xref page">Auto-scaling the Couchbase Index Service</a></p>
</li>
<li>
<p><strong>Reference</strong>: <a href="resource/couchbaseautoscaler.html" class="xref page">CouchbaseAutoscaler Resource</a></p>
</li>
<li>
<p><strong>Reference</strong>: <a href="reference-couchbasecluster-events.html#autoscaling-lifecycle" class="xref page">Auto-scaling Lifecycle Events</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Autonomous Operator","components":["operator"],"latestVersions":{"operator":"2.3"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
