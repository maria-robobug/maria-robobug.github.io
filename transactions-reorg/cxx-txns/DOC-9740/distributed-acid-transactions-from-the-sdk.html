<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Distributed Transactions from the C++ SDK | Couchbase Docs (Local)</title>
<link rel="canonical" href="https://maria-robobug.github.io/cxx-txns/DOC-9740/distributed-acid-transactions-from-the-sdk.html">
<link rel="stylesheet" href="../../_/css/site.css">
<script src="../../_/js/vendor/jquery.js"></script>
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="cxx-txns">
<meta name="dcterms.identifier" content="DOC-9740">
<meta name="page-url" content="/cxx-txns/DOC-9740/distributed-acid-transactions-from-the-sdk.html">
<meta name="generator" content="Antora 3.0.1">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
</head>
<body class="article">
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://maria-robobug.github.io/home/index.html">
                    <img src="../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://maria-robobug.github.io/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud/index.html">
                      Capella
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../cloud-native-database/index.html">
                      Cloud-Native
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../home/sdk.html">
                      SDKs
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="2">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="distributed-acid-transactions-from-the-sdk.html">C++ Transactions</a></li>
<li class="crumb">C++ Distributed ACID Transactions</li>
<li class="crumb"><a href="distributed-acid-transactions-from-the-sdk.html">Transactions Howto</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Distributed Transactions from the C++ SDK</h1>
</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
A practical guide to using Couchbase&#8217;s distributed ACID transactions, via the C++ API.
</blockquote>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>The C&#43;&#43; Transactions API is built upon the Couchbase C SDK, <em>libcouchbase</em> (LCB), which is automatically installed by the transactions library.
Applications built using C SDK and C Transactions can run in parallel without interfering with each other.</p>
</div>
<div class="paragraph">
<p>Below we show you how to create Transactions, step-by-step.
You may also want to start with our <a href="https://github.com/couchbaselabs/couchbase-transactions-cxx-examples">transactions examples repository</a>,
which features useful downloadable examples of using Distributed Transactions.</p>
</div>
<div class="paragraph">
<p>API docs are available <a href="https://docs.couchbase.com/sdk-api/couchbase-transactions-cxx-1.0.0/index.html">online</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="requirements"><a class="anchor" href="#requirements"></a>Requirements</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Couchbase Server 6.6.1 or above.
Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase transactions require no additional components or services to be configured.
Simply add the transactions library into your project.
The latest version, as of 19 April 2021, is 1.0.0.</p>
</div>
<div class="sect2">
<h3 id="installing-on-linux"><a class="anchor" href="#installing-on-linux"></a>Installing on Linux</h3>
<div class="paragraph">
<p>We are currently distributing our linux libraries in tar files, which can be found:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RHEL7/Centos7 - <code><a href="https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0-1.253.el7.x86_64.tar" class="bare">https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0-1.253.el7.x86_64.tar</a></code></p>
</li>
<li>
<p>RHEL8/Centos8 - <code><a href="https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0-1.253.el8.x86_64.tar" class="bare">https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0-1.253.el8.x86_64.tar</a></code></p>
</li>
<li>
<p>Debian10 - <code><a href="https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0~r253-debian10-buster.tar" class="bare">https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0~r253-debian10-buster.tar</a></code></p>
</li>
<li>
<p>Ubuntu 20.04 - <code><a href="https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0~r253-ubuntu2004-focal.tar" class="bare">https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0~r253-ubuntu2004-focal.tar</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following steps show how to install transactions on RHEL/CentOS 8.  Other linux platforms will be similar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ sudo yum groupinstall "Development Tools"
$ sudo yum install boost-devel</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ wget https://packages.couchbase.com/clients/transactions-cxx/couchbase-transactions-1.0.0-1.253.el8.x86_64.tar
$ tar xf couchbase-transactions-1.0.0-1.253.el8.x86_64.tar
$ sudo yum install couchbase-transactions*.rpm</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-on-mac-os-x"><a class="anchor" href="#installing-on-mac-os-x"></a>Installing on Mac OS X</h3>
<div class="paragraph">
<p>Mac libraries are available through <a href="https://brew.sh">homebrew</a>.  Once you have homebrew,
add our tap, and install:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ brew tap couchbaselabs/homebrew-couchbase-transactions-cxx
$ brew install couchbase-transactions-cxx</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-and-run-example-project"><a class="anchor" href="#build-and-run-example-project"></a>Build and run example project</h3>
<div class="paragraph">
<p>On Linux or Mac OSX, building and running the example project is the same:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">$ git clone git://github.com/couchbaselabs/couchbase-transactions-cxx-examples.git
$ cd couchbase-transactions-cxx-examples/game/
$ mkdir build &amp;&amp; cd build
$ cmake ../
$ make</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initializing-transactions"><a class="anchor" href="#initializing-transactions"></a>Initializing Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The starting point is the <code>transactions</code> object.
It is very important that the application ensures that only one of these is created, as it performs automated background processes that should not be duplicated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L147-L153">// Initialize the Couchbase cluster
couchbase::cluster cluster("couchbase://localhost", "transactor", "mypass");
auto bucket = cluster.bucket("transact");
auto collection = bucket-&gt;default_collection();

// Create the single Transactions object
couchbase::transactions::transactions transactions(cluster, {});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transactions can optionally be configured at the point of creating the <code>transactions</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L158-L160">couchbase::transactions::transaction_config configuration;
configuration.durability_level(couchbase::transactions::durability_level::PERSIST_TO_MAJORITY);
couchbase::transactions::transactions transactions(cluster, configuration);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L184-L197">try {
    transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
        // 'ctx' permits getting, inserting, removing and replacing documents,
        // along with committing and rolling back the transaction

        // ... Your transaction logic here ...

        // This call is optional -- if you leave it off,
        // the transaction will be committed anyway.
        ctx.commit();
    });
} catch (couchbase::transactions::transaction_failed&amp; e) {
    std::cerr &lt;&lt; "Transaction did not reach commit point: " &lt;&lt; e.what() &lt;&lt; "\n";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L203-L233">try {
    transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
        // Inserting a doc:
        ctx.insert(collection, "doc-a", nlohmann::json({}));

        // Getting documents:
        // Use ctx.get_optional() if the document may or may not exist
        auto doc_opt = ctx.get_optional(collection, "doc-a");
        if (doc_opt) {
            couchbase::transactions::transaction_get_result&amp; doc = doc_opt.value();
        }

        // Use ctx.get if the document should exist, and the transaction
        // will fail if it does not
        couchbase::transactions::transaction_get_result doc_a = ctx.get(collection, "doc-a");

        // Replacing a doc:
        couchbase::transactions::transaction_get_result doc_b = ctx.get(collection, "doc-b");
        nlohmann::json content = doc_b.content&lt;nlohmann::json&gt;();
        content["transactions"] = "are awesome";
        ctx.replace(collection, doc_b, content);

        // Removing a doc:
        couchbase::transactions::transaction_get_result doc_c = ctx.get(collection, "doc-c");
        ctx.remove(collection, doc_c);

        ctx.commit();
    });
} catch (couchbase::transactions::transaction_failed&amp; e) {
    std::cerr &lt;&lt; "Transaction did not reach commit point: " &lt;&lt; e.what() &lt;&lt; "\n";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="key-value-mutations"><a class="anchor" href="#key-value-mutations"></a>Key-Value Mutations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="replacing"><a class="anchor" href="#replacing"></a>Replacing</h3>
<div class="paragraph">
<p>Replacing a document requires a <code>ctx.get()</code> call first.
This is necessary to ensure that the document is not involved in another transaction.
(If it is, then the transaction will handle this, generally by rolling back what has been done so far, and retrying the lambda.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L277-L283">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    std::string id = "doc-a";
    couchbase::transactions::transaction_get_result doc = ctx.get(collection, id);
    nlohmann::json content = doc.content&lt;nlohmann::json&gt;();
    content["transactions"] = "are awesome";
    ctx.replace(collection, doc, content);
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="removing"><a class="anchor" href="#removing"></a>Removing</h3>
<div class="paragraph">
<p>As with replaces, removing a document requires a <code>ctx.get()</code> call first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L289-L295">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    std::string id = "doc-a";
    auto doc_opt = ctx.get_optional(collection, id);
    if (doc_opt) {
        ctx.remove(collection, doc_opt.value());
    }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inserting"><a class="anchor" href="#inserting"></a>Inserting</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L239-L245">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    std::string id = "doc_id";
    nlohmann::json value{
        { "foo", "bar" },
    };
    ctx.insert(collection, id, value);
});</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="key-value-reads"><a class="anchor" href="#key-value-reads"></a>Key-Value Reads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two ways to get a document, <code>get</code> and <code>getOptional</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L251-L257">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    std::string id = "doc-a";
    auto doc_opt = ctx.get_optional(collection, id);
    if (doc_opt) {
        couchbase::transactions::transaction_get_result&amp; doc = doc_opt.value();
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>get</code> will cause the transaction to fail with <code>transaction_failed</code> (after rolling back any changes, of course).
It is provided as a convenience method so the developer does not have to check the <code>optional</code> if the document must exist for the transaction to succeed.</p>
</div>
<div class="paragraph">
<p>Gets will 'read your own writes', e.g. this will succeed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L263-L271">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    std::string id = "doc_id";
    nlohmann::json value{
        { "foo", "bar" },
    };
    ctx.insert(collection, id, value);
    // document must be accessible
    couchbase::transactions::transaction_get_result doc = ctx.get(collection, id);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="committing"><a class="anchor" href="#committing"></a>Committing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Committing is automatic: if there is no explicit call to <code>ctx.commit()</code> at the end of the transaction logic callback, and no exception is thrown, it will be committed.</p>
</div>
<div class="paragraph">
<p>As soon as the transaction is committed, all its changes will be atomically visible to reads from other transactions.
The changes will also be committed (or "unstaged") so they are visible to non-transactional actors, in an eventually consistent fashion.</p>
</div>
<div class="paragraph">
<p>Commit is final: after the transaction is committed, it cannot be rolled back, and no further operations are allowed on it.</p>
</div>
<div class="paragraph">
<p>An asynchronous cleanup process ensures that once the transaction reaches the commit point, it will be fully committed - even if the application crashes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="threads"><a class="anchor" href="#threads"></a>Threads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>cluster</code>, <code>bucket</code>, <code>collection</code>, and  <code>transactions</code> objects all are safe to use across multiple threads.  When creating
the <code>cluster</code>, you can specify the maximum number of <code>libcouchbase</code> instances the <code>cluster</code> and <code>bucket</code> can use.  Transactions
currently only using KV operations from the <code>bucket</code>.  Specifying <code>max_bucket_instances</code> in the <code>cluster_options</code> when creating
the <code>cluster</code> is sufficient.  This will be the maximum number of concurrent transaction operations which can be made:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L317-L318">couchbase::cluster c("couchbase://localhost", "transactor", "mypass", cluster_options().max_bucket_instances(10));
auto coll = c.bucket("transact")-&gt;default_collection();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example below allows for up to 10 instances to be created, then has 10 threads <code>get</code> and <code>replace</code> the content in a document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L322-L339">std::list&lt;std::thread&gt; threads;
std::atomic&lt;int&gt; counter {0};
for (int i=0; i&lt;10; i++) {
  threads.emplace_back([&amp;]() {
    transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
      std::string id = "doc_a";
      auto doc = ctx.get(coll, id);
      auto doc_content = doc.value();
      doc_content["counter"] = ++counter;
      ctx.replace(coll, doc, doc_content);
    });
  });
}
for (auto&amp; t: threads) {
  if (t.joinable()) {
    t.join();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>A complete version of this example is available on our <a href="https://github.com/couchbaselabs/couchbase-transactions-cxx-examples">GitHub transactions examples page</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L95-L134">try {
    transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
        auto monster = ctx.get(collection, monster_id);
        const Monster&amp; monster_body = monster.content&lt;Monster&gt;();

        int monster_hitpoints = monster_body.hitpoints;
        int monster_new_hitpoints = monster_hitpoints - damage;

        auto player = ctx.get(collection, player_id);

        if (monster_new_hitpoints &lt;= 0) {
            // Monster is killed. The remove is just for demoing, and a more realistic examples would set a "dead" flag or similar.
            ctx.remove(collection, monster);

            const Player&amp; player_body = player.content&lt;Player&gt;();

            // the player earns experience for killing the monster
            int experience_for_killing_monster = monster_body.experience_when_killed;
            int player_experience = player_body.experience;
            int player_new_experience = player_experience + experience_for_killing_monster;
            int player_new_level = calculate_level_for_experience(player_new_experience);

            Player player_new_body = player_body;
            player_new_body.experience = player_new_experience;
            player_new_body.level = player_new_level;
            ctx.replace(collection, player, player_new_body);
        } else {
            Monster monster_new_body = monster_body;
            monster_new_body.hitpoints = monster_new_hitpoints;
            ctx.replace(collection, monster, monster_new_body);
        }
    });
} catch (couchbase::transactions::transaction_failed&amp; e) {
    // The operation failed. Both the monster and the player will be untouched

    // Situations that can cause this would include either the monster
    // or player not existing (as get is used), or a persistent
    // failure to be able to commit the transaction, for example on
    // prolonged node failure.
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concurrency-with-non-transactional-writes"><a class="anchor" href="#concurrency-with-non-transactional-writes"></a>Concurrency with Non-Transactional Writes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This release of transactions for Couchbase requires a degree of co-operation from the application.
Specifically, the application should ensure that non-transactional writes (such as key-value writes or N1QL UPDATES) are never done concurrently with transactional writes, on the same document.</p>
</div>
<div class="paragraph">
<p>This requirement is to ensure that the strong Key-Value performance of Couchbase was not compromised.
A key philosophy of our transactions is that you 'pay only for what you use'.</p>
</div>
<div class="paragraph">
<p>If two such writes <strong>do</strong> conflict then the transactional write will 'win', overwriting the non-transactional write.</p>
</div>
<div class="paragraph">
<p>Note this only applies to <em>writes</em>.
Any non-transactional <em>reads</em> concurrent with transactions are fine, and are at a Read Committed level.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rollback"><a class="anchor" href="#rollback"></a>Rollback</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If an exception is thrown, either by the application from the lambda, or by the transactions library, then that attempt is rolled back.
The transaction logic may or may not be retried, depending on the exception.</p>
</div>
<div class="paragraph">
<p>If the transaction is not retried then it will throw a <code>transaction_failed</code> exception, and its <code>cause</code> method can be used for more details on the failure.
The application can use this to signal why it triggered a rollback.</p>
</div>
<div class="paragraph">
<p>The transaction can also be explicitly rolled back:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L302-L311">transactions.run([&amp;](couchbase::transactions::attempt_context&amp; ctx) {
    couchbase::transactions::transaction_get_result customer = ctx.get(collection, "customer-name");

    auto content = customer.content&lt;nlohmann::json&gt;();
    int balance = content["balance"].get&lt;int&gt;();
    if (balance &lt; cost_of_item) {
        ctx.rollback();
    }
    // else continue transaction
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, if <code>ctx.rollback()</code> is reached, then the transaction will be regarded as successfully rolled back and no TransactionFailed will be thrown.</p>
</div>
<div class="paragraph">
<p>After a transaction is rolled back, it cannot be committed, no further operations are allowed on it, and the library will not try to automatically commit it at the end of the code block.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>There are three exceptions that Couchbase transactions can return to the application: <code>transaction_failed</code>, <code>transaction_expired</code> and <code>transaction_commit_ambiguous</code>.
All exceptions derive from <code>transaction_exception</code> for backwards-compatibility purposes.</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L166-L168">couchbase::transactions::transaction_config configuration;
configuration.expiration_time(std::chrono::seconds(120));
couchbase::transactions::transactions transactions(cluster, configuration);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
<div class="paragraph">
<p>Unresolved include directive in modules/ROOT/pages/distributed-acid-transactions-from-the-sdk.adoc - include::7.0@sdk:shared:partial$acid-transactions.adoc[]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="logging"><a class="anchor" href="#logging"></a>Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To aid troubleshooting, the transactions library logs information to <code>stdout</code>.  The default logging level is <code>INFO</code>, but can
be changed to produce more or less detailed output.  For instance, to see very detailed logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++" data-source-url="file:///Users/mariashodunke/Couchbase/docs/docs-txn-cxx//modules/ROOT/examples/transactions-example.cxx#L142-L143">// Set logging level to Trace
couchbase::transactions::set_transactions_logging_level(log_level::TRACE);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>Further Reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>There&#8217;s plenty of explanation about how Transactions work in Couchbase in our <a href="#7.0@server:learn:data/transactions.adoc" class="xref unresolved">Transactions documentation</a>.</p>
</li>
<li>
<p>You can find further code examples on our <a href="https://github.com/couchbaselabs/couchbase-transactions-cxx-examples">transactions examples repository</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2022 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"SDKs","components":["dotnet-sdk","c-sdk","go-sdk","java-sdk","nodejs-sdk","php-sdk","python-sdk","ruby-sdk","scala-sdk","cxx-txns"],"url":"/home/sdk.html","latestVersions":{"dotnet-sdk":"3.3","c-sdk":"3.3","go-sdk":"2.5","java-sdk":"3.3","nodejs-sdk":"4.1","php-sdk":"4.0","python-sdk":"4.0","ruby-sdk":"3.3","scala-sdk":"1.3","cxx-txns":"DOC-9740"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../_/js/site.js"></script>
<script defer src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
</body>
</html>
